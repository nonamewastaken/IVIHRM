{% extends "base.html" %}

{% block title %}Personnel Overview - HRM System{% endblock %}

{% block page_title %}<i class="fas fa-chart-line"></i> Personnel Overview{% endblock %}

{% block extra_css %}
<style>
.overview-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.overview-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.overview-header h1 {
    margin: 0;
    font-size: 2.5rem;
    font-weight: 300;
}

.overview-header p {
    margin: 10px 0 0 0;
    font-size: 1.1rem;
    opacity: 0.9;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    text-align: center;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border-left: 4px solid #667eea;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
}

.stat-card .icon {
    font-size: 2.5rem;
    color: #667eea;
    margin-bottom: 15px;
}

.stat-card .number {
    font-size: 2rem;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 5px;
}

.stat-card .label {
    color: #7f8c8d;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.quick-actions {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
    margin-bottom: 30px;
}

.quick-actions h3 {
    margin: 0 0 20px 0;
    color: #2c3e50;
    font-size: 1.3rem;
}

.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.action-btn {
    display: flex;
    align-items: center;
    padding: 15px 20px;
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    text-decoration: none;
    color: #495057;
    transition: all 0.3s ease;
    font-weight: 500;
}

.action-btn:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
}

.action-btn i {
    margin-right: 10px;
    font-size: 1.2rem;
}

.recent-activity {
    background: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.08);
}

.recent-activity h3 {
    margin: 0 0 20px 0;
    color: #2c3e50;
    font-size: 1.3rem;
}

.activity-item {
    display: flex;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #f1f3f4;
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-item .icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    color: #667eea;
    font-size: 1.1rem;
}

.activity-item .content {
    flex: 1;
}

.activity-item .content h6 {
    margin: 0 0 5px 0;
    color: #2c3e50;
    font-size: 0.95rem;
}

.activity-item .content p {
    margin: 0;
    color: #7f8c8d;
    font-size: 0.85rem;
}

.activity-item .time {
    color: #95a5a6;
    font-size: 0.8rem;
    font-weight: 500;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #666;
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    border-radius: 5px;
    padding: 15px;
    margin: 20px 0;
    display: none;
}

.no-data {
    text-align: center;
    padding: 40px;
    color: #666;
}

.no-data i {
    font-size: 48px;
    color: #ddd;
    margin-bottom: 15px;
}
</style>
{% endblock %}

{% block content %}
    <div class="overview-container">
        <!-- Header Section -->
        <div class="overview-header">
            <h1><i class="fas fa-users"></i> Personnel Management</h1>
            <p>Comprehensive employee management and administrative tools</p>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="number" id="totalEmployees">0</div>
                <div class="label">Total Employees</div>
            </div>
            
            <div class="stat-card">
                <div class="icon">
                    <i class="fas fa-male"></i>
                </div>
                <div class="number" id="maleEmployees">0</div>
                <div class="label">Male Employees</div>
            </div>
            
            <div class="stat-card">
                <div class="icon">
                    <i class="fas fa-female"></i>
                </div>
                <div class="number" id="femaleEmployees">0</div>
                <div class="label">Female Employees</div>
            </div>
            
            <div class="stat-card">
                <div class="icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <div class="number" id="recentEmployees">0</div>
                <div class="label">Added This Month</div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
            <div class="actions-grid">
                <a href="/personnel/add" class="action-btn">
                    <i class="fas fa-user-plus"></i>
                    <span>Add New Employee</span>
                </a>
                <a href="/personnel/list" class="action-btn">
                    <i class="fas fa-list"></i>
                    <span>View All Employees</span>
                </a>
                <a href="/personnel/departments" class="action-btn">
                    <i class="fas fa-building"></i>
                    <span>Manage Departments</span>
                </a>
                <a href="/attendance/monthly_attendance_detail" class="action-btn">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Attendance Records</span>
                </a>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="recent-activity">
            <h3><i class="fas fa-clock"></i> Recent Employee Activity</h3>
            <div id="recentActivityList">
                <!-- Activity items will be loaded here -->
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading personnel data...</p>
        </div>

        <!-- Error Message -->
        <div id="errorMessage" class="error-message"></div>

        <!-- No Data State -->
        <div id="noDataState" class="no-data" style="display: none;">
            <i class="fas fa-users"></i>
            <h3>No Personnel Data</h3>
            <p>No employees have been added yet. Start by adding your first employee.</p>
            <a href="/personnel/add" class="action-btn" style="display: inline-flex; margin-top: 15px;">
                <i class="fas fa-user-plus"></i>
                <span>Add First Employee</span>
            </a>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
let personnelData = {};

document.addEventListener('DOMContentLoaded', function() {
    setActiveSidebarItem('/personnel');
    loadPersonnelData();
});

// Load personnel data from API
async function loadPersonnelData() {
    try {
        showLoading(true);
        hideError();
        
        const response = await fetch('/personnel/api/employees');
        const data = await response.json();
        
        if (data.success) {
            personnelData = data.employees;
            updateStatistics();
            updateRecentActivity();
            
            if (personnelData.length === 0) {
                showNoData();
            }
        } else {
            showError(`Failed to load personnel data: ${data.error}`);
        }
    } catch (error) {
        console.error('Error loading personnel data:', error);
        showError(`Failed to load personnel data: ${error.message}`);
    } finally {
        showLoading(false);
    }
}

// Update statistics cards
function updateStatistics() {
    const total = personnelData.length;
    const male = personnelData.filter(e => e.gender === 'male').length;
    const female = personnelData.filter(e => e.gender === 'female').length;
    const thisMonth = personnelData.filter(e => {
        const created = new Date(e.created_at);
        const now = new Date();
        return created.getMonth() === now.getMonth() && created.getFullYear() === now.getFullYear();
    }).length;
    
    document.getElementById('totalEmployees').textContent = total;
    document.getElementById('maleEmployees').textContent = male;
    document.getElementById('femaleEmployees').textContent = female;
    document.getElementById('recentEmployees').textContent = thisMonth;
}

// Update recent activity
function updateRecentActivity() {
    const activityList = document.getElementById('recentActivityList');
    
    if (personnelData.length === 0) {
        activityList.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No recent activity</p>';
        return;
    }
    
    // Sort by creation date and take the 5 most recent
    const recentEmployees = personnelData
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
        .slice(0, 5);
    
    activityList.innerHTML = recentEmployees.map(employee => `
        <div class="activity-item">
            <div class="icon">
                <i class="fas fa-user-plus"></i>
            </div>
            <div class="content">
                <h6>New Employee Added</h6>
                <p>${employee.full_name || 'Unknown'} - ${employee.personal_phone || 'No phone'}</p>
            </div>
            <div class="time">${formatTimeAgo(employee.created_at)}</div>
        </div>
    `).join('');
}

// Utility functions
function showLoading(show) {
    document.getElementById('loadingState').style.display = show ? 'block' : 'none';
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function hideError() {
    document.getElementById('errorMessage').style.display = 'none';
}

function showNoData() {
    document.getElementById('noDataState').style.display = 'block';
}

function formatTimeAgo(dateString) {
    const now = new Date();
    const date = new Date(dateString);
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) {
        return 'Just now';
    } else if (diffInSeconds < 3600) {
        const minutes = Math.floor(diffInSeconds / 60);
        return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    } else if (diffInSeconds < 2592000) {
        const days = Math.floor(diffInSeconds / 86400);
        return `${days} day${days > 1 ? 's' : ''} ago`;
    } else {
        return date.toLocaleDateString('en-US');
    }
}

// Personnel overview specific functionality
// Note: Sidebar initialization is handled by the main sidebar component
</script>
{% endblock %}
