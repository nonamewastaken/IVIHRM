{% extends "base.html" %}

{% block title %}Divisions - HRM System{% endblock %}

{% block page_title %}<i class="fas fa-network-wired"></i> Divisions{% endblock %}

{% block extra_css %}
<style>
    .unit-wrapper {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .actions-bar {
        display: flex;
        justify-content: flex-end;
    }

    .unit-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.1);
        overflow: hidden;
    }

    .unit-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
    }

    .unit-title {
        display: flex;
        flex-direction: column;
        cursor: pointer;
    }

    .unit-title strong {
        font-size: 1.05rem;
    }

    .unit-title span {
        color: #6b7280;
        font-size: 0.85rem;
    }

    .unit-actions {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .pill {
        background: #e0e7ff;
        color: #1e3a8a;
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 999px;
        font-weight: 600;
    }

    .unit-chevron {
        color: #4c6ef5;
        transition: transform 0.2s ease;
        cursor: pointer;
    }

    .secondary-button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        border-radius: 10px;
        background: #f3f4ff;
        color: #4c6ef5;
        font-weight: 600;
        border: none;
        cursor: pointer;
    }

    .unit-details {
        padding: 0 20px 20px;
        display: none;
        border-top: 1px solid #e5e7eb;
    }

    .unit-details.open {
        display: block;
    }

    .division-focus {
        color: #4b5563;
        margin-top: 18px;
        margin-bottom: 12px;
    }

    .department-list {
        list-style: none;
        margin: 16px 0 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .department-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-radius: 12px;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
    }

    .department-name {
        font-weight: 600;
        color: #1f2937;
    }

    .department-meta {
        display: flex;
        gap: 12px;
        color: #64748b;
        font-size: 0.85rem;
    }

    .department-list .empty {
        justify-content: center;
        color: #94a3b8;
        font-style: italic;
    }

    .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.55);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal {
        background: white;
        border-radius: 18px;
        padding: 24px;
        width: 460px;
        max-width: 90%;
        box-shadow: 0 18px 40px rgba(15, 23, 42, 0.25);
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .modal header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .close-button {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: #6b7280;
    }

    .modal form {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .modal input,
    .modal textarea,
    .modal select {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid #d1d5db;
        font-size: 0.95rem;
    }

    .modal textarea {
        min-height: 80px;
        resize: vertical;
    }

    .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .ghost-button {
        padding: 10px 16px;
        border-radius: 12px;
        border: 1px solid #d1d5db;
        background: white;
        cursor: pointer;
        font-weight: 600;
    }

    .primary-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        border-radius: 12px;
        background: #4c6ef5;
        color: white;
        text-decoration: none;
        font-weight: 600;
        border: none;
        cursor: pointer;
    }

    .primary-button:focus-visible,
    .secondary-button:focus-visible,
    .pill:focus-visible {
        outline: 3px solid rgba(76, 110, 245, 0.35);
        outline-offset: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="unit-wrapper">
    <div class="actions-bar">
        <button class="primary-button" id="addDivisionBtn"><i class="fas fa-plus"></i> Add Division</button>
    </div>
    {% for division in divisions %}
    <div class="unit-card" data-division-index="{{ loop.index0 }}">
        <div class="unit-header">
            <div class="unit-title" data-division="{{ loop.index0 }}">
                <strong>{{ division.name }}</strong>
                <span>
                    Belongs to {{ division.company }} · Head: {{ division.leader }}
                </span>
                <span style="margin-top:6px;">
                    <span class="pill" data-division-count="{{ loop.index0 }}">{{ division.departments|length }} department{{ division.departments|length == 1 and '' or 's' }}</span>
                </span>
            </div>
            <div class="unit-actions">
                <div class="pill" data-expansion-label="{{ loop.index0 }}">Show Departments</div>
                <i class="fas fa-chevron-down unit-chevron" data-division="{{ loop.index0 }}"></i>
            </div>
        </div>
        <div class="unit-details" id="division-body-{{ loop.index0 }}">
            <p class="division-focus">Focus: {{ division.focus }}</p>
            <ul class="department-list">
                {% for department in division.departments %}
                <li class="department-item">
                    <div class="department-name">{{ department.name }}</div>
                    <div class="department-meta">
                        <span>{{ department.head }}</span>
                        <span>{{ department.members }} member{{ department.members == 1 and '' or 's' }}</span>
                    </div>
                </li>
                {% endfor %}
                {% if division.departments|length == 0 %}
                <li class="department-item empty">No departments assigned.</li>
                {% endif %}
            </ul>
        </div>
    </div>
    {% endfor %}
</div>

<div class="modal-backdrop" id="divisionModal">
    <div class="modal">
        <header>
            <h3>Add Division</h3>
            <button class="close-button" data-close>&times;</button>
        </header>
        <form id="divisionForm">
            <input type="text" name="division_name" placeholder="Division name">
            <input type="text" name="division_head" placeholder="Head of division">
            <select name="division_company">
                {% for company in companies %}
                <option>{{ company }}</option>
                {% endfor %}
            </select>
            <textarea name="division_focus" placeholder="Focus / description"></textarea>
        </form>
        <div class="modal-actions">
            <button class="ghost-button" data-close>Cancel</button>
            <button class="primary-button" id="saveDivisionBtn"><i class="fas fa-save"></i> Save</button>
        </div>
    </div>
</div>

<div class="modal-backdrop" id="detailModal">
    <div class="modal">
        <header>
            <h3 id="detailTitle">Division Detail</h3>
            <button class="close-button" data-close>&times;</button>
        </header>
        <p><strong>Head:</strong> <span id="detailHead"></span></p>
        <p><strong>Company:</strong> <span id="detailCompany"></span></p>
        <p><strong>Departments:</strong> <span id="detailDepartmentCount"></span></p>
        <p><strong>Focus:</strong></p>
        <p id="detailFocus" style="color:#4b5563;"></p>
        <div>
            <p><strong>Departments Included:</strong></p>
            <ul id="detailDepartmentList" style="margin:0; padding-left:18px; color:#4b5563;">
            </ul>
        </div>
        <div class="modal-actions">
            <button class="primary-button" id="addDivisionDepartmentBtn" type="button"><i class="fas fa-plus"></i> Add Department</button>
            <button class="primary-button" data-close type="button"><i class="fas fa-check"></i> Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script id="org-structure-data" type="application/json">{{ structure | tojson | safe }}</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    setActiveSidebarItem('/personnel/divisions');

    const STORAGE_KEY = 'hrm_org_structure_v1';
    const dataNode = document.getElementById('org-structure-data');
    const initialStructure = dataNode ? JSON.parse(dataNode.textContent) : { divisions: [] };
    if (dataNode) {
        dataNode.remove();
    }
    const addDivisionBtn = document.getElementById('addDivisionBtn');
    const divisionModal = document.getElementById('divisionModal');
    const divisionForm = document.getElementById('divisionForm');
    const detailModal = document.getElementById('detailModal');
    const detailList = document.getElementById('detailDepartmentList');
    const detailCount = document.getElementById('detailDepartmentCount');
    const addDivisionDepartmentBtn = document.getElementById('addDivisionDepartmentBtn');
    const wrapper = document.querySelector('.unit-wrapper');

    function cloneInitial(data) {
        return JSON.parse(JSON.stringify(data));
    }

    function loadStructure() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            try {
                return JSON.parse(stored);
            } catch (error) {
                console.warn('Invalid stored organization structure, resetting.', error);
            }
        }
        const fresh = cloneInitial(initialStructure);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(fresh));
        return fresh;
    }

    let structure = loadStructure();
    let divisionsData = structure.divisions;

    function saveStructure() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(structure));
    }

    function openModal(modal) {
        modal.style.display = 'flex';
    }

    function closeModal(modal) {
        modal.style.display = 'none';
    }

    function toggleDivision(index) {
        const card = wrapper.querySelector(`.unit-card[data-division-index="${index}"]`);
        if (!card) return;
        const body = card.querySelector('.unit-details');
        const icon = card.querySelector('.unit-chevron');
        const label = card.querySelector('[data-expansion-label]');
        if (!body || !icon || !label) return;
        const open = body.classList.toggle('open');
        icon.style.transform = open ? 'rotate(180deg)' : 'rotate(0deg)';
        label.textContent = open ? 'Hide Departments' : 'Show Departments';
    }

    function refreshDetailModal(division) {
        if (!division) return;
        document.getElementById('detailTitle').textContent = division.name;
        document.getElementById('detailHead').textContent = division.leader || 'Unassigned';
        document.getElementById('detailCompany').textContent = division.company || 'N/A';
        document.getElementById('detailFocus').textContent = division.focus || 'Focus pending definition.';
        detailCount.textContent = `${division.departments.length} department${division.departments.length === 1 ? '' : 's'}`;
        detailList.innerHTML = '';

        if (division.departments.length === 0) {
            const li = document.createElement('li');
            li.textContent = 'No departments assigned.';
            detailList.appendChild(li);
            return;
        }

        division.departments.forEach(dept => {
            const headLabel = dept.leader || dept.head || 'Unassigned';
            const memberCount = typeof dept.members === 'number' ? dept.members : (dept.team ? dept.team.length : 0);
            const li = document.createElement('li');
            li.innerHTML = `<strong>${dept.name}</strong> — ${headLabel} · ${memberCount} member${memberCount === 1 ? '' : 's'}`;
            detailList.appendChild(li);
        });
    }

    function updateDivisionUI(index) {
        const division = divisionsData[index];
        const card = wrapper.querySelector(`.unit-card[data-division-index="${index}"]`);
        if (!division || !card) return;

        const list = card.querySelector('.department-list');
        if (!list) return;
        list.innerHTML = '';

        if (division.departments.length === 0) {
            const empty = document.createElement('li');
            empty.className = 'department-item empty';
            empty.textContent = 'No departments assigned.';
            list.appendChild(empty);
        } else {
            division.departments.forEach(dept => {
                const headLabel = dept.leader || dept.head || 'Unassigned';
                const memberCount = typeof dept.members === 'number' ? dept.members : (dept.team ? dept.team.length : 0);
                const li = document.createElement('li');
                li.className = 'department-item';
                li.innerHTML = `
                    <div class="department-name">${dept.name}</div>
                    <div class="department-meta">
                        <span>${headLabel}</span>
                        <span>${memberCount} member${memberCount === 1 ? '' : 's'}</span>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        const countPill = card.querySelector('.pill[data-division-count]');
        if (countPill) {
            countPill.textContent = `${division.departments.length} department${division.departments.length === 1 ? '' : 's'}`;
        }
    }

    function attachDivisionHandlers(card, index) {
        const title = card.querySelector('.unit-title');
        const chevron = card.querySelector('.unit-chevron');
        const label = card.querySelector('[data-expansion-label]');
        const viewButton = card.querySelector('.view-division-btn');

        if (title) {
            title.addEventListener('click', () => toggleDivision(index));
        }
        if (chevron) {
            chevron.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleDivision(index);
            });
        }
        if (label) {
            label.addEventListener('click', (event) => {
                event.stopPropagation();
                toggleDivision(index);
            });
        }
        if (viewButton) {
            viewButton.addEventListener('click', (event) => {
                event.stopPropagation();
                refreshDetailModal(divisionsData[index]);
                detailModal.dataset.activeIndex = String(index);
                openModal(detailModal);
            });
        }
    }

    function createDivisionCard(division, index) {
        const card = document.createElement('div');
        card.className = 'unit-card';
        card.dataset.divisionIndex = index;
        card.innerHTML = `
            <div class="unit-header">
                <div class="unit-title">
                    <strong>${division.name}</strong>
                    <span>Belongs to ${division.company} · Head: ${division.leader || 'Unassigned'}</span>
                    <span style="margin-top:6px;">
                        <span class="pill" data-division-count>${division.departments.length} department${division.departments.length === 1 ? '' : 's'}</span>
                    </span>
                </div>
                <div class="unit-actions">
                    <button class="secondary-button view-division-btn" type="button">
                        <i class="fas fa-eye"></i> View Detail
                    </button>
                    <div class="pill" data-expansion-label>Show Departments</div>
                    <i class="fas fa-chevron-down unit-chevron"></i>
                </div>
            </div>
            <div class="unit-details">
                <p class="division-focus">Focus: ${division.focus || 'Focus pending definition.'}</p>
                <ul class="department-list"></ul>
            </div>
        `;
        wrapper.appendChild(card);
        attachDivisionHandlers(card, index);
        updateDivisionUI(index);
    }

    function renderDivisions() {
        wrapper.querySelectorAll('.unit-card').forEach(card => card.remove());
        divisionsData.forEach((division, index) => createDivisionCard(division, index));
    }

    renderDivisions();

    addDivisionBtn.addEventListener('click', () => {
        divisionForm.reset();
        openModal(divisionModal);
    });

    document.querySelectorAll('[data-close]').forEach(btn => {
        btn.addEventListener('click', () => {
            closeModal(divisionModal);
            closeModal(detailModal);
        });
    });

    [divisionModal, detailModal].forEach(modal => {
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                closeModal(modal);
            }
        });
    });

    document.getElementById('saveDivisionBtn').addEventListener('click', () => {
        const formData = new FormData(divisionForm);
        const divisionName = (formData.get('division_name') || '').toString().trim();
        const divisionHead = (formData.get('division_head') || '').toString().trim() || 'Unassigned';
        const divisionCompany = (formData.get('division_company') || '').toString().trim() || 'Unknown Company';
        const divisionFocus = (formData.get('division_focus') || '').toString().trim() || 'Focus pending definition.';

        if (!divisionName) {
            alert('Please enter a division name.');
            return;
        }

        const newDivision = {
            name: divisionName,
            leader: divisionHead,
            company: divisionCompany,
            focus: divisionFocus,
            departments: []
        };

        divisionsData.push(newDivision);
        saveStructure();
        renderDivisions();
        closeModal(divisionModal);
        alert('Division saved (demo only).');
    });

    addDivisionDepartmentBtn.addEventListener('click', () => {
        const activeIndex = parseInt(detailModal.dataset.activeIndex || '-1', 10);
        if (Number.isNaN(activeIndex) || activeIndex < 0 || !divisionsData[activeIndex]) {
            return;
        }

        const division = divisionsData[activeIndex];
        const departmentName = prompt('Enter department name:');
        if (!departmentName) return;
        const departmentHead = prompt('Enter department head (optional):') || 'Unassigned';
        const memberCount = parseInt(prompt('Enter member count (optional):') || '0', 10);
        const departmentFocus = prompt('Describe this department’s focus (optional):') || 'Focus pending definition.';

        const newDepartment = {
            name: departmentName.trim(),
            leader: departmentHead.trim() || 'Unassigned',
            company: division.company,
            division: division.name,
            focus: departmentFocus.trim(),
            members: Number.isNaN(memberCount) ? 0 : memberCount,
            team: [],
            sub_departments: []
        };

        division.departments.push(newDepartment);
        saveStructure();
        renderDivisions();
        refreshDetailModal(division);
        detailModal.dataset.activeIndex = String(activeIndex);
        openModal(detailModal);
    });
});
</script>
{% endblock %}

