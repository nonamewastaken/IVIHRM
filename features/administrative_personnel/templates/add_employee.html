{% extends "base.html" %}

{% block title %}{{ 'Edit Employee' if mode == 'edit' else 'Add Employee' }} - HRM System{% endblock %}

{% block page_title %}
    <i class="fas {{ 'fa-user-edit' if mode == 'edit' else 'fa-user-plus' }}"></i>
    {{ 'Edit Employee' if mode == 'edit' else 'Add Employee' }}
{% endblock %}

{% block extra_css %}
<style>
    .personnel-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .personnel-card {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .form-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #fafafa;
    }

    .section-header {
        background: #f5f5f5;
        padding: 10px 15px;
        margin: -20px -20px 20px -20px;
        border-radius: 8px 8px 0 0;
        font-weight: bold;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        flex: 1;
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }

    .form-group label.required::after {
        content: " (*)";
        color: #e74c3c;
        font-weight: bold;
    }

    .form-control.error {
        border-color: #e74c3c;
        box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.25);
    }

    .error-message {
        color: #e74c3c;
        font-size: 12px;
        margin-top: 5px;
        display: none;
    }

    .form-group.error .error-message {
        display: block;
    }

    .validation-summary {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        display: none;
    }

    .validation-summary.show {
        display: block;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }

    .radio-group {
        display: flex;
        gap: 20px;
        margin-top: 5px;
    }

    .radio-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .radio-item input[type="radio"] {
        margin: 0;
    }

    .upload-section {
        text-align: center;
        padding: 30px;
        border: 2px dashed #ddd;
        border-radius: 8px;
        background: #f9f9f9;
    }

    .upload-preview {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #ddd;
        margin: 15px auto;
        display: block;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #4c6ef5;
        color: #ffffff;
        box-shadow: none;
    }

    .btn-primary:hover {
        background: #384ddf;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-success:hover {
        background: #1e7e34;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    .btn-upload {
        background: #28a745;
        color: #ffffff;
        padding: 10px 16px;
        font-size: 14px;
        border-radius: 10px;
        font-weight: 600;
        margin-top: 12px;
    }

    .btn-upload:hover {
        background: #1e7e34;
    }

    .btn-evaluate {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-evaluate:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        background: linear-gradient(135deg, #5568d3 0%, #6a3fa0 100%);
    }

    .btn-evaluate:active {
        transform: translateY(0);
    }

    .btn-evaluate:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .btn-evaluate i {
        font-size: 16px;
    }

    .hidden {
        display: none;
    }

    .form-actions {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e0e0e0;
    }

    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
    }

    .step {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        background: #f8f9fa;
        border-radius: 25px;
        margin: 0 10px;
    }

    .step.active {
        background: #007bff;
        color: white;
    }

    .step.completed {
        background: #28a745;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
    <div class="personnel-container">
        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step" id="step1">
                <i class="fas fa-upload"></i>
                <span>Upload CV</span>
            </div>
            <div class="step" id="step2">
                <i class="fas fa-user"></i>
                <span>Personal Info</span>
            </div>
        </div>

        <!-- Step 1: CV Upload -->
        <div class="personnel-card" id="cvUploadStep">
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">
                <i class="fas fa-upload"></i> Upload CV (Image or PDF)
            </h2>
            
            <div class="upload-section">
                <div id="uploadArea">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                    <h4>Upload CV (Image or PDF)</h4>
                    <p>You can upload a CV file (image or PDF) or skip this step â€” Max 10 files, 100MB each</p>
                    <input type="file" id="cvFileInput" accept="image/*,.pdf,application/pdf" style="display: none;">
                    <button class="btn btn-upload" onclick="document.getElementById('cvFileInput').click()">
                        <i class="fas fa-upload"></i> Upload
                    </button>
                </div>
                
                <div id="previewArea" class="hidden">
                    <img id="cvPreview" class="upload-preview" src="" alt="CV Preview">
                    <p id="cvPreviewLabel">CV Uploaded</p>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="removeCV()">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                        <button class="btn-evaluate" id="evaluateCvBtn" onclick="evaluateCV()">
                            <i class="fas fa-brain"></i> Evaluate CV for Development
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- CV Evaluation Results -->
            <div id="evaluationResults" class="hidden" style="margin-top: 20px;">
                <div class="personnel-card" style="background: #f8f9fa; border-left: 4px solid #667eea;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">
                        <i class="fas fa-chart-line"></i> CV Evaluation Results
                    </h3>
                    <div id="evaluationContent">
                        <!-- Evaluation results will be displayed here -->
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-secondary" style="margin-right: 10px;" onclick="goBackToAddModeSelection()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button id="resetSessionBtn" class="btn btn-secondary hidden" style="margin-right: 10px;" onclick="resetCvSession()">
                    <i class="fas fa-undo"></i> Reset
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    <i class="fas fa-arrow-right"></i> Continue
                </button>
            </div>
        </div>

        <!-- Step 2: Personal Information Form -->
        <div class="personnel-card hidden" id="personalInfoStep">
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">
                <i class="fas fa-user"></i> Personal Information
            </h2>
            
            <form id="personalInfoForm">
                <!-- Validation Summary -->
                <div id="validationSummary" class="validation-summary">
                    <strong><i class="fas fa-exclamation-triangle"></i> Please fill in all required fields:</strong>
                    <ul id="validationErrors"></ul>
                </div>
                
                <!-- Personal Information Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-user"></i>
                        <span>PERSONAL INFORMATION</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Portrait Photo</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button type="button" class="btn btn-upload" onclick="document.getElementById('portraitFileInput').click()">
                                    <i class="fas fa-upload"></i> Upload
                                </button>
                                <input type="file" id="portraitFileInput" accept="image/*" style="display: none;">
                                <div id="portraitPreview" style="width: 60px; height: 60px; border-radius: 50%; background: #f0f0f0; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user" style="color: #999;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Full Name</label>
                            <input type="text" class="form-control" name="full_name" placeholder="Full name">
                            <div class="error-message">Please enter full name</div>
                        </div>
                        <div class="form-group">
                            <label class="required">Gender</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" name="gender" value="male" id="gender_male">
                                    <label for="gender_male">Male</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" name="gender" value="female" id="gender_female">
                                    <label for="gender_female">Female</label>
                                </div>
                            </div>
                            <div class="error-message">Please select gender</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Date of Birth</label>
                            <input type="text" class="form-control" name="date_of_birth" placeholder="dd/mm/yyyy">
                            <div class="error-message">Please enter date of birth</div>
                        </div>
                        <div class="form-group">
                            <label class="required">Place of Birth</label>
                            <input type="text" class="form-control" name="place_of_birth" placeholder="Enter place of birth">
                            <div class="error-message">Please enter place of birth</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Hometown</label>
                            <input type="text" class="form-control" name="hometown" placeholder="Enter hometown">
                            <div class="error-message">Please enter hometown</div>
                        </div>
                        <div class="form-group">
                            <label>Marital Status</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" name="marital_status" value="single" id="marital_single">
                                    <label for="marital_single">Single</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" name="marital_status" value="married" id="marital_married">
                                    <label for="marital_married">Married</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" name="marital_status" value="other" id="marital_other">
                                    <label for="marital_other">Other</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ethnicity</label>
                            <input type="text" class="form-control" name="ethnicity" placeholder="Enter ethnicity">
                        </div>
                        <div class="form-group">
                            <label>Religion</label>
                            <input type="text" class="form-control" name="religion" placeholder="Enter religion">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Personal Tax Code</label>
                            <input type="text" class="form-control" name="personal_tax_code" placeholder="Enter personal tax code">
                        </div>
                        <div class="form-group">
                            <label>Social Insurance Code</label>
                            <input type="text" class="form-control" name="social_insurance_code" placeholder="Enter social insurance code">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Personal Phone Number</label>
                            <input type="tel" class="form-control" name="personal_phone" placeholder="Enter personal phone number">
                            <div class="error-message">Please enter personal phone number</div>
                        </div>
                        <div class="form-group">
                            <label class="required">Personal Email</label>
                            <input type="email" class="form-control" name="personal_email" placeholder="Enter personal email">
                            <div class="error-message">Please enter personal email</div>
                        </div>
                    </div>
                    
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Party Join Date</label>
                            <input type="text" class="form-control" name="party_join_date" placeholder="dd/mm/yyyy">
                        </div>
                        <div class="form-group">
                            <label>Party Join Place</label>
                            <input type="text" class="form-control" name="party_join_place" placeholder="Enter party join place">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Health Status</label>
                            <select class="form-control" name="health_status">
                                <option value="">Select health status</option>
                                <option value="excellent">Excellent</option>
                                <option value="good">Good</option>
                                <option value="fair">Fair</option>
                                <option value="poor">Poor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Health Certificate</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button type="button" class="btn btn-upload" onclick="document.getElementById('healthFileInput').click()">
                                    <i class="fas fa-upload"></i> Upload
                                </button>
                                <input type="file" id="healthFileInput" accept="image/*" style="display: none;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Emergency Contact (name + phone)</label>
                            <input type="text" class="form-control" name="emergency_contact" placeholder="Name and phone number for emergency contact">
                        </div>
                    </div>
                </div>

                <!-- Address Information Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-home"></i>
                        <span>PERMANENT RESIDENCE & CURRENT ADDRESS</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label><strong>Permanent residence e.g., "144 Nghia Do Ward, Hanoi City"</strong></label>
                            <textarea class="form-control" name="permanent_address" rows="3" placeholder="Enter permanent address"></textarea>
                        </div>
                        <div class="form-group">
                            <label><strong>Current address e.g., "144 Nghia Do Ward, Hanoi City"</strong></label>
                            <textarea class="form-control" name="current_address" rows="3" placeholder="Enter current address"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Province/City</label>
                            <select class="form-control" name="permanent_province">
                                <option value="">Select Province/City</option>
                                <option value="hanoi">Hanoi</option>
                                <option value="hcm">Ho Chi Minh City</option>
                                <option value="danang">Da Nang</option>
                                <option value="haiphong">Hai Phong</option>
                                <option value="cantho">Can Tho</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Province/City</label>
                            <select class="form-control" name="current_province">
                                <option value="">Select Province/City</option>
                                <option value="hanoi">Hanoi</option>
                                <option value="hcm">Ho Chi Minh City</option>
                                <option value="danang">Da Nang</option>
                                <option value="haiphong">Hai Phong</option>
                                <option value="cantho">Can Tho</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ward/District/Town</label>
                            <select class="form-control" name="permanent_ward">
                                <option value="">Select Ward/District/Town</option>
                                <option value="nghia_do">Nghia Do</option>
                                <option value="cau_giay">Cau Giay</option>
                                <option value="dong_da">Dong Da</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ward/District/Town</label>
                            <select class="form-control" name="current_ward">
                                <option value="">Select Ward/District/Town</option>
                                <option value="nghia_do">Nghia Do</option>
                                <option value="cau_giay">Cau Giay</option>
                                <option value="dong_da">Dong Da</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>House number, street/hamlet</label>
                            <input type="text" class="form-control" name="permanent_street" placeholder="Enter house number, street/hamlet">
                        </div>
                        <div class="form-group">
                            <label>House number, street/hamlet</label>
                            <input type="text" class="form-control" name="current_street" placeholder="Enter house number, street/hamlet">
                        </div>
                    </div>
                </div>

                <!-- ID Card & Passport Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-id-card"></i>
                        <span>ID CARD & PASSPORT</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required"><strong>ID Card Number</strong></label>
                            <input type="text" class="form-control" name="id_card_number" placeholder="Enter ID card number">
                            <div class="error-message">Please enter ID card number</div>
                        </div>
                        <div class="form-group">
                            <label><strong>Passport Number</strong></label>
                            <input type="text" class="form-control" name="passport_number" placeholder="Enter passport number">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Issue Date</label>
                            <input type="text" class="form-control" name="id_card_issue_date" placeholder="dd/mm/yyyy">
                            <div class="error-message">Please enter ID card issue date</div>
                        </div>
                        <div class="form-group">
                            <label>Issue Date</label>
                            <input type="text" class="form-control" name="passport_issue_date" placeholder="dd/mm/yyyy">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Expiry Date</label>
                            <input type="text" class="form-control" name="id_card_expiry_date" placeholder="dd/mm/yyyy">
                        </div>
                        <div class="form-group">
                            <label>Expiry Date</label>
                            <input type="text" class="form-control" name="passport_expiry_date" placeholder="dd/mm/yyyy">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Issue Place</label>
                            <input type="text" class="form-control" name="id_card_issue_place" placeholder="Enter ID card issue place">
                            <div class="error-message">Please enter ID card issue place</div>
                        </div>
                        <div class="form-group">
                            <label>Issue Place</label>
                            <input type="text" class="form-control" name="passport_issue_place" placeholder="Enter passport issue place">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Attach (both sides)</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button type="button" class="btn btn-upload" onclick="document.getElementById('idCardFileInput').click()">
                                    <i class="fas fa-upload"></i> Upload
                                </button>
                                <input type="file" id="idCardFileInput" accept="image/*" style="display: none;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Attach (both sides)</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button type="button" class="btn btn-upload" onclick="document.getElementById('passportFileInput').click()">
                                    <i class="fas fa-upload"></i> Upload
                                </button>
                                <input type="file" id="passportFileInput" accept="image/*" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button type="submit" class="btn btn-success" onclick="handleFormSubmission(); return false;">
                        <i class="fas fa-check"></i> Finish
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script type="application/json" id="initialEmployeeData">
{{ employee_data|default({})|tojson }}
</script>
<script>
const PAGE_MODE = "{{ mode|default('add') }}";
const IS_EDIT_MODE = PAGE_MODE === 'edit';
const EMPLOYEE_ID = "{{ employee_id if employee_id is not none else '' }}";
const initialEmployeeDataScript = document.getElementById('initialEmployeeData');
const INITIAL_EMPLOYEE_DATA = initialEmployeeDataScript ? JSON.parse(initialEmployeeDataScript.textContent || '{}') : {};

let currentStep = 1;
let cvFile = null;
let portraitFile = null;
let healthFile = null;
let idCardFile = null;
let passportFile = null;

document.addEventListener('DOMContentLoaded', function() {
    const activeNavHref = IS_EDIT_MODE ? '/personnel/list' : '/personnel/add';
    setActiveSidebarItem(activeNavHref);
    // Sidebar is handled by main sidebar component

    if (IS_EDIT_MODE) {
        initializeEditMode();
    }
    
    // CV Upload functionality
    document.getElementById('cvFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            cvFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                const uploadArea = document.getElementById('uploadArea');
                const previewArea = document.getElementById('previewArea');
                const previewImg = document.getElementById('cvPreview');
                const previewLabel = document.getElementById('cvPreviewLabel');

                if (file.type === 'application/pdf' || file.name.toLowerCase().endswith('.pdf')) {
                    // For PDF, don't try to render in <img>; just show an icon/label
                    previewImg.src = '';
                    previewImg.style.display = 'none';
                    previewLabel.textContent = `CV PDF Uploaded: ${file.name}`;
                } else {
                    previewImg.style.display = 'block';
                    previewImg.src = e.target.result;
                    previewLabel.textContent = 'CV Image Uploaded';
                }

                uploadArea.classList.add('hidden');
                previewArea.classList.remove('hidden');
                const resetBtn = document.getElementById('resetSessionBtn');
                if (resetBtn) resetBtn.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Portrait upload functionality
    document.getElementById('portraitFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            portraitFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                updatePortraitPreview(e.target.result);
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Health file upload functionality
    document.getElementById('healthFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            healthFile = file;
        }
    });
    
    // ID Card file upload functionality
    document.getElementById('idCardFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            idCardFile = file;
        }
    });
    
    // Passport file upload functionality
    document.getElementById('passportFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            passportFile = file;
        }
    });
    
    // Form submission using event delegation
    document.addEventListener('submit', function(e) {
        if (e.target.id === 'personalInfoForm') {
            e.preventDefault();
            console.log('Form submit event triggered');
            handleFormSubmission();
        }
    });
    
    // Also add click event listener to the submit button as backup
    document.addEventListener('click', function(e) {
        console.log('Click detected on:', e.target);
        if (e.target.closest('button[type="submit"]') && e.target.closest('#personalInfoForm')) {
            e.preventDefault();
            console.log('Submit button clicked - calling handleFormSubmission()');
            handleFormSubmission();
        }
    });
    
    // Function to handle form submission
    function handleFormSubmission() {
        console.log('handleFormSubmission() called');
        
        // Clear previous validation
        clearValidation();
        
        // Validate form
        const isValid = validateForm();
        console.log('Form validation result:', isValid);
        
        if (isValid) {
            console.log('Form is valid, calling submitEmployeeData()');
            submitEmployeeData();
        } else {
            console.log('Form is invalid, showing validation summary');
            showValidationSummary();
        }
    }
});

function initializeEditMode() {
    console.log('initializeEditMode() called');

    currentStep = 2;
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const cvStep = document.getElementById('cvUploadStep');
    const personalStep = document.getElementById('personalInfoStep');

    if (step1 && step2 && cvStep && personalStep) {
        step1.classList.remove('active');
        step1.classList.add('completed');
        step2.classList.add('active');
        cvStep.classList.add('hidden');
        personalStep.classList.remove('hidden');
    }

    populateFormWithEmployeeData(INITIAL_EMPLOYEE_DATA || {});

    if (INITIAL_EMPLOYEE_DATA && INITIAL_EMPLOYEE_DATA.portrait_file) {
        updatePortraitPreview(INITIAL_EMPLOYEE_DATA.portrait_file);
    }
}

function populateFormWithEmployeeData(data) {
    if (!data) {
        return;
    }

    const form = document.getElementById('personalInfoForm');
    Object.entries(data).forEach(([key, rawValue]) => {
        let value = rawValue;
        if (value === null || typeof value === 'undefined') {
            value = '';
        }

        const elements = form.querySelectorAll(`[name="${key}"]`);
        if (!elements.length) {
            return;
        }

        elements.forEach(element => {
            if (element.type === 'radio') {
                element.checked = element.value === value;
            } else if (element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') {
                element.value = value;
            } else if (element.type === 'checkbox') {
                element.checked = value === true || value === 'true';
            } else {
                element.value = value;
            }
        });
    });
}

function updatePortraitPreview(source) {
    const preview = document.getElementById('portraitPreview');
    if (!preview) {
        return;
    }

    if (source) {
        preview.innerHTML = `<img src="${source}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
    } else {
        preview.innerHTML = '<i class="fas fa-user" style="color: #999;"></i>';
    }
}

function nextStep() {
    console.log('nextStep() called');
    currentStep = 2;
    document.getElementById('step1').classList.remove('active');
    document.getElementById('step1').classList.add('completed');
    document.getElementById('step2').classList.add('active');
    
    document.getElementById('cvUploadStep').classList.add('hidden');
    document.getElementById('personalInfoStep').classList.remove('hidden');
    
    console.log('Form should now be visible');
    console.log('Form element:', document.getElementById('personalInfoForm'));

    // If a CV was uploaded, call backend to extract fields with Gemini and prefill
    if (cvFile) {
        showMessage('Reading CV to prefill your info...', 'info');
        fileToBase64(cvFile)
            .then(b64 => fetch('/personnel/api/extract-cv', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: [b64] })
            }))
            .then(res => res.json())
            .then(result => {
                if (result && result.success && result.data) {
                    prefillFromExtractedData(result.data);
                    showMessage('CV parsed. Fields were prefilled when available.', 'success');
                } else {
                    const detail = result && result.error ? ` (${result.error})` : '';
                    showMessage(`Could not extract info from the CV.${detail}`, 'error');
                }
            })
            .catch(err => {
                console.error('CV extraction error:', err);
                showMessage('Error reading CV.', 'error');
            });
    }
}

function prevStep() {
    currentStep = 1;
    document.getElementById('step2').classList.remove('active');
    document.getElementById('step1').classList.remove('completed');
    document.getElementById('step1').classList.add('active');
    
    document.getElementById('personalInfoStep').classList.add('hidden');
    document.getElementById('cvUploadStep').classList.remove('hidden');
}

function removeCV() {
    cvFile = null;
    document.getElementById('cvFileInput').value = '';
    document.getElementById('uploadArea').classList.remove('hidden');
    document.getElementById('previewArea').classList.add('hidden');
    const resetBtn = document.getElementById('resetSessionBtn');
    if (resetBtn) resetBtn.classList.add('hidden');
}

function goBackToAddModeSelection() {
    // Navigate back to the Single/Multiple selection page
    window.location.href = '/personnel/add';
}

function resetCvSession() {
    // Start a new session effect: clear any staged files and reload the step to initial state
    cvFile = null;
    portraitFile = null;
    healthFile = null;
    idCardFile = null;
    passportFile = null;
    document.getElementById('cvFileInput').value = '';
    document.getElementById('cvPreview').src = '';
    document.getElementById('uploadArea').classList.remove('hidden');
    document.getElementById('previewArea').classList.add('hidden');
    const resetBtn = document.getElementById('resetSessionBtn');
    if (resetBtn) resetBtn.classList.add('hidden');
    showMessage('Session reset. No CV on file.', 'info');
}

// Validation functions
function validateForm() {
    console.log('validateForm() called');
    let isValid = true;
    const requiredFields = [
        { name: 'full_name', message: 'Full name' },
        { name: 'gender', message: 'Gender' },
        { name: 'date_of_birth', message: 'Date of birth' },
        { name: 'place_of_birth', message: 'Place of birth' },
        { name: 'hometown', message: 'Hometown' },
        { name: 'personal_phone', message: 'Personal phone number' },
        { name: 'personal_email', message: 'Personal email' },
        { name: 'id_card_number', message: 'ID card number' },
        { name: 'id_card_issue_date', message: 'ID card issue date' },
        { name: 'id_card_issue_place', message: 'ID card issue place' }
    ];

    requiredFields.forEach(field => {
        const input = document.querySelector(`[name="${field.name}"]`);
        const formGroup = input.closest('.form-group');
        console.log(`Validating field: ${field.name}, input found:`, !!input, 'value:', input ? input.value : 'N/A');
        
        if (field.name === 'gender') {
            // Handle radio buttons
            const checked = document.querySelector(`[name="${field.name}"]:checked`);
            console.log(`Gender field checked:`, !!checked);
            if (!checked) {
                showFieldError(formGroup, field.message);
                isValid = false;
            }
        } else {
            // Handle text inputs
            if (!input.value.trim()) {
                console.log(`Field ${field.name} is empty`);
                showFieldError(formGroup, field.message);
                isValid = false;
            }
        }
    });

    console.log('Validation result:', isValid);
    return isValid;
}

function showFieldError(formGroup, fieldName) {
    formGroup.classList.add('error');
    const input = formGroup.querySelector('.form-control');
    if (input) {
        input.classList.add('error');
    }
}

function clearValidation() {
    // Clear all error states
    document.querySelectorAll('.form-group.error').forEach(group => {
        group.classList.remove('error');
    });
    document.querySelectorAll('.form-control.error').forEach(input => {
        input.classList.remove('error');
    });
    
    // Hide validation summary
    document.getElementById('validationSummary').classList.remove('show');
}

function showValidationSummary() {
    const validationSummary = document.getElementById('validationSummary');
    const errorsList = document.getElementById('validationErrors');
    
    // Get all error fields
    const errorFields = document.querySelectorAll('.form-group.error');
    const errorMessages = Array.from(errorFields).map(group => {
        const fieldName = group.querySelector('label').textContent.replace(' (*)', '');
        return `<li>${fieldName}</li>`;
    });
    
    errorsList.innerHTML = errorMessages.join('');
    validationSummary.classList.add('show');
    
    // Scroll to validation summary
    validationSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Prefill only empty inputs so the user can still edit
function prefillFromExtractedData(data) {
    if (!data) return;
    const form = document.getElementById('personalInfoForm');
    Object.entries(data).forEach(([key, value]) => {
        const elements = form.querySelectorAll(`[name="${key}"]`);
        if (!elements.length) return;
        elements.forEach(el => {
            if (el.type === 'radio') {
                if (!form.querySelector(`[name="${key}"]:checked`) && (el.value === String(value).toLowerCase())) {
                    el.checked = true;
                }
            } else if (el.tagName === 'SELECT' || el.tagName === 'TEXTAREA' || el.type === 'text' || el.type === 'email' || el.type === 'tel') {
                if (!el.value) {
                    el.value = value;
                }
            }
        });
    });
}

// Function to convert file to base64
// CV Evaluation function
async function evaluateCV() {
    if (!cvFile) {
        showMessage('Please upload a CV first', 'error');
        return;
    }
    
    const evaluateBtn = document.getElementById('evaluateCvBtn');
    const originalText = evaluateBtn.innerHTML;
    evaluateBtn.disabled = true;
    evaluateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing CV...';
    
    try {
        showMessage('Evaluating CV for Development department...', 'info');
        const b64 = await fileToBase64(cvFile);
        
        const response = await fetch('/personnel/api/evaluate-cv', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                files: [b64],
                department: 'Development'
            })
        });
        
        const result = await response.json();
        
        if (result && result.success && result.evaluation) {
            displayEvaluationResults(result.evaluation);
            showMessage('CV evaluation completed!', 'success');
        } else {
            const errorMsg = result && result.error ? result.error : 'Failed to evaluate CV';
            showMessage(`Evaluation failed: ${errorMsg}`, 'error');
        }
    } catch (error) {
        console.error('CV evaluation error:', error);
        showMessage('Error evaluating CV. Please try again.', 'error');
    } finally {
        evaluateBtn.disabled = false;
        evaluateBtn.innerHTML = originalText;
    }
}

function displayEvaluationResults(evaluation) {
    const resultsDiv = document.getElementById('evaluationResults');
    const contentDiv = document.getElementById('evaluationContent');
    
    if (!resultsDiv || !contentDiv) return;
    
    const suitable = evaluation.suitable;
    const overallScore = evaluation.overall_score;
    const scores = evaluation.scores || {};
    const strengths = evaluation.strengths || [];
    const weaknesses = evaluation.weaknesses || [];
    const recommendation = evaluation.recommendation || 'No recommendation provided';
    const keySkills = evaluation.key_skills_found || [];
    const missingSkills = evaluation.missing_skills || [];
    
    // Determine color based on suitability
    const statusColor = suitable ? '#28a745' : '#dc3545';
    const statusIcon = suitable ? 'fa-check-circle' : 'fa-times-circle';
    const statusText = suitable ? 'Suitable' : 'Not Suitable';
    
    contentDiv.innerHTML = `
        <div style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <i class="fas ${statusIcon}" style="color: ${statusColor}; font-size: 24px;"></i>
                <h4 style="margin: 0; color: ${statusColor};">
                    ${statusText} for ${evaluation.department} Department
                </h4>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="text-align: center;">
                    <div style="font-size: 36px; font-weight: bold; color: ${statusColor};">
                        ${overallScore.toFixed(1)}/10
                    </div>
                    <div style="color: #666; margin-top: 5px;">Overall Score</div>
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #667eea;">
                    ${scores.technical_skills?.toFixed(1) || '0'}/10
                </div>
                <div style="color: #666; font-size: 12px; margin-top: 5px;">Technical Skills</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #667eea;">
                    ${scores.experience_relevance?.toFixed(1) || '0'}/10
                </div>
                <div style="color: #666; font-size: 12px; margin-top: 5px;">Experience</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #667eea;">
                    ${scores.education_background?.toFixed(1) || '0'}/10
                </div>
                <div style="color: #666; font-size: 12px; margin-top: 5px;">Education</div>
            </div>
        </div>
        
        ${strengths.length > 0 ? `
        <div style="margin-bottom: 15px;">
            <h5 style="color: #28a745; margin-bottom: 10px;">
                <i class="fas fa-check-circle"></i> Strengths
            </h5>
            <ul style="margin: 0; padding-left: 20px; color: #333;">
                ${strengths.map(s => `<li>${s}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        ${weaknesses.length > 0 ? `
        <div style="margin-bottom: 15px;">
            <h5 style="color: #dc3545; margin-bottom: 10px;">
                <i class="fas fa-exclamation-circle"></i> Areas for Improvement
            </h5>
            <ul style="margin: 0; padding-left: 20px; color: #333;">
                ${weaknesses.map(w => `<li>${w}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        ${keySkills.length > 0 ? `
        <div style="margin-bottom: 15px;">
            <h5 style="color: #667eea; margin-bottom: 10px;">
                <i class="fas fa-star"></i> Key Skills Found
            </h5>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${keySkills.map(skill => `
                    <span style="background: #e3f2fd; color: #1976d2; padding: 5px 12px; border-radius: 20px; font-size: 12px;">
                        ${skill}
                    </span>
                `).join('')}
            </div>
        </div>
        ` : ''}
        
        ${missingSkills.length > 0 ? `
        <div style="margin-bottom: 15px;">
            <h5 style="color: #ff9800; margin-bottom: 10px;">
                <i class="fas fa-exclamation-triangle"></i> Missing Skills
            </h5>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${missingSkills.map(skill => `
                    <span style="background: #fff3e0; color: #f57c00; padding: 5px 12px; border-radius: 20px; font-size: 12px;">
                        ${skill}
                    </span>
                `).join('')}
            </div>
        </div>
        ` : ''}
        
        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
            <h5 style="color: #2c3e50; margin-bottom: 10px;">
                <i class="fas fa-comment-dots"></i> Recommendation
            </h5>
            <p style="margin: 0; color: #333; line-height: 1.6;">
                ${recommendation}
            </p>
        </div>
    `;
    
    resultsDiv.classList.remove('hidden');
    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// Message display functions
function showMessage(message, type) {
    console.log(`Message (${type}): ${message}`);
    
    // Create or update message element
    let messageElement = document.getElementById('messageContainer');
    if (!messageElement) {
        messageElement = document.createElement('div');
        messageElement.id = 'messageContainer';
        messageElement.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        `;
        document.body.appendChild(messageElement);
    }
    
    // Set message content and style
    messageElement.textContent = message;
    if (type === 'success') {
        messageElement.style.backgroundColor = '#28a745';
    } else if (type === 'error') {
        messageElement.style.backgroundColor = '#dc3545';
    } else {
        messageElement.style.backgroundColor = '#007bff';
    }
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (messageElement) {
            messageElement.remove();
        }
    }, 5000);
}

function hideMessages() {
    const messageElement = document.getElementById('messageContainer');
    if (messageElement) {
        messageElement.remove();
    }
}

function showLoading(show) {
    console.log('Loading:', show);
    // You can add a loading spinner here if needed
}

// Function to reset form and return to CV upload phase
function resetFormAndReturnToCVUpload() {
    console.log('Resetting form and returning to CV upload phase');
    
    // Reset form
    document.getElementById('personalInfoForm').reset();
    
    // Reset file variables
    cvFile = null;
    portraitFile = null;
    healthFile = null;
    idCardFile = null;
    passportFile = null;
    
    // Reset previews
    updatePortraitPreview(null);
    document.getElementById('uploadArea').classList.remove('hidden');
    document.getElementById('previewArea').classList.add('hidden');
    
    // Return to step 1 (CV upload phase)
    currentStep = 1;
    document.getElementById('step1').classList.add('active');
    document.getElementById('step1').classList.remove('completed');
    document.getElementById('step2').classList.remove('active');
    
    document.getElementById('cvUploadStep').classList.remove('hidden');
    document.getElementById('personalInfoStep').classList.add('hidden');
    
    // Reset CV upload area
    document.getElementById('cvFileInput').value = '';
    document.getElementById('cvPreview').src = '';
    document.getElementById('uploadArea').classList.remove('hidden');
    document.getElementById('previewArea').classList.add('hidden');
    
    // Clear any validation errors
    clearValidation();
    
    console.log('Form reset and returned to CV upload phase');
}

// Function to save/update employee data to database
async function submitEmployeeData() {
    try {
        console.log('submitEmployeeData() function called');
        showLoading(true);
        hideMessages();
        
        // Collect form data
        const formData = new FormData(document.getElementById('personalInfoForm'));
        const employeeData = {};
        
        // Convert FormData to object
        for (let [key, value] of formData.entries()) {
            employeeData[key] = value;
        }
        console.log('Collected form data:', employeeData);
        
        const fileFieldNames = ['cv_file', 'portrait_file', 'health_file', 'id_card_file', 'passport_file'];
        fileFieldNames.forEach(name => {
            delete employeeData[name];
        });

        // Handle file uploads (only add when present)
        const fileConversions = [];
        if (cvFile) {
            fileConversions.push(fileToBase64(cvFile).then(result => {
                employeeData.cv_file = result;
            }));
        }
        if (portraitFile) {
            fileConversions.push(fileToBase64(portraitFile).then(result => {
                employeeData.portrait_file = result;
            }));
        }
        if (healthFile) {
            fileConversions.push(fileToBase64(healthFile).then(result => {
                employeeData.health_file = result;
            }));
        }
        if (idCardFile) {
            fileConversions.push(fileToBase64(idCardFile).then(result => {
                employeeData.id_card_file = result;
            }));
        }
        if (passportFile) {
            fileConversions.push(fileToBase64(passportFile).then(result => {
                employeeData.passport_file = result;
            }));
        }

        await Promise.all(fileConversions);

        // Send data to backend
        console.log('Sending data to API:', employeeData);
        const url = IS_EDIT_MODE ? `/personnel/api/employee/${EMPLOYEE_ID}` : '/personnel/api/employee';
        const method = IS_EDIT_MODE ? 'PUT' : 'POST';
        const response = await fetch(url, {
            method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(employeeData)
        });
        
        console.log('API response status:', response.status);
        const result = await response.json();
        console.log('API response data:', result);
        
        if (result.success) {
            showMessage(result.message, 'success');
            if (IS_EDIT_MODE) {
                setTimeout(() => {
                    window.location.href = '/personnel/list';
                }, 1500);
            } else {
                // Reset form and return to CV upload phase after successful submission
                setTimeout(() => {
                    resetFormAndReturnToCVUpload();
                }, 2000);
            }
        } else {
            showMessage(`Error: ${result.error}`, 'error');
        }
        
    } catch (error) {
        console.error('Error submitting employee data:', error);
        showMessage(`Failed to submit employee data: ${error.message}`, 'error');
    } finally {
        showLoading(false);
    }
}
</script>
{% endblock %}
