{% extends "base.html" %}

{% block title %}{{ 'Edit Employee' if mode == 'edit' else 'Add Employee' }} - HRM System{% endblock %}

{% block page_title %}
    <i class="fas {{ 'fa-user-edit' if mode == 'edit' else 'fa-user-plus' }}"></i>
    <span id="pageTitleEmployee">{{ 'Edit Employee' if mode == 'edit' else 'Add Employee' }}</span>
{% endblock %}

{% block extra_css %}
<style>
    .personnel-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .personnel-card {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .form-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #fafafa;
    }

    .section-header {
        background: #f5f5f5;
        padding: 10px 15px;
        margin: -20px -20px 20px -20px;
        border-radius: 8px 8px 0 0;
        font-weight: bold;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        flex: 1;
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }

    .form-group label.required::after {
        content: " (*)";
        color: #e74c3c;
        font-weight: bold;
    }

    .form-control.error {
        border-color: #e74c3c;
        box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.25);
    }

    .error-message {
        color: #e74c3c;
        font-size: 12px;
        margin-top: 5px;
        display: none;
    }

    .form-group.error .error-message {
        display: block;
    }

    .validation-summary {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        display: none;
    }

    .validation-summary.show {
        display: block;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }

    .radio-group {
        display: flex;
        gap: 20px;
        margin-top: 5px;
    }

    .radio-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .radio-item input[type="radio"] {
        margin: 0;
    }

    .upload-section {
        text-align: center;
        padding: 30px;
        border: 2px dashed #ddd;
        border-radius: 8px;
        background: #f9f9f9;
    }

    .upload-preview {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #ddd;
        margin: 15px auto;
        display: block;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #4c6ef5;
        color: #ffffff;
        box-shadow: none;
    }

    .btn-primary:hover {
        background: #384ddf;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-success:hover {
        background: #1e7e34;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    .btn-upload {
        background: #28a745;
        color: #ffffff;
        padding: 10px 16px;
        font-size: 14px;
        border-radius: 10px;
        font-weight: 600;
        margin-top: 12px;
    }

    .btn-upload:hover {
        background: #1e7e34;
    }

    .btn-evaluate {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-evaluate:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        background: linear-gradient(135deg, #5568d3 0%, #6a3fa0 100%);
    }

    .btn-evaluate:active {
        transform: translateY(0);
    }

    .btn-evaluate:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .btn-evaluate i {
        font-size: 16px;
    }

    .hidden {
        display: none;
    }

    .form-actions {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e0e0e0;
    }

    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
    }

    .step {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        background: #f8f9fa;
        border-radius: 25px;
        margin: 0 10px;
    }

    .step.active {
        background: #007bff;
        color: white;
    }

    .step.completed {
        background: #28a745;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
    <div class="personnel-container">
        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step" id="step1">
                <i class="fas fa-upload"></i>
                <span id="stepUploadCV">Upload CV</span>
            </div>
            <div class="step" id="step2">
                <i class="fas fa-user"></i>
                <span id="stepPersonalInfo">Personal Info</span>
            </div>
        </div>

        <!-- Step 1: CV Upload -->
        <div class="personnel-card" id="cvUploadStep">
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">
                <i class="fas fa-upload"></i> <span id="uploadCVTitle">Upload CV (Image or PDF)</span>
            </h2>
            
            <div class="upload-section">
                <div id="uploadArea">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                    <h4 id="uploadCVTitle2">Upload CV (Image or PDF)</h4>
                    <p id="uploadCVDesc">You can upload a CV file (image or PDF) or skip this step — Max 10 files, 100MB each</p>
                    <input type="file" id="cvFileInput" accept="image/*,.pdf,application/pdf" style="display: none;">
                    <button class="btn btn-upload" onclick="document.getElementById('cvFileInput').click()">
                        <i class="fas fa-upload"></i> <span id="uploadBtnText">Upload</span>
                    </button>
                </div>
                
                <div id="previewArea" class="hidden">
                    <img id="cvPreview" class="upload-preview" src="" alt="CV Preview">
                    <p id="cvPreviewLabel">CV Uploaded</p>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="removeCV()">
                            <i class="fas fa-trash"></i> <span id="removeBtnText">Remove</span>
                        </button>
                        <button class="btn-evaluate" id="evaluateCvBtn" onclick="evaluateCV()">
                            <i class="fas fa-brain"></i> <span id="evaluateCVBtnText">Evaluate CV for Development</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- CV Evaluation Results -->
            <div id="evaluationResults" class="hidden" style="margin-top: 20px;">
                <div class="personnel-card" style="background: #f8f9fa; border-left: 4px solid #667eea;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">
                        <i class="fas fa-chart-line"></i> <span id="cvEvaluationResultsTitle">CV Evaluation Results</span>
                    </h3>
                    <div id="evaluationContent">
                        <!-- Evaluation results will be displayed here -->
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-secondary" style="margin-right: 10px;" onclick="goBackToAddModeSelection()">
                    <i class="fas fa-arrow-left"></i> <span id="backBtnText">Back</span>
                </button>
                <button id="resetSessionBtn" class="btn btn-secondary hidden" style="margin-right: 10px;" onclick="resetCvSession()">
                    <i class="fas fa-undo"></i> <span id="resetBtnText">Reset</span>
                </button>
                <button class="btn btn-primary" onclick="nextStep()">
                    <i class="fas fa-arrow-right"></i> <span id="continueBtnText">Continue</span>
                </button>
            </div>
        </div>

        <!-- Step 2: Personal Information Form -->
        <div class="personnel-card hidden" id="personalInfoStep">
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">
                <i class="fas fa-user"></i> <span id="personalInfoTitle">Personal Information</span>
            </h2>
            
            <form id="personalInfoForm">
                <!-- Validation Summary -->
                <div id="validationSummary" class="validation-summary">
                    <strong><i class="fas fa-exclamation-triangle"></i> <span id="validationFillAll">Please fill in all required fields:</span></strong>
                    <ul id="validationErrors"></ul>
                </div>
                
                <!-- Personal Information Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-user"></i>
                        <span id="sectionPersonalInfo">PERSONAL INFORMATION</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required" data-translate="form.portraitPhoto">Portrait Photo</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button type="button" class="btn btn-upload" onclick="document.getElementById('portraitFileInput').click()">
                                    <i class="fas fa-upload"></i> <span data-translate="upload">Upload</span>
                                </button>
                                <input type="file" id="portraitFileInput" accept="image/*" style="display: none;">
                                <div id="portraitPreview" style="width: 60px; height: 60px; border-radius: 50%; background: #f0f0f0; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user" style="color: #999;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required" data-translate="form.fullName">Full Name</label>
                            <input type="text" class="form-control" name="full_name" data-translate-placeholder="form.fullNamePlaceholder" placeholder="Full name">
                            <div class="error-message" data-translate="form.errorFullName">Please enter full name</div>
                        </div>
                        <div class="form-group">
                            <label class="required" data-translate="form.gender">Gender</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" name="gender" value="male" id="gender_male">
                                    <label for="gender_male" data-translate="form.male">Male</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" name="gender" value="female" id="gender_female">
                                    <label for="gender_female" data-translate="form.female">Female</label>
                                </div>
                            </div>
                            <div class="error-message" data-translate="form.errorGender">Please select gender</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required" data-translate="form.dateOfBirth">Date of Birth</label>
                            <input type="text" class="form-control" name="date_of_birth" placeholder="dd/mm/yyyy">
                            <div class="error-message" data-translate="form.errorDateOfBirth">Please enter date of birth</div>
                        </div>
                        <div class="form-group">
                            <label class="required" data-translate="form.placeOfBirth">Place of Birth</label>
                            <input type="text" class="form-control" name="place_of_birth" data-translate-placeholder="form.placeOfBirthPlaceholder" placeholder="Enter place of birth">
                            <div class="error-message" data-translate="form.errorPlaceOfBirth">Please enter place of birth</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required" data-translate="form.hometown">Hometown</label>
                            <input type="text" class="form-control" name="hometown" data-translate-placeholder="form.hometownPlaceholder" placeholder="Enter hometown">
                            <div class="error-message" data-translate="form.errorHometown">Please enter hometown</div>
                        </div>
                        <div class="form-group">
                            <label data-translate="form.maritalStatus">Marital Status</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" name="marital_status" value="single" id="marital_single">
                                    <label for="marital_single" data-translate="form.single">Single</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" name="marital_status" value="married" id="marital_married">
                                    <label for="marital_married" data-translate="form.married">Married</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" name="marital_status" value="other" id="marital_other">
                                    <label for="marital_other" data-translate="form.other">Other</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label data-translate="form.ethnicity">Ethnicity</label>
                            <input type="text" class="form-control" name="ethnicity" data-translate-placeholder="form.ethnicityPlaceholder" placeholder="Enter ethnicity">
                        </div>
                        <div class="form-group">
                            <label data-translate="form.religion">Religion</label>
                            <input type="text" class="form-control" name="religion" data-translate-placeholder="form.religionPlaceholder" placeholder="Enter religion">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label data-translate="form.personalTaxCode">Personal Tax Code</label>
                            <input type="text" class="form-control" name="personal_tax_code" data-translate-placeholder="form.personalTaxCodePlaceholder" placeholder="Enter personal tax code">
                        </div>
                        <div class="form-group">
                            <label data-translate="form.socialInsuranceCode">Social Insurance Code</label>
                            <input type="text" class="form-control" name="social_insurance_code" data-translate-placeholder="form.socialInsuranceCodePlaceholder" placeholder="Enter social insurance code">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required" data-translate="form.personalPhoneNumber">Personal Phone Number</label>
                            <input type="tel" class="form-control" name="personal_phone" data-translate-placeholder="form.personalPhoneNumberPlaceholder" placeholder="Enter personal phone number">
                            <div class="error-message" data-translate="form.errorPersonalPhone">Please enter personal phone number</div>
                        </div>
                        <div class="form-group">
                            <label class="required" data-translate="form.personalEmail">Personal Email</label>
                            <input type="email" class="form-control" name="personal_email" data-translate-placeholder="form.personalEmailPlaceholder" placeholder="Enter personal email">
                            <div class="error-message" data-translate="form.errorPersonalEmail">Please enter personal email</div>
                        </div>
                    </div>
                    
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label data-translate="form.partyJoinDate">Party Join Date</label>
                            <input type="text" class="form-control" name="party_join_date" placeholder="dd/mm/yyyy">
                        </div>
                        <div class="form-group">
                            <label data-translate="form.partyJoinPlace">Party Join Place</label>
                            <input type="text" class="form-control" name="party_join_place" data-translate-placeholder="form.partyJoinPlacePlaceholder" placeholder="Enter party join place">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label data-translate="form.healthStatus">Health Status</label>
                            <select class="form-control" name="health_status">
                                <option value="">Select health status</option>
                                <option value="excellent">Excellent</option>
                                <option value="good">Good</option>
                                <option value="fair">Fair</option>
                                <option value="poor">Poor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-translate="form.healthCertificate">Health Certificate</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button type="button" class="btn btn-upload" onclick="document.getElementById('healthFileInput').click()">
                                    <i class="fas fa-upload"></i> <span data-translate="upload">Upload</span>
                                </button>
                                <input type="file" id="healthFileInput" accept="image/*" style="display: none;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label data-translate="form.emergencyContact">Emergency Contact (name + phone)</label>
                            <input type="text" class="form-control" name="emergency_contact" data-translate-placeholder="form.emergencyContactPlaceholder" placeholder="Name and phone number for emergency contact">
                        </div>
                    </div>
                </div>

                <!-- Address Information Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-home"></i>
                        <span id="sectionPermanentResidence" data-translate="form.permanentResidence">PERMANENT RESIDENCE & CURRENT ADDRESS</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label><strong data-translate="form.permanentResidenceLabel">Permanent residence e.g., "144 Nghia Do Ward, Hanoi City"</strong></label>
                            <textarea class="form-control" name="permanent_address" rows="3" data-translate-placeholder="form.permanentResidencePlaceholder" placeholder="Enter permanent address"></textarea>
                        </div>
                        <div class="form-group">
                            <label><strong data-translate="form.currentAddressLabel">Current address e.g., "144 Nghia Do Ward, Hanoi City"</strong></label>
                            <textarea class="form-control" name="current_address" rows="3" data-translate-placeholder="form.currentAddressPlaceholder" placeholder="Enter current address"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label data-translate="form.provinceCity">Province/City</label>
                            <select class="form-control" name="permanent_province">
                                <option value="">Select Province/City</option>
                                <option value="hanoi">Hanoi</option>
                                <option value="hcm">Ho Chi Minh City</option>
                                <option value="danang">Da Nang</option>
                                <option value="haiphong">Hai Phong</option>
                                <option value="cantho">Can Tho</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-translate="form.provinceCity">Province/City</label>
                            <select class="form-control" name="current_province">
                                <option value="">Select Province/City</option>
                                <option value="hanoi">Hanoi</option>
                                <option value="hcm">Ho Chi Minh City</option>
                                <option value="danang">Da Nang</option>
                                <option value="haiphong">Hai Phong</option>
                                <option value="cantho">Can Tho</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label data-translate="form.wardDistrictTown">Ward/District/Town</label>
                            <select class="form-control" name="permanent_ward">
                                <option value="">Select Ward/District/Town</option>
                                <option value="nghia_do">Nghia Do</option>
                                <option value="cau_giay">Cau Giay</option>
                                <option value="dong_da">Dong Da</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-translate="form.wardDistrictTown">Ward/District/Town</label>
                            <select class="form-control" name="current_ward">
                                <option value="">Select Ward/District/Town</option>
                                <option value="nghia_do">Nghia Do</option>
                                <option value="cau_giay">Cau Giay</option>
                                <option value="dong_da">Dong Da</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label data-translate="form.houseNumberStreet">House number, street/hamlet</label>
                            <input type="text" class="form-control" name="permanent_street" data-translate-placeholder="form.houseNumberStreetPlaceholder" placeholder="Enter house number, street/hamlet">
                        </div>
                        <div class="form-group">
                            <label data-translate="form.houseNumberStreet">House number, street/hamlet</label>
                            <input type="text" class="form-control" name="current_street" data-translate-placeholder="form.houseNumberStreetPlaceholder" placeholder="Enter house number, street/hamlet">
                        </div>
                    </div>
                </div>

                <!-- ID Card & Passport Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-id-card"></i>
                        <span id="sectionIdCardPassport" data-translate="form.idCardPassport">ID CARD & PASSPORT</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required"><strong data-translate="form.idCardNumber">ID Card Number</strong></label>
                            <input type="text" class="form-control" name="id_card_number" data-translate-placeholder="form.idCardNumberPlaceholder" placeholder="Enter ID card number">
                            <div class="error-message" data-translate="form.errorIdCardNumber">Please enter ID card number</div>
                        </div>
                        <div class="form-group">
                            <label><strong data-translate="form.passportNumber">Passport Number</strong></label>
                            <input type="text" class="form-control" name="passport_number" data-translate-placeholder="form.passportNumberPlaceholder" placeholder="Enter passport number">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required" data-translate="form.issueDate">Issue Date</label>
                            <input type="text" class="form-control" name="id_card_issue_date" placeholder="dd/mm/yyyy">
                            <div class="error-message" data-translate="form.errorIdCardIssueDate">Please enter ID card issue date</div>
                        </div>
                        <div class="form-group">
                            <label data-translate="form.issueDate">Issue Date</label>
                            <input type="text" class="form-control" name="passport_issue_date" placeholder="dd/mm/yyyy">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label data-translate="form.expiryDate">Expiry Date</label>
                            <input type="text" class="form-control" name="id_card_expiry_date" placeholder="dd/mm/yyyy">
                        </div>
                        <div class="form-group">
                            <label data-translate="form.expiryDate">Expiry Date</label>
                            <input type="text" class="form-control" name="passport_expiry_date" placeholder="dd/mm/yyyy">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required" data-translate="form.idCardIssuePlace">Issue Place</label>
                            <input type="text" class="form-control" name="id_card_issue_place" data-translate-placeholder="form.idCardIssuePlacePlaceholder" placeholder="Enter ID card issue place">
                            <div class="error-message" data-translate="form.errorIdCardIssuePlace">Please enter ID card issue place</div>
                        </div>
                        <div class="form-group">
                            <label data-translate="form.passportIssuePlace">Issue Place</label>
                            <input type="text" class="form-control" name="passport_issue_place" data-translate-placeholder="form.passportIssuePlacePlaceholder" placeholder="Enter passport issue place">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label data-translate="form.attachBothSides">Attach (both sides)</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button type="button" class="btn btn-upload" onclick="document.getElementById('idCardFileInput').click()">
                                    <i class="fas fa-upload"></i> <span data-translate="upload">Upload</span>
                                </button>
                                <input type="file" id="idCardFileInput" accept="image/*" style="display: none;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label data-translate="form.attachBothSides">Attach (both sides)</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button type="button" class="btn btn-upload" onclick="document.getElementById('passportFileInput').click()">
                                    <i class="fas fa-upload"></i> <span data-translate="upload">Upload</span>
                                </button>
                                <input type="file" id="passportFileInput" accept="image/*" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Information Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-key"></i>
                        <span id="sectionAccountInfo" data-translate="form.accountInformation">ACCOUNT INFORMATION</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label data-translate="form.employeeEmail">Employee Email</label>
                            <input type="email" class="form-control" name="account_email" id="account_email" data-translate-placeholder="form.employeeEmailPlaceholder" placeholder="Enter email for employee account (optional)">
                            <small style="color: #666; font-size: 0.85rem; display: block; margin-top: 5px;" data-translate="form.employeeEmailHelp">
                                Leave blank if you don't want to create a login account for this employee
                            </small>
                        </div>
                        <div class="form-group">
                            <label data-translate="form.password">Password</label>
                            <div style="position: relative;">
                                <input type="password" class="form-control" name="account_password" id="account_password" data-translate-placeholder="form.passwordPlaceholder" placeholder="Enter password (required if email provided)">
                                <button type="button" class="btn btn-secondary" onclick="generatePassword()" style="margin-top: 5px; width: 100%; font-size: 0.85rem;">
                                    <i class="fas fa-key"></i> <span data-translate="form.generateStrongPassword">Generate Strong Password</span>
                                </button>
                            </div>
                            <small style="color: #666; font-size: 0.85rem; display: block; margin-top: 5px;" data-translate="form.passwordHelp">
                                Password is required if email is provided
                            </small>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <div id="passwordStrength" style="margin-top: 8px; padding: 8px; border-radius: 4px; display: none;">
                                <div style="font-size: 0.85rem; font-weight: 600; margin-bottom: 4px;" data-translate="form.passwordStrength">Password Strength:</div>
                                <div id="passwordStrengthBar" style="height: 4px; background: #e0e0e0; border-radius: 2px; overflow: hidden;">
                                    <div id="passwordStrengthFill" style="height: 100%; width: 0%; transition: all 0.3s ease;"></div>
                                </div>
                                <div id="passwordStrengthText" style="font-size: 0.75rem; margin-top: 4px; color: #666;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">
                        <i class="fas fa-arrow-left"></i> <span data-translate="back">Back</span>
                    </button>
                    <button type="submit" class="btn btn-success" onclick="handleFormSubmission(); return false;">
                        <i class="fas fa-check"></i> <span data-translate="form.finish">Finish</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script type="application/json" id="initialEmployeeData">
{{ employee_data|default({})|tojson }}
</script>
<script>
const PAGE_MODE = "{{ mode|default('add') }}";
const IS_EDIT_MODE = PAGE_MODE === 'edit';
const EMPLOYEE_ID = "{{ employee_id if employee_id is not none else '' }}";
const initialEmployeeDataScript = document.getElementById('initialEmployeeData');
const INITIAL_EMPLOYEE_DATA = initialEmployeeDataScript ? JSON.parse(initialEmployeeDataScript.textContent || '{}') : {};

let currentStep = 1;
let cvFile = null;
let portraitFile = null;
let healthFile = null;
let idCardFile = null;
let passportFile = null;

document.addEventListener('DOMContentLoaded', function() {
    const activeNavHref = IS_EDIT_MODE ? '/personnel/list' : '/personnel/add';
    setActiveSidebarItem(activeNavHref);
    // Sidebar is handled by main sidebar component
    
    // Translate page title
    function translatePageTitle() {
        const titleElement = document.getElementById('pageTitleEmployee');
        if (titleElement && window.t) {
            if (IS_EDIT_MODE) {
                titleElement.textContent = window.t('ui.sidebar.personnel.editEmployee', 'Edit Employee');
            } else {
                titleElement.textContent = window.t('ui.sidebar.personnel.addEmployee', 'Add Employee');
            }
        }
    }
    
    // Translate form elements
    function translateForm() {
        if (!window.t) return;
        
        // Step indicators
        const stepUploadCV = document.getElementById('stepUploadCV');
        if (stepUploadCV) {
            stepUploadCV.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.stepUploadCV', 'Upload CV');
        }
        
        const stepPersonalInfo = document.getElementById('stepPersonalInfo');
        if (stepPersonalInfo) {
            stepPersonalInfo.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.stepPersonalInfo', 'Personal Info');
        }
        
        // CV Upload section
        const uploadCVTitle = document.getElementById('uploadCVTitle');
        if (uploadCVTitle) {
            uploadCVTitle.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.uploadCVTitle', 'Upload CV (Image or PDF)');
        }
        
        const uploadCVTitle2 = document.getElementById('uploadCVTitle2');
        if (uploadCVTitle2) {
            uploadCVTitle2.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.uploadCVTitle', 'Upload CV (Image or PDF)');
        }
        
        const uploadCVDesc = document.getElementById('uploadCVDesc');
        if (uploadCVDesc) {
            uploadCVDesc.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.uploadCVDesc', 'You can upload a CV file (image or PDF) or skip this step — Max 10 files, 100MB each');
        }
        
        const uploadBtnText = document.getElementById('uploadBtnText');
        if (uploadBtnText) {
            uploadBtnText.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.upload', 'Upload');
        }
        
        const cvPreviewLabel = document.getElementById('cvPreviewLabel');
        if (cvPreviewLabel && !cvPreviewLabel.textContent.includes('PDF')) {
            cvPreviewLabel.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.cvUploaded', 'CV Uploaded');
        }
        
        const removeBtnText = document.getElementById('removeBtnText');
        if (removeBtnText) {
            removeBtnText.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.remove', 'Remove');
        }
        
        const evaluateCVBtnText = document.getElementById('evaluateCVBtnText');
        if (evaluateCVBtnText) {
            evaluateCVBtnText.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.evaluateCV', 'Evaluate CV for Development');
        }
        
        const cvEvaluationResultsTitle = document.getElementById('cvEvaluationResultsTitle');
        if (cvEvaluationResultsTitle) {
            cvEvaluationResultsTitle.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.cvEvaluationResults', 'CV Evaluation Results');
        }
        
        // Action buttons
        const backBtnText = document.getElementById('backBtnText');
        if (backBtnText) {
            backBtnText.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.back', 'Back');
        }
        
        const resetBtnText = document.getElementById('resetBtnText');
        if (resetBtnText) {
            resetBtnText.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.reset', 'Reset');
        }
        
        const continueBtnText = document.getElementById('continueBtnText');
        if (continueBtnText) {
            continueBtnText.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.continue', 'Continue');
        }
        
        // Personal Information section
        const personalInfoTitle = document.getElementById('personalInfoTitle');
        if (personalInfoTitle) {
            personalInfoTitle.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.personalInformation', 'Personal Information');
        }
        
        // Translate all elements with data-translate attribute
        document.querySelectorAll('[data-translate]').forEach(el => {
            const key = el.getAttribute('data-translate');
            const fullKey = `ui.sidebar.personnel.addEmployeeForm.${key}`;
            if (window.t) {
                el.textContent = window.t(fullKey, el.textContent);
            }
        });
        
        // Translate all placeholders with data-translate-placeholder attribute
        document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
            const key = el.getAttribute('data-translate-placeholder');
            const fullKey = `ui.sidebar.personnel.addEmployeeForm.${key}`;
            if (window.t) {
                el.placeholder = window.t(fullKey, el.placeholder);
            }
        });
        
        // Translate validation message
        const validationFillAll = document.getElementById('validationFillAll');
        if (validationFillAll && window.t) {
            validationFillAll.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.form.validationFillAll', 'Please fill in all required fields:');
        }
        
        // Translate section headers
        const sectionPersonalInfo = document.getElementById('sectionPersonalInfo');
        if (sectionPersonalInfo && window.t) {
            sectionPersonalInfo.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.form.personalInformation', 'PERSONAL INFORMATION');
        }
        
        const sectionPermanentResidence = document.getElementById('sectionPermanentResidence');
        if (sectionPermanentResidence && window.t) {
            sectionPermanentResidence.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.form.permanentResidence', 'PERMANENT RESIDENCE & CURRENT ADDRESS');
        }
        
        const sectionIdCardPassport = document.getElementById('sectionIdCardPassport');
        if (sectionIdCardPassport && window.t) {
            sectionIdCardPassport.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.form.idCardPassport', 'ID CARD & PASSPORT');
        }
        
        const sectionAccountInfo = document.getElementById('sectionAccountInfo');
        if (sectionAccountInfo && window.t) {
            sectionAccountInfo.textContent = window.t('ui.sidebar.personnel.addEmployeeForm.form.accountInformation', 'ACCOUNT INFORMATION');
        }
        
        // Translate select options
        const healthStatusSelect = document.querySelector('select[name="health_status"]');
        if (healthStatusSelect && window.t) {
            const options = healthStatusSelect.querySelectorAll('option');
            if (options[0]) options[0].textContent = window.t('ui.sidebar.personnel.addEmployeeForm.form.selectHealthStatus', 'Select health status');
            if (options[1]) options[1].textContent = window.t('ui.sidebar.personnel.addEmployeeForm.form.healthStatusExcellent', 'Excellent');
            if (options[2]) options[2].textContent = window.t('ui.sidebar.personnel.addEmployeeForm.form.healthStatusGood', 'Good');
            if (options[3]) options[3].textContent = window.t('ui.sidebar.personnel.addEmployeeForm.form.healthStatusFair', 'Fair');
            if (options[4]) options[4].textContent = window.t('ui.sidebar.personnel.addEmployeeForm.form.healthStatusPoor', 'Poor');
        }
        
        // Translate province/city select options
        document.querySelectorAll('select[name="permanent_province"], select[name="current_province"]').forEach(select => {
            if (select && window.t) {
                const options = select.querySelectorAll('option');
                if (options[0]) options[0].textContent = window.t('ui.sidebar.personnel.addEmployeeForm.form.selectProvinceCity', 'Select Province/City');
            }
        });
        
        // Translate ward/district/town select options
        document.querySelectorAll('select[name="permanent_ward"], select[name="current_ward"]').forEach(select => {
            if (select && window.t) {
                const options = select.querySelectorAll('option');
                if (options[0]) options[0].textContent = window.t('ui.sidebar.personnel.addEmployeeForm.form.selectWardDistrictTown', 'Select Ward/District/Town');
            }
        });
    }
    
    // Translate on load
    translatePageTitle();
    translateForm();
    
    // Translate when language changes
    window.addEventListener('languagechange', function() {
        translatePageTitle();
        translateForm();
    });

    if (IS_EDIT_MODE) {
        initializeEditMode();
    }
    
    // CV Upload functionality
    document.getElementById('cvFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            cvFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                const uploadArea = document.getElementById('uploadArea');
                const previewArea = document.getElementById('previewArea');
                const previewImg = document.getElementById('cvPreview');
                const previewLabel = document.getElementById('cvPreviewLabel');

                if (file.type === 'application/pdf' || file.name.toLowerCase().endswith('.pdf')) {
                    // For PDF, don't try to render in <img>; just show an icon/label
                    previewImg.src = '';
                    previewImg.style.display = 'none';
                    const cvUploadedText = window.t ? window.t('ui.sidebar.personnel.addEmployeeForm.cvUploaded', 'CV Uploaded') : 'CV Uploaded';
                    previewLabel.textContent = `${cvUploadedText} PDF: ${file.name}`;
                } else {
                    previewImg.style.display = 'block';
                    previewImg.src = e.target.result;
                    const cvUploadedText = window.t ? window.t('ui.sidebar.personnel.addEmployeeForm.cvUploaded', 'CV Uploaded') : 'CV Uploaded';
                    previewLabel.textContent = cvUploadedText;
                }

                uploadArea.classList.add('hidden');
                previewArea.classList.remove('hidden');
                const resetBtn = document.getElementById('resetSessionBtn');
                if (resetBtn) resetBtn.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Portrait upload functionality
    document.getElementById('portraitFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            portraitFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                updatePortraitPreview(e.target.result);
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Health file upload functionality
    document.getElementById('healthFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            healthFile = file;
        }
    });
    
    // ID Card file upload functionality
    document.getElementById('idCardFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            idCardFile = file;
        }
    });
    
    // Passport file upload functionality
    document.getElementById('passportFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            passportFile = file;
        }
    });
    
    // Form submission using event delegation
    document.addEventListener('submit', function(e) {
        if (e.target.id === 'personalInfoForm') {
            e.preventDefault();
            console.log('Form submit event triggered');
            handleFormSubmission();
        }
    });
    
    // Also add click event listener to the submit button as backup
    document.addEventListener('click', function(e) {
        console.log('Click detected on:', e.target);
        if (e.target.closest('button[type="submit"]') && e.target.closest('#personalInfoForm')) {
            e.preventDefault();
            console.log('Submit button clicked - calling handleFormSubmission()');
            handleFormSubmission();
        }
    });
    
    // Function to handle form submission
    function handleFormSubmission() {
        console.log('handleFormSubmission() called');
        
        // Clear previous validation
        clearValidation();
        
        // Validate form
        const isValid = validateForm();
        console.log('Form validation result:', isValid);
        
        if (isValid) {
            console.log('Form is valid, calling submitEmployeeData()');
            submitEmployeeData();
        } else {
            console.log('Form is invalid, showing validation summary');
            showValidationSummary();
        }
    }
});

function initializeEditMode() {
    console.log('initializeEditMode() called');

    currentStep = 2;
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const cvStep = document.getElementById('cvUploadStep');
    const personalStep = document.getElementById('personalInfoStep');

    if (step1 && step2 && cvStep && personalStep) {
        step1.classList.remove('active');
        step1.classList.add('completed');
        step2.classList.add('active');
        cvStep.classList.add('hidden');
        personalStep.classList.remove('hidden');
    }

    populateFormWithEmployeeData(INITIAL_EMPLOYEE_DATA || {});

    if (INITIAL_EMPLOYEE_DATA && INITIAL_EMPLOYEE_DATA.portrait_file) {
        updatePortraitPreview(INITIAL_EMPLOYEE_DATA.portrait_file);
    }
}

function populateFormWithEmployeeData(data) {
    if (!data) {
        return;
    }

    const form = document.getElementById('personalInfoForm');
    Object.entries(data).forEach(([key, rawValue]) => {
        let value = rawValue;
        if (value === null || typeof value === 'undefined') {
            value = '';
        }

        const elements = form.querySelectorAll(`[name="${key}"]`);
        if (!elements.length) {
            return;
        }

        elements.forEach(element => {
            if (element.type === 'radio') {
                element.checked = element.value === value;
            } else if (element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') {
                element.value = value;
            } else if (element.type === 'checkbox') {
                element.checked = value === true || value === 'true';
            } else {
                element.value = value;
            }
        });
    });
}

function updatePortraitPreview(source) {
    const preview = document.getElementById('portraitPreview');
    if (!preview) {
        return;
    }

    if (source) {
        preview.innerHTML = `<img src="${source}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
    } else {
        preview.innerHTML = '<i class="fas fa-user" style="color: #999;"></i>';
    }
}

function nextStep() {
    console.log('nextStep() called');
    currentStep = 2;
    document.getElementById('step1').classList.remove('active');
    document.getElementById('step1').classList.add('completed');
    document.getElementById('step2').classList.add('active');
    
    document.getElementById('cvUploadStep').classList.add('hidden');
    document.getElementById('personalInfoStep').classList.remove('hidden');
    
    console.log('Form should now be visible');
    console.log('Form element:', document.getElementById('personalInfoForm'));

    // If a CV was uploaded, call backend to extract fields with Gemini and prefill
    if (cvFile) {
        const readingMsg = window.t ? window.t('ui.sidebar.personnel.addEmployeeForm.readingCV', 'Reading CV to prefill your info...') : 'Reading CV to prefill your info...';
        showMessage(readingMsg, 'info');
        fileToBase64(cvFile)
            .then(b64 => fetch('/personnel/api/extract-cv', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ files: [b64] })
            }))
            .then(res => {
                if (!res.ok) {
                    return res.json().then(err => {
                        throw new Error(err.error || `HTTP ${res.status}: ${res.statusText}`);
                    });
                }
                return res.json();
            })
            .then(result => {
                console.log('CV extraction result:', result);
                if (result && result.success) {
                    if (result.data && Object.keys(result.data).length > 0) {
                        prefillFromExtractedData(result.data);
                        const successMsg = window.t ? window.t('ui.sidebar.personnel.addEmployeeForm.cvParsedSuccess', 'CV parsed. Fields were prefilled when available.') : 'CV parsed. Fields were prefilled when available.';
                        showMessage(successMsg, 'success');
                    } else {
                        const noDataMsg = window.t ? window.t('ui.sidebar.personnel.addEmployeeForm.cvNoDataFound', 'CV was read but no extractable information was found. Please fill the form manually.') : 'CV was read but no extractable information was found. Please fill the form manually.';
                        showMessage(noDataMsg, 'info');
                    }
                } else {
                    const detail = result && result.error ? ` (${result.error})` : '';
                    const errorMsg = window.t ? window.t('ui.sidebar.personnel.addEmployeeForm.cvExtractError', 'Could not extract info from the CV.') : 'Could not extract info from the CV.';
                    showMessage(`${errorMsg}${detail}`, 'error');
                }
            })
            .catch(err => {
                console.error('CV extraction error:', err);
                const errorMsg = err.message || 'Unknown error occurred';
                const readErrorMsg = window.t ? window.t('ui.sidebar.personnel.addEmployeeForm.cvReadError', 'Error reading CV:') : 'Error reading CV:';
                showMessage(`${readErrorMsg} ${errorMsg}`, 'error');
            });
    }
}

function prevStep() {
    currentStep = 1;
    document.getElementById('step2').classList.remove('active');
    document.getElementById('step1').classList.remove('completed');
    document.getElementById('step1').classList.add('active');
    
    document.getElementById('personalInfoStep').classList.add('hidden');
    document.getElementById('cvUploadStep').classList.remove('hidden');
}

function removeCV() {
    cvFile = null;
    document.getElementById('cvFileInput').value = '';
    document.getElementById('uploadArea').classList.remove('hidden');
    document.getElementById('previewArea').classList.add('hidden');
    const resetBtn = document.getElementById('resetSessionBtn');
    if (resetBtn) resetBtn.classList.add('hidden');
}

function goBackToAddModeSelection() {
    // Navigate back to the Single/Multiple selection page
    window.location.href = '/personnel/add';
}

function resetCvSession() {
    // Start a new session effect: clear any staged files and reload the step to initial state
    cvFile = null;
    portraitFile = null;
    healthFile = null;
    idCardFile = null;
    passportFile = null;
    document.getElementById('cvFileInput').value = '';
    document.getElementById('cvPreview').src = '';
    document.getElementById('uploadArea').classList.remove('hidden');
    document.getElementById('previewArea').classList.add('hidden');
    const resetBtn = document.getElementById('resetSessionBtn');
    if (resetBtn) resetBtn.classList.add('hidden');
    showMessage('Session reset. No CV on file.', 'info');
}

// Validation functions
function validateForm() {
    console.log('validateForm() called');
    let isValid = true;
    const requiredFields = [
        { name: 'full_name', message: 'Full name' },
        { name: 'gender', message: 'Gender' },
        { name: 'date_of_birth', message: 'Date of birth' },
        { name: 'place_of_birth', message: 'Place of birth' },
        { name: 'hometown', message: 'Hometown' },
        { name: 'personal_phone', message: 'Personal phone number' },
        { name: 'personal_email', message: 'Personal email' },
        { name: 'id_card_number', message: 'ID card number' },
        { name: 'id_card_issue_date', message: 'ID card issue date' },
        { name: 'id_card_issue_place', message: 'ID card issue place' }
    ];

    requiredFields.forEach(field => {
        const input = document.querySelector(`[name="${field.name}"]`);
        const formGroup = input.closest('.form-group');
        console.log(`Validating field: ${field.name}, input found:`, !!input, 'value:', input ? input.value : 'N/A');
        
        if (field.name === 'gender') {
            // Handle radio buttons
            const checked = document.querySelector(`[name="${field.name}"]:checked`);
            console.log(`Gender field checked:`, !!checked);
            if (!checked) {
                showFieldError(formGroup, field.message);
                isValid = false;
            }
        } else {
            // Handle text inputs
            if (!input.value.trim()) {
                console.log(`Field ${field.name} is empty`);
                showFieldError(formGroup, field.message);
                isValid = false;
            }
        }
    });

    console.log('Validation result:', isValid);
    return isValid;
}

function showFieldError(formGroup, fieldName) {
    formGroup.classList.add('error');
    const input = formGroup.querySelector('.form-control');
    if (input) {
        input.classList.add('error');
    }
}

function clearValidation() {
    // Clear all error states
    document.querySelectorAll('.form-group.error').forEach(group => {
        group.classList.remove('error');
    });
    document.querySelectorAll('.form-control.error').forEach(input => {
        input.classList.remove('error');
    });
    
    // Hide validation summary
    document.getElementById('validationSummary').classList.remove('show');
}

function showValidationSummary() {
    const validationSummary = document.getElementById('validationSummary');
    const errorsList = document.getElementById('validationErrors');
    
    // Get all error fields
    const errorFields = document.querySelectorAll('.form-group.error');
    const errorMessages = Array.from(errorFields).map(group => {
        const fieldName = group.querySelector('label').textContent.replace(' (*)', '');
        return `<li>${fieldName}</li>`;
    });
    
    errorsList.innerHTML = errorMessages.join('');
    validationSummary.classList.add('show');
    
    // Scroll to validation summary
    validationSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Prefill only empty inputs so the user can still edit
function prefillFromExtractedData(data) {
    if (!data) return;
    const form = document.getElementById('personalInfoForm');
    Object.entries(data).forEach(([key, value]) => {
        const elements = form.querySelectorAll(`[name="${key}"]`);
        if (!elements.length) return;
        elements.forEach(el => {
            if (el.type === 'radio') {
                if (!form.querySelector(`[name="${key}"]:checked`) && (el.value === String(value).toLowerCase())) {
                    el.checked = true;
                }
            } else if (el.tagName === 'SELECT' || el.tagName === 'TEXTAREA' || el.type === 'text' || el.type === 'email' || el.type === 'tel') {
                if (!el.value) {
                    el.value = value;
                }
            }
        });
    });
}

// Function to convert file to base64
// CV Evaluation function
async function evaluateCV() {
    if (!cvFile) {
        showMessage('Please upload a CV first', 'error');
        return;
    }
    
    const evaluateBtn = document.getElementById('evaluateCvBtn');
    const originalText = evaluateBtn.innerHTML;
    evaluateBtn.disabled = true;
    evaluateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing CV...';
    
    try {
        showMessage('Evaluating CV for Development department...', 'info');
        const b64 = await fileToBase64(cvFile);
        
        const response = await fetch('/personnel/api/evaluate-cv', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                files: [b64],
                department: 'Development'
            })
        });
        
        const result = await response.json();
        
        if (result && result.success && result.evaluation) {
            displayEvaluationResults(result.evaluation);
            showMessage('CV evaluation completed!', 'success');
        } else {
            const errorMsg = result && result.error ? result.error : 'Failed to evaluate CV';
            showMessage(`Evaluation failed: ${errorMsg}`, 'error');
        }
    } catch (error) {
        console.error('CV evaluation error:', error);
        showMessage('Error evaluating CV. Please try again.', 'error');
    } finally {
        evaluateBtn.disabled = false;
        evaluateBtn.innerHTML = originalText;
    }
}

function displayEvaluationResults(evaluation) {
    const resultsDiv = document.getElementById('evaluationResults');
    const contentDiv = document.getElementById('evaluationContent');
    
    if (!resultsDiv || !contentDiv) return;
    
    const suitable = evaluation.suitable;
    const overallScore = evaluation.overall_score;
    const scores = evaluation.scores || {};
    const strengths = evaluation.strengths || [];
    const weaknesses = evaluation.weaknesses || [];
    const recommendation = evaluation.recommendation || 'No recommendation provided';
    const keySkills = evaluation.key_skills_found || [];
    const missingSkills = evaluation.missing_skills || [];
    
    // Determine color based on suitability
    const statusColor = suitable ? '#28a745' : '#dc3545';
    const statusIcon = suitable ? 'fa-check-circle' : 'fa-times-circle';
    const statusText = suitable ? 'Suitable' : 'Not Suitable';
    
    contentDiv.innerHTML = `
        <div style="margin-bottom: 20px;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                <i class="fas ${statusIcon}" style="color: ${statusColor}; font-size: 24px;"></i>
                <h4 style="margin: 0; color: ${statusColor};">
                    ${statusText} for ${evaluation.department} Department
                </h4>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <div style="text-align: center;">
                    <div style="font-size: 36px; font-weight: bold; color: ${statusColor};">
                        ${overallScore.toFixed(1)}/10
                    </div>
                    <div style="color: #666; margin-top: 5px;">Overall Score</div>
                </div>
            </div>
        </div>
        
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px;">
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #667eea;">
                    ${scores.technical_skills?.toFixed(1) || '0'}/10
                </div>
                <div style="color: #666; font-size: 12px; margin-top: 5px;">Technical Skills</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #667eea;">
                    ${scores.experience_relevance?.toFixed(1) || '0'}/10
                </div>
                <div style="color: #666; font-size: 12px; margin-top: 5px;">Experience</div>
            </div>
            <div style="background: white; padding: 15px; border-radius: 8px; text-align: center;">
                <div style="font-size: 24px; font-weight: bold; color: #667eea;">
                    ${scores.education_background?.toFixed(1) || '0'}/10
                </div>
                <div style="color: #666; font-size: 12px; margin-top: 5px;">Education</div>
            </div>
        </div>
        
        ${strengths.length > 0 ? `
        <div style="margin-bottom: 15px;">
            <h5 style="color: #28a745; margin-bottom: 10px;">
                <i class="fas fa-check-circle"></i> Strengths
            </h5>
            <ul style="margin: 0; padding-left: 20px; color: #333;">
                ${strengths.map(s => `<li>${s}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        ${weaknesses.length > 0 ? `
        <div style="margin-bottom: 15px;">
            <h5 style="color: #dc3545; margin-bottom: 10px;">
                <i class="fas fa-exclamation-circle"></i> Areas for Improvement
            </h5>
            <ul style="margin: 0; padding-left: 20px; color: #333;">
                ${weaknesses.map(w => `<li>${w}</li>`).join('')}
            </ul>
        </div>
        ` : ''}
        
        ${keySkills.length > 0 ? `
        <div style="margin-bottom: 15px;">
            <h5 style="color: #667eea; margin-bottom: 10px;">
                <i class="fas fa-star"></i> Key Skills Found
            </h5>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${keySkills.map(skill => `
                    <span style="background: #e3f2fd; color: #1976d2; padding: 5px 12px; border-radius: 20px; font-size: 12px;">
                        ${skill}
                    </span>
                `).join('')}
            </div>
        </div>
        ` : ''}
        
        ${missingSkills.length > 0 ? `
        <div style="margin-bottom: 15px;">
            <h5 style="color: #ff9800; margin-bottom: 10px;">
                <i class="fas fa-exclamation-triangle"></i> Missing Skills
            </h5>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                ${missingSkills.map(skill => `
                    <span style="background: #fff3e0; color: #f57c00; padding: 5px 12px; border-radius: 20px; font-size: 12px;">
                        ${skill}
                    </span>
                `).join('')}
            </div>
        </div>
        ` : ''}
        
        <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
            <h5 style="color: #2c3e50; margin-bottom: 10px;">
                <i class="fas fa-comment-dots"></i> Recommendation
            </h5>
            <p style="margin: 0; color: #333; line-height: 1.6;">
                ${recommendation}
            </p>
        </div>
    `;
    
    resultsDiv.classList.remove('hidden');
    resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// Message display functions
function showMessage(message, type) {
    console.log(`Message (${type}): ${message}`);
    
    // Create or update message element
    let messageElement = document.getElementById('messageContainer');
    if (!messageElement) {
        messageElement = document.createElement('div');
        messageElement.id = 'messageContainer';
        messageElement.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        `;
        document.body.appendChild(messageElement);
    }
    
    // Set message content and style
    messageElement.textContent = message;
    if (type === 'success') {
        messageElement.style.backgroundColor = '#28a745';
    } else if (type === 'error') {
        messageElement.style.backgroundColor = '#dc3545';
    } else {
        messageElement.style.backgroundColor = '#007bff';
    }
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (messageElement) {
            messageElement.remove();
        }
    }, 5000);
}

function hideMessages() {
    const messageElement = document.getElementById('messageContainer');
    if (messageElement) {
        messageElement.remove();
    }
}

function showLoading(show) {
    console.log('Loading:', show);
    // You can add a loading spinner here if needed
}

// Function to reset form and return to CV upload phase
function resetFormAndReturnToCVUpload() {
    console.log('Resetting form and returning to CV upload phase');
    
    // Reset form
    document.getElementById('personalInfoForm').reset();
    
    // Reset file variables
    cvFile = null;
    portraitFile = null;
    healthFile = null;
    idCardFile = null;
    passportFile = null;
    
    // Reset previews
    updatePortraitPreview(null);
    document.getElementById('uploadArea').classList.remove('hidden');
    document.getElementById('previewArea').classList.add('hidden');
    
    // Return to step 1 (CV upload phase)
    currentStep = 1;
    document.getElementById('step1').classList.add('active');
    document.getElementById('step1').classList.remove('completed');
    document.getElementById('step2').classList.remove('active');
    
    document.getElementById('cvUploadStep').classList.remove('hidden');
    document.getElementById('personalInfoStep').classList.add('hidden');
    
    // Reset CV upload area
    document.getElementById('cvFileInput').value = '';
    document.getElementById('cvPreview').src = '';
    document.getElementById('uploadArea').classList.remove('hidden');
    document.getElementById('previewArea').classList.add('hidden');
    
    // Clear account information fields
    const accountEmailInput = document.getElementById('account_email');
    const accountPasswordInput = document.getElementById('account_password');
    if (accountEmailInput) accountEmailInput.value = '';
    if (accountPasswordInput) accountPasswordInput.value = '';
    
    // Hide password strength indicator
    const passwordStrengthDiv = document.getElementById('passwordStrength');
    if (passwordStrengthDiv) passwordStrengthDiv.style.display = 'none';
    
    // Clear any validation errors
    clearValidation();
    
    console.log('Form reset and returned to CV upload phase');
}

// Function to save/update employee data to database
async function submitEmployeeData() {
    try {
        console.log('submitEmployeeData() function called');
        showLoading(true);
        hideMessages();
        
        // Collect form data
        const formData = new FormData(document.getElementById('personalInfoForm'));
        const employeeData = {};
        
        // Convert FormData to object
        for (let [key, value] of formData.entries()) {
            employeeData[key] = value;
        }
        console.log('Collected form data:', employeeData);
        
        const fileFieldNames = ['cv_file', 'portrait_file', 'health_file', 'id_card_file', 'passport_file'];
        fileFieldNames.forEach(name => {
            delete employeeData[name];
        });

        // Handle file uploads (only add when present)
        const fileConversions = [];
        if (cvFile) {
            fileConversions.push(fileToBase64(cvFile).then(result => {
                employeeData.cv_file = result;
            }));
        }
        if (portraitFile) {
            fileConversions.push(fileToBase64(portraitFile).then(result => {
                employeeData.portrait_file = result;
            }));
        }
        if (healthFile) {
            fileConversions.push(fileToBase64(healthFile).then(result => {
                employeeData.health_file = result;
            }));
        }
        if (idCardFile) {
            fileConversions.push(fileToBase64(idCardFile).then(result => {
                employeeData.id_card_file = result;
            }));
        }
        if (passportFile) {
            fileConversions.push(fileToBase64(passportFile).then(result => {
                employeeData.passport_file = result;
            }));
        }

        await Promise.all(fileConversions);

        // Handle account information (email and password)
        const accountEmail = document.getElementById('account_email')?.value?.trim();
        const accountPassword = document.getElementById('account_password')?.value?.trim();
        
        if (accountEmail) {
            if (!accountPassword) {
                showMessage('Password is required when email is provided', 'error');
                showLoading(false);
                return;
            }
            employeeData.account_email = accountEmail;
            employeeData.account_password = accountPassword;
        }

        // Send data to backend
        console.log('Sending data to API:', employeeData);
        const url = IS_EDIT_MODE ? `/personnel/api/employee/${EMPLOYEE_ID}` : '/personnel/api/employee';
        const method = IS_EDIT_MODE ? 'PUT' : 'POST';
        const response = await fetch(url, {
            method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(employeeData)
        });
        
        console.log('API response status:', response.status);
        const result = await response.json();
        console.log('API response data:', result);
        
        if (result.success) {
            showMessage(result.message, 'success');
            if (IS_EDIT_MODE) {
                setTimeout(() => {
                    window.location.href = '/personnel/list';
                }, 1500);
            } else {
                // Reset form and return to CV upload phase after successful submission
                setTimeout(() => {
                    resetFormAndReturnToCVUpload();
                }, 2000);
            }
        } else {
            showMessage(`Error: ${result.error}`, 'error');
        }
        
    } catch (error) {
        console.error('Error submitting employee data:', error);
        showMessage(`Failed to submit employee data: ${error.message}`, 'error');
    } finally {
        showLoading(false);
    }
}

// Password generation function
function generatePassword() {
    const length = 16;
    const charset = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';
    let password = '';
    
    // Ensure at least one of each type
    password += 'abcdefghijklmnopqrstuvwxyz'[Math.floor(Math.random() * 26)];
    password += 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'[Math.floor(Math.random() * 26)];
    password += '0123456789'[Math.floor(Math.random() * 10)];
    password += '!@#$%^&*()_+-=[]{}|;:,.<>?'[Math.floor(Math.random() * 26)];
    
    // Fill the rest
    for (let i = password.length; i < length; i++) {
        password += charset[Math.floor(Math.random() * charset.length)];
    }
    
    // Shuffle the password
    password = password.split('').sort(() => Math.random() - 0.5).join('');
    
    // Set password and trigger strength check
    const passwordInput = document.getElementById('account_password');
    if (passwordInput) {
        passwordInput.value = password;
        passwordInput.type = 'text'; // Show generated password
        checkPasswordStrength(password);
        
        // Hide after 3 seconds
        setTimeout(() => {
            passwordInput.type = 'password';
        }, 3000);
    }
}

// Password strength checking
function checkPasswordStrength(password) {
    const strengthDiv = document.getElementById('passwordStrength');
    const strengthFill = document.getElementById('passwordStrengthFill');
    const strengthText = document.getElementById('passwordStrengthText');
    
    if (!strengthDiv || !strengthFill || !strengthText) return;
    
    if (!password || password.length === 0) {
        strengthDiv.style.display = 'none';
        return;
    }
    
    strengthDiv.style.display = 'block';
    
    let strength = 0;
    let feedback = [];
    
    // Length check
    if (password.length >= 8) strength += 1;
    else feedback.push('At least 8 characters');
    
    if (password.length >= 12) strength += 1;
    
    // Character type checks
    if (/[a-z]/.test(password)) strength += 1;
    else feedback.push('lowercase letters');
    
    if (/[A-Z]/.test(password)) strength += 1;
    else feedback.push('uppercase letters');
    
    if (/[0-9]/.test(password)) strength += 1;
    else feedback.push('numbers');
    
    if (/[^a-zA-Z0-9]/.test(password)) strength += 1;
    else feedback.push('special characters');
    
    // Calculate percentage
    const percentage = (strength / 6) * 100;
    
    // Update visual indicator
    strengthFill.style.width = percentage + '%';
    
    // Set color and text
    if (strength <= 2) {
        strengthFill.style.background = '#dc3545'; // Red
        strengthText.textContent = 'Weak' + (feedback.length > 0 ? ' - Add: ' + feedback.join(', ') : '');
        strengthText.style.color = '#dc3545';
    } else if (strength <= 4) {
        strengthFill.style.background = '#ffc107'; // Yellow
        strengthText.textContent = 'Medium' + (feedback.length > 0 ? ' - Consider adding: ' + feedback.join(', ') : '');
        strengthText.style.color = '#856404';
    } else {
        strengthFill.style.background = '#28a745'; // Green
        strengthText.textContent = 'Strong password!';
        strengthText.style.color = '#155724';
    }
}

// Add event listener for password strength checking
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('account_password');
    if (passwordInput) {
        passwordInput.addEventListener('input', function(e) {
            checkPasswordStrength(e.target.value);
        });
    }
    
    // Validate account information before submission
    const accountEmailInput = document.getElementById('account_email');
    if (accountEmailInput) {
        accountEmailInput.addEventListener('blur', function() {
            const email = this.value.trim();
            const password = document.getElementById('account_password')?.value?.trim();
            
            if (email && !password) {
                document.getElementById('account_password').focus();
            }
        });
    }
});
</script>
{% endblock %}
