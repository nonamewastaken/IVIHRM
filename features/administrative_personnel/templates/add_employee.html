{% extends "base.html" %}

{% block title %}{{ 'Edit Employee' if mode == 'edit' else 'Add Employee' }} - HRM System{% endblock %}

{% block page_title %}
    <i class="fas {{ 'fa-user-edit' if mode == 'edit' else 'fa-user-plus' }}"></i>
    {{ 'Edit Employee' if mode == 'edit' else 'Add Employee' }}
{% endblock %}

{% block extra_css %}
<style>
    .personnel-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .personnel-card {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .form-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        background: #fafafa;
    }

    .section-header {
        background: #f5f5f5;
        padding: 10px 15px;
        margin: -20px -20px 20px -20px;
        border-radius: 8px 8px 0 0;
        font-weight: bold;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        flex: 1;
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }

    .form-group label.required::after {
        content: " (*)";
        color: #e74c3c;
        font-weight: bold;
    }

    .form-control.error {
        border-color: #e74c3c;
        box-shadow: 0 0 0 2px rgba(231, 76, 60, 0.25);
    }

    .error-message {
        color: #e74c3c;
        font-size: 12px;
        margin-top: 5px;
        display: none;
    }

    .form-group.error .error-message {
        display: block;
    }

    .validation-summary {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        display: none;
    }

    .validation-summary.show {
        display: block;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }

    .radio-group {
        display: flex;
        gap: 20px;
        margin-top: 5px;
    }

    .radio-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .radio-item input[type="radio"] {
        margin: 0;
    }

    .upload-section {
        text-align: center;
        padding: 30px;
        border: 2px dashed #ddd;
        border-radius: 8px;
        background: #f9f9f9;
    }

    .upload-preview {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #ddd;
        margin: 15px auto;
        display: block;
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-success:hover {
        background: #1e7e34;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
    }

    .btn-upload {
        background: #28a745;
        color: white;
        padding: 8px 16px;
        font-size: 12px;
    }

    .btn-upload:hover {
        background: #1e7e34;
    }

    .hidden {
        display: none;
    }

    .form-actions {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e0e0e0;
    }

    .step-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
    }

    .step {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        background: #f8f9fa;
        border-radius: 25px;
        margin: 0 10px;
    }

    .step.active {
        background: #007bff;
        color: white;
    }

    .step.completed {
        background: #28a745;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
    <div class="personnel-container">
        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step" id="step1">
                <i class="fas fa-upload"></i>
                <span>Upload CV</span>
            </div>
            <div class="step" id="step2">
                <i class="fas fa-user"></i>
                <span>Personal Info</span>
            </div>
        </div>

        <!-- Step 1: CV Upload -->
        <div class="personnel-card" id="cvUploadStep">
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">
                <i class="fas fa-upload"></i> Upload CV Image
            </h2>
            
            <div class="upload-section">
                <div id="uploadArea">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 48px; color: #ddd; margin-bottom: 15px;"></i>
                    <h4>Upload CV Image</h4>
                    <p>You can upload a CV image or skip this step</p>
                    <input type="file" id="cvFileInput" accept="image/*" style="display: none;">
                    <button class="btn btn-upload" onclick="document.getElementById('cvFileInput').click()">
                        <i class="fas fa-upload"></i> Upload
                    </button>
                </div>
                
                <div id="previewArea" class="hidden">
                    <img id="cvPreview" class="upload-preview" src="" alt="CV Preview">
                    <p>CV Image Uploaded</p>
                    <button class="btn btn-secondary" onclick="removeCV()">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
            </div>
            
            <div class="form-actions">
                <button class="btn btn-primary" onclick="nextStep()">
                    <i class="fas fa-arrow-right"></i> Tiếp tục
                </button>
            </div>
        </div>

        <!-- Step 2: Personal Information Form -->
        <div class="personnel-card hidden" id="personalInfoStep">
            <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">
                <i class="fas fa-user"></i> Thông tin bản thân
            </h2>
            
            <form id="personalInfoForm">
                <!-- Validation Summary -->
                <div id="validationSummary" class="validation-summary">
                    <strong><i class="fas fa-exclamation-triangle"></i> Vui lòng điền đầy đủ thông tin bắt buộc:</strong>
                    <ul id="validationErrors"></ul>
                </div>
                
                <!-- Personal Information Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-user"></i>
                        <span>THÔNG TIN BẢN THÂN</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Ảnh chân dung</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button type="button" class="btn btn-upload" onclick="document.getElementById('portraitFileInput').click()">
                                    <i class="fas fa-upload"></i> Upload
                                </button>
                                <input type="file" id="portraitFileInput" accept="image/*" style="display: none;">
                                <div id="portraitPreview" style="width: 60px; height: 60px; border-radius: 50%; background: #f0f0f0; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user" style="color: #999;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Họ và tên</label>
                            <input type="text" class="form-control" name="full_name" placeholder="Họ và tên đầy đủ">
                            <div class="error-message">Vui lòng nhập họ và tên</div>
                        </div>
                        <div class="form-group">
                            <label class="required">Giới tính</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" name="gender" value="male" id="gender_male">
                                    <label for="gender_male">Nam</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" name="gender" value="female" id="gender_female">
                                    <label for="gender_female">Nữ</label>
                                </div>
                            </div>
                            <div class="error-message">Vui lòng chọn giới tính</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Ngày sinh</label>
                            <input type="text" class="form-control" name="date_of_birth" placeholder="dd/mm/yyyy">
                            <div class="error-message">Vui lòng nhập ngày sinh</div>
                        </div>
                        <div class="form-group">
                            <label class="required">Nơi sinh</label>
                            <input type="text" class="form-control" name="place_of_birth" placeholder="Nhập nơi sinh">
                            <div class="error-message">Vui lòng nhập nơi sinh</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Quê quán</label>
                            <input type="text" class="form-control" name="hometown" placeholder="Nhập quê quán">
                            <div class="error-message">Vui lòng nhập quê quán</div>
                        </div>
                        <div class="form-group">
                            <label>Tình trạng hôn nhân</label>
                            <div class="radio-group">
                                <div class="radio-item">
                                    <input type="radio" name="marital_status" value="single" id="marital_single">
                                    <label for="marital_single">Độc thân</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" name="marital_status" value="married" id="marital_married">
                                    <label for="marital_married">Kết hôn</label>
                                </div>
                                <div class="radio-item">
                                    <input type="radio" name="marital_status" value="other" id="marital_other">
                                    <label for="marital_other">Khác</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Dân tộc</label>
                            <input type="text" class="form-control" name="ethnicity" placeholder="Nhập dân tộc">
                        </div>
                        <div class="form-group">
                            <label>Tôn giáo</label>
                            <input type="text" class="form-control" name="religion" placeholder="Nhập tôn giáo">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>MST cá nhân</label>
                            <input type="text" class="form-control" name="personal_tax_code" placeholder="Nhập mã số thuế cá nhân">
                        </div>
                        <div class="form-group">
                            <label>Mã BHXH</label>
                            <input type="text" class="form-control" name="social_insurance_code" placeholder="Nhập mã bảo hiểm xã hội">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Số đt cá nhân</label>
                            <input type="tel" class="form-control" name="personal_phone" placeholder="Nhập số điện thoại cá nhân">
                            <div class="error-message">Vui lòng nhập số điện thoại cá nhân</div>
                        </div>
                        <div class="form-group">
                            <label class="required">Email cá nhân</label>
                            <input type="email" class="form-control" name="personal_email" placeholder="Nhập email cá nhân">
                            <div class="error-message">Vui lòng nhập email cá nhân</div>
                        </div>
                    </div>
                    
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ngày vào đảng</label>
                            <input type="text" class="form-control" name="party_join_date" placeholder="dd/mm/yyyy">
                        </div>
                        <div class="form-group">
                            <label>Nơi kết nạp</label>
                            <input type="text" class="form-control" name="party_join_place" placeholder="Nhập nơi kết nạp">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tình trạng sức khỏe</label>
                            <select class="form-control" name="health_status">
                                <option value="">Chọn tình trạng sức khỏe</option>
                                <option value="excellent">Tốt</option>
                                <option value="good">Khá tốt</option>
                                <option value="fair">Trung bình</option>
                                <option value="poor">Kém</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Giấy khám SK</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button type="button" class="btn btn-upload" onclick="document.getElementById('healthFileInput').click()">
                                    <i class="fas fa-upload"></i> Upload
                                </button>
                                <input type="file" id="healthFileInput" accept="image/*" style="display: none;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Số liên hệ khẩn cấp (tên + số)</label>
                            <input type="text" class="form-control" name="emergency_contact" placeholder="Tên và số điện thoại liên hệ khẩn cấp">
                        </div>
                    </div>
                </div>

                <!-- Address Information Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-home"></i>
                        <span>HỘ KHẨU THƯỜNG TRÚ & NƠI Ở HIỆN TẠI</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label><strong>Hộ khẩu thường trú VD: "144 Phường Nghĩa Đô, Thành phố Hà Nội"</strong></label>
                            <textarea class="form-control" name="permanent_address" rows="3" placeholder="Nhập địa chỉ thường trú"></textarea>
                        </div>
                        <div class="form-group">
                            <label><strong>Nơi ở hiện tại VD: "144 Phường Nghĩa Đô, Thành phố Hà Nội"</strong></label>
                            <textarea class="form-control" name="current_address" rows="3" placeholder="Nhập địa chỉ hiện tại"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tỉnh/Thành phố</label>
                            <select class="form-control" name="permanent_province">
                                <option value="">Chọn Tỉnh/Thành phố</option>
                                <option value="hanoi">Hà Nội</option>
                                <option value="hcm">TP. Hồ Chí Minh</option>
                                <option value="danang">Đà Nẵng</option>
                                <option value="haiphong">Hải Phòng</option>
                                <option value="cantho">Cần Thơ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Tỉnh/Thành phố</label>
                            <select class="form-control" name="current_province">
                                <option value="">Chọn Tỉnh/Thành phố</option>
                                <option value="hanoi">Hà Nội</option>
                                <option value="hcm">TP. Hồ Chí Minh</option>
                                <option value="danang">Đà Nẵng</option>
                                <option value="haiphong">Hải Phòng</option>
                                <option value="cantho">Cần Thơ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phường/Xã/Thị trấn</label>
                            <select class="form-control" name="permanent_ward">
                                <option value="">Chọn Phường/Xã/Thị trấn</option>
                                <option value="nghia_do">Nghĩa Đô</option>
                                <option value="cau_giay">Cầu Giấy</option>
                                <option value="dong_da">Đống Đa</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Phường/Xã/Thị trấn</label>
                            <select class="form-control" name="current_ward">
                                <option value="">Chọn Phường/Xã/Thị trấn</option>
                                <option value="nghia_do">Nghĩa Đô</option>
                                <option value="cau_giay">Cầu Giấy</option>
                                <option value="dong_da">Đống Đa</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Số nhà, đường/xóm</label>
                            <input type="text" class="form-control" name="permanent_street" placeholder="Nhập số nhà, đường/xóm">
                        </div>
                        <div class="form-group">
                            <label>Số nhà, đường/xóm</label>
                            <input type="text" class="form-control" name="current_street" placeholder="Nhập số nhà, đường/xóm">
                        </div>
                    </div>
                </div>

                <!-- ID Card & Passport Section -->
                <div class="form-section">
                    <div class="section-header">
                        <i class="fas fa-id-card"></i>
                        <span>CĂN CƯỚC & HỘ CHIẾU</span>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required"><strong>Số CCCD</strong></label>
                            <input type="text" class="form-control" name="id_card_number" placeholder="Nhập số căn cước công dân">
                            <div class="error-message">Vui lòng nhập số căn cước công dân</div>
                        </div>
                        <div class="form-group">
                            <label><strong>Số Hộ chiếu</strong></label>
                            <input type="text" class="form-control" name="passport_number" placeholder="Nhập số hộ chiếu">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Ngày cấp</label>
                            <input type="text" class="form-control" name="id_card_issue_date" placeholder="dd/mm/yyyy">
                            <div class="error-message">Vui lòng nhập ngày cấp CCCD</div>
                        </div>
                        <div class="form-group">
                            <label>Ngày cấp</label>
                            <input type="text" class="form-control" name="passport_issue_date" placeholder="dd/mm/yyyy">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ngày hết hạn</label>
                            <input type="text" class="form-control" name="id_card_expiry_date" placeholder="dd/mm/yyyy">
                        </div>
                        <div class="form-group">
                            <label>Ngày hết hạn</label>
                            <input type="text" class="form-control" name="passport_expiry_date" placeholder="dd/mm/yyyy">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="required">Nơi cấp</label>
                            <input type="text" class="form-control" name="id_card_issue_place" placeholder="Nhập nơi cấp CCCD">
                            <div class="error-message">Vui lòng nhập nơi cấp CCCD</div>
                        </div>
                        <div class="form-group">
                            <label>Nơi cấp</label>
                            <input type="text" class="form-control" name="passport_issue_place" placeholder="Nhập nơi cấp hộ chiếu">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Đính kèm (2 mặt)</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button type="button" class="btn btn-upload" onclick="document.getElementById('idCardFileInput').click()">
                                    <i class="fas fa-upload"></i> Upload
                                </button>
                                <input type="file" id="idCardFileInput" accept="image/*" style="display: none;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Đính kèm (2 mặt)</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <button type="button" class="btn btn-upload" onclick="document.getElementById('passportFileInput').click()">
                                    <i class="fas fa-upload"></i> Upload
                                </button>
                                <input type="file" id="passportFileInput" accept="image/*" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="prevStep()">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </button>
                    <button type="submit" class="btn btn-success" onclick="handleFormSubmission(); return false;">
                        <i class="fas fa-check"></i> Hoàn thành
                    </button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script type="application/json" id="initialEmployeeData">
{{ employee_data|default({})|tojson }}
</script>
<script>
const PAGE_MODE = "{{ mode|default('add') }}";
const IS_EDIT_MODE = PAGE_MODE === 'edit';
const EMPLOYEE_ID = "{{ employee_id if employee_id is not none else '' }}";
const initialEmployeeDataScript = document.getElementById('initialEmployeeData');
const INITIAL_EMPLOYEE_DATA = initialEmployeeDataScript ? JSON.parse(initialEmployeeDataScript.textContent || '{}') : {};

let currentStep = 1;
let cvFile = null;
let portraitFile = null;
let healthFile = null;
let idCardFile = null;
let passportFile = null;

document.addEventListener('DOMContentLoaded', function() {
    const activeNavHref = IS_EDIT_MODE ? '/personnel/list' : '/personnel/add';
    setActiveSidebarItem(activeNavHref);
    // Sidebar is handled by main sidebar component

    if (IS_EDIT_MODE) {
        initializeEditMode();
    }
    
    // CV Upload functionality
    document.getElementById('cvFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            cvFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('cvPreview').src = e.target.result;
                document.getElementById('uploadArea').classList.add('hidden');
                document.getElementById('previewArea').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Portrait upload functionality
    document.getElementById('portraitFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            portraitFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                updatePortraitPreview(e.target.result);
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Health file upload functionality
    document.getElementById('healthFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            healthFile = file;
        }
    });
    
    // ID Card file upload functionality
    document.getElementById('idCardFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            idCardFile = file;
        }
    });
    
    // Passport file upload functionality
    document.getElementById('passportFileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            passportFile = file;
        }
    });
    
    // Form submission using event delegation
    document.addEventListener('submit', function(e) {
        if (e.target.id === 'personalInfoForm') {
            e.preventDefault();
            console.log('Form submit event triggered');
            handleFormSubmission();
        }
    });
    
    // Also add click event listener to the submit button as backup
    document.addEventListener('click', function(e) {
        console.log('Click detected on:', e.target);
        if (e.target.closest('button[type="submit"]') && e.target.closest('#personalInfoForm')) {
            e.preventDefault();
            console.log('Submit button clicked - calling handleFormSubmission()');
            handleFormSubmission();
        }
    });
    
    // Function to handle form submission
    function handleFormSubmission() {
        console.log('handleFormSubmission() called');
        
        // Clear previous validation
        clearValidation();
        
        // Validate form
        const isValid = validateForm();
        console.log('Form validation result:', isValid);
        
        if (isValid) {
            console.log('Form is valid, calling submitEmployeeData()');
            submitEmployeeData();
        } else {
            console.log('Form is invalid, showing validation summary');
            showValidationSummary();
        }
    }
});

function initializeEditMode() {
    console.log('initializeEditMode() called');

    currentStep = 2;
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const cvStep = document.getElementById('cvUploadStep');
    const personalStep = document.getElementById('personalInfoStep');

    if (step1 && step2 && cvStep && personalStep) {
        step1.classList.remove('active');
        step1.classList.add('completed');
        step2.classList.add('active');
        cvStep.classList.add('hidden');
        personalStep.classList.remove('hidden');
    }

    populateFormWithEmployeeData(INITIAL_EMPLOYEE_DATA || {});

    if (INITIAL_EMPLOYEE_DATA && INITIAL_EMPLOYEE_DATA.portrait_file) {
        updatePortraitPreview(INITIAL_EMPLOYEE_DATA.portrait_file);
    }
}

function populateFormWithEmployeeData(data) {
    if (!data) {
        return;
    }

    const form = document.getElementById('personalInfoForm');
    Object.entries(data).forEach(([key, rawValue]) => {
        let value = rawValue;
        if (value === null || typeof value === 'undefined') {
            value = '';
        }

        const elements = form.querySelectorAll(`[name="${key}"]`);
        if (!elements.length) {
            return;
        }

        elements.forEach(element => {
            if (element.type === 'radio') {
                element.checked = element.value === value;
            } else if (element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') {
                element.value = value;
            } else if (element.type === 'checkbox') {
                element.checked = value === true || value === 'true';
            } else {
                element.value = value;
            }
        });
    });
}

function updatePortraitPreview(source) {
    const preview = document.getElementById('portraitPreview');
    if (!preview) {
        return;
    }

    if (source) {
        preview.innerHTML = `<img src="${source}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
    } else {
        preview.innerHTML = '<i class="fas fa-user" style="color: #999;"></i>';
    }
}

function nextStep() {
    console.log('nextStep() called');
    currentStep = 2;
    document.getElementById('step1').classList.remove('active');
    document.getElementById('step1').classList.add('completed');
    document.getElementById('step2').classList.add('active');
    
    document.getElementById('cvUploadStep').classList.add('hidden');
    document.getElementById('personalInfoStep').classList.remove('hidden');
    
    console.log('Form should now be visible');
    console.log('Form element:', document.getElementById('personalInfoForm'));
}

function prevStep() {
    currentStep = 1;
    document.getElementById('step2').classList.remove('active');
    document.getElementById('step1').classList.remove('completed');
    document.getElementById('step1').classList.add('active');
    
    document.getElementById('personalInfoStep').classList.add('hidden');
    document.getElementById('cvUploadStep').classList.remove('hidden');
}

function removeCV() {
    cvFile = null;
    document.getElementById('cvFileInput').value = '';
    document.getElementById('uploadArea').classList.remove('hidden');
    document.getElementById('previewArea').classList.add('hidden');
}

// Validation functions
function validateForm() {
    console.log('validateForm() called');
    let isValid = true;
    const requiredFields = [
        { name: 'full_name', message: 'Họ và tên' },
        { name: 'gender', message: 'Giới tính' },
        { name: 'date_of_birth', message: 'Ngày sinh' },
        { name: 'place_of_birth', message: 'Nơi sinh' },
        { name: 'hometown', message: 'Quê quán' },
        { name: 'personal_phone', message: 'Số điện thoại cá nhân' },
        { name: 'personal_email', message: 'Email cá nhân' },
        { name: 'id_card_number', message: 'Số căn cước công dân' },
        { name: 'id_card_issue_date', message: 'Ngày cấp CCCD' },
        { name: 'id_card_issue_place', message: 'Nơi cấp CCCD' }
    ];

    requiredFields.forEach(field => {
        const input = document.querySelector(`[name="${field.name}"]`);
        const formGroup = input.closest('.form-group');
        console.log(`Validating field: ${field.name}, input found:`, !!input, 'value:', input ? input.value : 'N/A');
        
        if (field.name === 'gender') {
            // Handle radio buttons
            const checked = document.querySelector(`[name="${field.name}"]:checked`);
            console.log(`Gender field checked:`, !!checked);
            if (!checked) {
                showFieldError(formGroup, field.message);
                isValid = false;
            }
        } else {
            // Handle text inputs
            if (!input.value.trim()) {
                console.log(`Field ${field.name} is empty`);
                showFieldError(formGroup, field.message);
                isValid = false;
            }
        }
    });

    console.log('Validation result:', isValid);
    return isValid;
}

function showFieldError(formGroup, fieldName) {
    formGroup.classList.add('error');
    const input = formGroup.querySelector('.form-control');
    if (input) {
        input.classList.add('error');
    }
}

function clearValidation() {
    // Clear all error states
    document.querySelectorAll('.form-group.error').forEach(group => {
        group.classList.remove('error');
    });
    document.querySelectorAll('.form-control.error').forEach(input => {
        input.classList.remove('error');
    });
    
    // Hide validation summary
    document.getElementById('validationSummary').classList.remove('show');
}

function showValidationSummary() {
    const validationSummary = document.getElementById('validationSummary');
    const errorsList = document.getElementById('validationErrors');
    
    // Get all error fields
    const errorFields = document.querySelectorAll('.form-group.error');
    const errorMessages = Array.from(errorFields).map(group => {
        const fieldName = group.querySelector('label').textContent.replace(' (*)', '');
        return `<li>${fieldName}</li>`;
    });
    
    errorsList.innerHTML = errorMessages.join('');
    validationSummary.classList.add('show');
    
    // Scroll to validation summary
    validationSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

// Function to convert file to base64
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// Message display functions
function showMessage(message, type) {
    console.log(`Message (${type}): ${message}`);
    
    // Create or update message element
    let messageElement = document.getElementById('messageContainer');
    if (!messageElement) {
        messageElement = document.createElement('div');
        messageElement.id = 'messageContainer';
        messageElement.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        `;
        document.body.appendChild(messageElement);
    }
    
    // Set message content and style
    messageElement.textContent = message;
    if (type === 'success') {
        messageElement.style.backgroundColor = '#28a745';
    } else if (type === 'error') {
        messageElement.style.backgroundColor = '#dc3545';
    } else {
        messageElement.style.backgroundColor = '#007bff';
    }
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (messageElement) {
            messageElement.remove();
        }
    }, 5000);
}

function hideMessages() {
    const messageElement = document.getElementById('messageContainer');
    if (messageElement) {
        messageElement.remove();
    }
}

function showLoading(show) {
    console.log('Loading:', show);
    // You can add a loading spinner here if needed
}

// Function to reset form and return to CV upload phase
function resetFormAndReturnToCVUpload() {
    console.log('Resetting form and returning to CV upload phase');
    
    // Reset form
    document.getElementById('personalInfoForm').reset();
    
    // Reset file variables
    cvFile = null;
    portraitFile = null;
    healthFile = null;
    idCardFile = null;
    passportFile = null;
    
    // Reset previews
    updatePortraitPreview(null);
    document.getElementById('uploadArea').classList.remove('hidden');
    document.getElementById('previewArea').classList.add('hidden');
    
    // Return to step 1 (CV upload phase)
    currentStep = 1;
    document.getElementById('step1').classList.add('active');
    document.getElementById('step1').classList.remove('completed');
    document.getElementById('step2').classList.remove('active');
    
    document.getElementById('cvUploadStep').classList.remove('hidden');
    document.getElementById('personalInfoStep').classList.add('hidden');
    
    // Reset CV upload area
    document.getElementById('cvFileInput').value = '';
    document.getElementById('cvPreview').src = '';
    document.getElementById('uploadArea').classList.remove('hidden');
    document.getElementById('previewArea').classList.add('hidden');
    
    // Clear any validation errors
    clearValidation();
    
    console.log('Form reset and returned to CV upload phase');
}

// Function to save/update employee data to database
async function submitEmployeeData() {
    try {
        console.log('submitEmployeeData() function called');
        showLoading(true);
        hideMessages();
        
        // Collect form data
        const formData = new FormData(document.getElementById('personalInfoForm'));
        const employeeData = {};
        
        // Convert FormData to object
        for (let [key, value] of formData.entries()) {
            employeeData[key] = value;
        }
        console.log('Collected form data:', employeeData);
        
        const fileFieldNames = ['cv_file', 'portrait_file', 'health_file', 'id_card_file', 'passport_file'];
        fileFieldNames.forEach(name => {
            delete employeeData[name];
        });

        // Handle file uploads (only add when present)
        const fileConversions = [];
        if (cvFile) {
            fileConversions.push(fileToBase64(cvFile).then(result => {
                employeeData.cv_file = result;
            }));
        }
        if (portraitFile) {
            fileConversions.push(fileToBase64(portraitFile).then(result => {
                employeeData.portrait_file = result;
            }));
        }
        if (healthFile) {
            fileConversions.push(fileToBase64(healthFile).then(result => {
                employeeData.health_file = result;
            }));
        }
        if (idCardFile) {
            fileConversions.push(fileToBase64(idCardFile).then(result => {
                employeeData.id_card_file = result;
            }));
        }
        if (passportFile) {
            fileConversions.push(fileToBase64(passportFile).then(result => {
                employeeData.passport_file = result;
            }));
        }

        await Promise.all(fileConversions);

        // Send data to backend
        console.log('Sending data to API:', employeeData);
        const url = IS_EDIT_MODE ? `/personnel/api/employee/${EMPLOYEE_ID}` : '/personnel/api/employee';
        const method = IS_EDIT_MODE ? 'PUT' : 'POST';
        const response = await fetch(url, {
            method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(employeeData)
        });
        
        console.log('API response status:', response.status);
        const result = await response.json();
        console.log('API response data:', result);
        
        if (result.success) {
            showMessage(result.message, 'success');
            if (IS_EDIT_MODE) {
                setTimeout(() => {
                    window.location.href = '/personnel/list';
                }, 1500);
            } else {
                // Reset form and return to CV upload phase after successful submission
                setTimeout(() => {
                    resetFormAndReturnToCVUpload();
                }, 2000);
            }
        } else {
            showMessage(`Error: ${result.error}`, 'error');
        }
        
    } catch (error) {
        console.error('Error submitting employee data:', error);
        showMessage(`Failed to submit employee data: ${error.message}`, 'error');
    } finally {
        showLoading(false);
    }
}
</script>
{% endblock %}
