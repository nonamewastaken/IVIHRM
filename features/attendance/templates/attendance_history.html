{% extends "base.html" %}

{% block title %}Lịch Sử Chấm Công - HRM System{% endblock %}

{% block extra_css %}
<style>
    /* Navigation Bar Styles */
    .navbar {
        background: white;
        padding: 0 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 70px;
        margin-bottom: 20px;
    }

    .navbar-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .company-section {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: background-color 0.3s;
    }

    .company-section:hover {
        background-color: #f8f9fa;
    }

    .company-name {
        font-weight: 600;
        font-size: 1.1rem;
        color: #333;
    }

    .dropdown-arrow {
        color: #666;
        transition: transform 0.3s;
    }

    .company-section:hover .dropdown-arrow {
        transform: rotate(180deg);
    }

    .nav-menu {
        display: flex;
        gap: 2rem;
        align-items: center;
    }

    .nav-item {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
        text-decoration: none;
        color: #666;
    }

    .nav-item:hover {
        background-color: #f8f9fa;
        color: #333;
    }

    .nav-item.active {
        background-color: #007bff;
        color: white;
    }

    .navbar-right {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .search-bar {
        position: relative;
        display: flex;
        align-items: center;
    }

    .search-icon {
        position: absolute;
        left: 12px;
        color: #666;
        z-index: 1;
    }

    .search-input {
        padding: 0.5rem 1rem 0.5rem 2.5rem;
        border: 1px solid #ddd;
        border-radius: 20px;
        background: #f8f9fa;
        font-size: 0.9rem;
        width: 200px;
        transition: all 0.3s;
    }

    .search-input:focus {
        outline: none;
        border-color: #007bff;
        background: white;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }

    .utility-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        cursor: pointer;
        transition: background-color 0.3s;
        color: #666;
    }

    .utility-icon:hover {
        background-color: #f8f9fa;
    }

    .user-profile {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        cursor: pointer;
        transition: background-color 0.3s;
        color: #666;
        position: relative;
    }

    .user-profile:hover {
        background-color: #f8f9fa;
    }

    .history-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .history-card {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .filter-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .filter-row {
        display: grid;
        grid-template-columns: 1fr 1fr auto;
        gap: 15px;
        align-items: end;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        font-weight: bold;
        color: #2c3e50;
        margin-bottom: 5px;
    }
    
    .form-group input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
    }
    
    .btn-filter {
        background: #3498db;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        transition: background 0.3s ease;
    }
    
    .btn-filter:hover {
        background: #2980b9;
    }
    
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .summary-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
    }
    
    .summary-card h3 {
        margin: 0 0 10px 0;
        font-size: 1.1rem;
    }
    
    .summary-card .value {
        font-size: 2rem;
        font-weight: bold;
        margin: 0;
    }
    
    .table-container {
        overflow-x: auto;
    }
    
    .attendance-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }
    
    .attendance-table th,
    .attendance-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    .attendance-table th {
        background: #f8f9fa;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .attendance-table tr:hover {
        background: #f5f5f5;
    }
    
    .status-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .status-present {
        background: #d4edda;
        color: #155724;
    }
    
    .status-absent {
        background: #f8d7da;
        color: #721c24;
    }
    
    .status-late {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-half-day {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
    }
    
    .no-data {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
        font-style: italic;
    }
    
    .back-button {
        background: #6c757d;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        text-decoration: none;
        display: inline-block;
        margin-bottom: 20px;
        transition: background 0.3s ease;
    }
    
    .back-button:hover {
        background: #5a6268;
        color: white;
        text-decoration: none;
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<!-- Navigation Bar -->
<nav class="navbar">
    <!-- Left Side - Company Section -->
    <div class="navbar-left">
        <div class="company-section">
            <span class="company-name">{{ user.organization.name if user.organization else "Your Company" }}</span>
            <i class="fas fa-chevron-down dropdown-arrow"></i>
        </div>
    </div>

    <!-- Middle - Navigation Menu -->
    <div class="nav-menu">
        <a href="/dashboard" class="nav-item">Home</a>
        <a href="#" class="nav-item">Administrative Personnel</a>
        <a href="/attendance" class="nav-item active">Attendance</a>
        <a href="#" class="nav-item">Salary</a>
        <a href="#" class="nav-item">Decision</a>
    </div>

    <!-- Right Side - Utilities -->
    <div class="navbar-right">
        <div class="search-bar">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" placeholder="Search HR data...">
        </div>
        
        <div class="utility-icon">
            <i class="fas fa-bell"></i>
        </div>
        
        <div class="utility-icon">
            <i class="fas fa-cog"></i>
        </div>
        
        <div class="user-profile">
            <i class="fas fa-user"></i>
        </div>
    </div>
</nav>

<div class="history-container">
    <a href="/attendance" class="back-button">
        <i class="fas fa-arrow-left"></i> Quay lại Chấm Công
    </a>
    
    <div class="history-card">
        <h1 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">
            <i class="fas fa-history"></i> Lịch Sử Chấm Công
        </h1>
        
        <div class="filter-section">
            <div class="filter-row">
                <div class="form-group">
                    <label for="startDate">Từ ngày:</label>
                    <input type="date" id="startDate" name="startDate">
                </div>
                <div class="form-group">
                    <label for="endDate">Đến ngày:</label>
                    <input type="date" id="endDate" name="endDate">
                </div>
                <button class="btn-filter" onclick="loadAttendanceHistory()">
                    <i class="fas fa-search"></i> Lọc
                </button>
            </div>
        </div>
        
        <div class="summary-cards" id="summaryCards" style="display: none;">
            <div class="summary-card">
                <h3>Tổng ngày làm việc</h3>
                <p class="value" id="totalDays">0</p>
            </div>
            <div class="summary-card">
                <h3>Tổng giờ làm việc</h3>
                <p class="value" id="totalHours">0h</p>
            </div>
            <div class="summary-card">
                <h3>Ngày có mặt</h3>
                <p class="value" id="presentDays">0</p>
            </div>
            <div class="summary-card">
                <h3>Ngày vắng mặt</h3>
                <p class="value" id="absentDays">0</p>
            </div>
        </div>
        
        <div class="error-message" id="errorMessage"></div>
        
        <div class="loading" id="loading">
            <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
        </div>
        
        <div class="table-container" id="tableContainer" style="display: none;">
            <table class="attendance-table">
                <thead>
                    <tr>
                        <th>Ngày</th>
                        <th>Thứ</th>
                        <th>Giờ vào</th>
                        <th>Giờ ra</th>
                        <th>Số giờ làm</th>
                        <th>Trạng thái</th>
                        <th>Ghi chú</th>
                    </tr>
                </thead>
                <tbody id="attendanceTableBody">
                </tbody>
            </table>
        </div>
        
        <div class="no-data" id="noData" style="display: none;">
            <i class="fas fa-calendar-times"></i><br>
            Không có dữ liệu chấm công trong khoảng thời gian này
        </div>
    </div>
</div>

<script>
// Set default date range (last 30 days)
function setDefaultDateRange() {
    const endDate = new Date();
    const startDate = new Date();
    startDate.setDate(endDate.getDate() - 30);
    
    document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
}

// Load attendance history
function loadAttendanceHistory() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        showError('Vui lòng chọn khoảng thời gian');
        return;
    }
    
    showLoading(true);
    hideError();
    
    const params = new URLSearchParams({
        start_date: startDate,
        end_date: endDate
    });
    
    fetch(`/api/attendance-history?${params}`)
        .then(response => response.json())
        .then(data => {
            showLoading(false);
            if (data.error) {
                showError(data.error);
            } else {
                displayAttendanceHistory(data);
            }
        })
        .catch(error => {
            showLoading(false);
            console.error('Error:', error);
            showError('Không thể tải lịch sử chấm công');
        });
}

// Display attendance history
function displayAttendanceHistory(data) {
    const history = data.history;
    
    if (history.length === 0) {
        document.getElementById('noData').style.display = 'block';
        document.getElementById('tableContainer').style.display = 'none';
        document.getElementById('summaryCards').style.display = 'none';
        return;
    }
    
    // Show table and summary
    document.getElementById('noData').style.display = 'none';
    document.getElementById('tableContainer').style.display = 'block';
    document.getElementById('summaryCards').style.display = 'grid';
    
    // Calculate summary
    calculateSummary(history);
    
    // Populate table
    const tbody = document.getElementById('attendanceTableBody');
    tbody.innerHTML = '';
    
    history.forEach(record => {
        const row = document.createElement('tr');
        
        const date = new Date(record.date);
        const dayOfWeek = getDayOfWeek(date.getDay());
        
        row.innerHTML = `
            <td>${formatDate(date)}</td>
            <td>${dayOfWeek}</td>
            <td>${record.check_in_time || '--:--'}</td>
            <td>${record.check_out_time || '--:--'}</td>
            <td>${record.work_hours ? record.work_hours + 'h' : '--'}</td>
            <td><span class="status-badge status-${record.status}">${getStatusText(record.status)}</span></td>
            <td>${record.notes || ''}</td>
        `;
        
        tbody.appendChild(row);
    });
}

// Calculate summary statistics
function calculateSummary(history) {
    let totalDays = history.length;
    let totalHours = 0;
    let presentDays = 0;
    let absentDays = 0;
    
    history.forEach(record => {
        if (record.work_hours) {
            totalHours += record.work_hours;
        }
        
        if (record.status === 'present') {
            presentDays++;
        } else if (record.status === 'absent') {
            absentDays++;
        }
    });
    
    document.getElementById('totalDays').textContent = totalDays;
    document.getElementById('totalHours').textContent = Math.round(totalHours * 10) / 10 + 'h';
    document.getElementById('presentDays').textContent = presentDays;
    document.getElementById('absentDays').textContent = absentDays;
}

// Utility functions
function formatDate(date) {
    return date.toLocaleDateString('vi-VN');
}

function getDayOfWeek(dayIndex) {
    const days = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
    return days[dayIndex];
}

function getStatusText(status) {
    const statusMap = {
        'present': 'Có mặt',
        'absent': 'Vắng mặt',
        'late': 'Đi muộn',
        'half_day': 'Nửa ngày'
    };
    return statusMap[status] || status;
}

function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function hideError() {
    document.getElementById('errorMessage').style.display = 'none';
}

// Initialize page
setDefaultDateRange();
loadAttendanceHistory();
</script>
{% endblock %}
