<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chấm Công - HRM System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    /* Sidebar Styles */
    .sidebar {
        width: 280px;
        background: white;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        position: fixed;
        height: 100vh;
        left: 0;
        top: 0;
        z-index: 1000;
        overflow-y: auto;
    }

    /* Main Content with Sidebar */
    .main-content-with-sidebar {
        margin-left: 280px;
        min-height: 100vh;
    }

    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        background: #f8f9fa;
    }

    .sidebar-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .sidebar-nav {
        padding: 20px 0;
    }

    .nav-section {
        margin-bottom: 30px;
    }

    .nav-section-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 0 20px 10px 20px;
        margin: 0;
    }

    .nav-item {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        color: #333;
        text-decoration: none;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
        cursor: pointer;
    }

    .nav-item:hover {
        background-color: #f1f3f4;
        color: #1a73e8;
    }

    .nav-item.active {
        background-color: #e8f0fe;
        color: #1a73e8;
        border-left-color: #1a73e8;
        font-weight: 500;
    }

    .nav-item-icon {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .nav-item-text {
        font-size: 0.9rem;
    }



    /* Content Area */
    .content-area {
        padding: 30px;
    }

    /* Tab Content Styles */
    .tab-content {
        animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .sidebar {
            width: 100%;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .main-content-with-sidebar {
            margin-left: 0;
        }

        .content-area {
            padding: 15px;
        }

        .attendance-container {
            padding: 10px;
        }

        .attendance-card {
            padding: 20px;
        }
    }

    @media (max-width: 480px) {
        .sidebar-title {
            font-size: 1rem;
        }
    }

    /* Navigation Bar Styles (Legacy - keeping for compatibility) */
    .navbar {
        background: white;
        padding: 0 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 70px;
        margin-bottom: 20px;
    }

    .navbar-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .company-section {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        transition: background-color 0.3s;
    }

    .company-section:hover {
        background-color: #f8f9fa;
    }

    .company-name {
        font-weight: 600;
        font-size: 1.1rem;
        color: #333;
    }

    .dropdown-arrow {
        color: #666;
        transition: transform 0.3s;
    }

    .company-section:hover .dropdown-arrow {
        transform: rotate(180deg);
    }

    .nav-menu {
        display: flex;
        gap: 2rem;
        align-items: center;
    }

    .nav-item {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 0.55rem 1.1rem;
        border-radius: 999px;
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, transform 0.06s ease;
        font-weight: 600;
        text-decoration: none;
        color: #444;
        background: #ffffff;
        border: 1px solid #e6e8ec;
        box-shadow: 0 1px 2px rgba(16, 24, 40, 0.04);
    }

    .nav-item:hover {
        background-color: #f6f8fb;
        color: #111827;
        box-shadow: 0 2px 6px rgba(16, 24, 40, 0.06);
    }

    .nav-item:active {
        transform: translateY(1px);
    }

    .nav-item.active {
        background: linear-gradient(180deg, #3b82f6 0%, #2563eb 100%);
        color: #ffffff;
        border-color: transparent;
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25);
    }

    .nav-item.active i { color: #ffffff; }

    .navbar-right {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .search-bar {
        position: relative;
        display: flex;
        align-items: center;
    }

    .search-icon {
        position: absolute;
        left: 12px;
        color: #666;
        z-index: 1;
    }

    .search-input {
        padding: 0.5rem 1rem 0.5rem 2.5rem;
        border: 1px solid #ddd;
        border-radius: 20px;
        background: #f8f9fa;
        font-size: 0.9rem;
        width: 200px;
        transition: all 0.3s;
    }

    .search-input:focus {
        outline: none;
        border-color: #007bff;
        background: white;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }

    .utility-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        cursor: pointer;
        transition: background-color 0.3s;
        color: #666;
    }

    .utility-icon:hover {
        background-color: #f8f9fa;
    }

    .user-profile {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        cursor: pointer;
        transition: background-color 0.3s;
        color: #666;
        position: relative;
    }

    .user-profile:hover {
        background-color: #f8f9fa;
    }

    .attendance-container {
        max-width: 100%;
        margin: 0 auto;
        padding: 20px;
    }
    
    .attendance-card {
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    
    .time-display {
        font-size: 2.5rem;
        font-weight: bold;
        color: #2c3e50;
        text-align: center;
        margin: 20px 0;
    }
    
    .date-display {
        font-size: 1.2rem;
        color: #7f8c8d;
        text-align: center;
        margin-bottom: 30px;
    }
    
    .button-group {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin: 30px 0;
    }
    
    .btn-attendance {
        padding: 15px 30px;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        min-width: 150px;
    }
    
    .btn-check-in {
        background: #27ae60;
        color: white;
    }
    
    .btn-check-in:hover {
        background: #229954;
        transform: translateY(-2px);
    }
    
    .btn-check-out {
        background: #e74c3c;
        color: white;
    }
    
    .btn-check-out:hover {
        background: #c0392b;
        transform: translateY(-2px);
    }
    
    .btn-disabled {
        background: #bdc3c7;
        color: #7f8c8d;
        cursor: not-allowed;
    }
    
    .status-indicator {
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
        font-weight: bold;
    }
    
    .status-checked-in {
        background: #d5f4e6;
        color: #27ae60;
        border: 2px solid #27ae60;
    }
    
    .status-checked-out {
        background: #fadbd8;
        color: #e74c3c;
        border: 2px solid #e74c3c;
    }
    
    .status-not-checked {
        background: #f8f9fa;
        color: #6c757d;
        border: 2px solid #6c757d;
    }
    
    .attendance-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
    }
    
    .info-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        text-align: center;
    }
    
    .info-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 5px;
    }
    
    .info-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .quick-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
    }
    
    .btn-secondary {
        background: #3498db;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        text-decoration: none;
        font-size: 0.9rem;
        transition: background 0.3s ease;
    }
    
    .btn-secondary:hover {
        background: #2980b9;
        color: white;
        text-decoration: none;
    }
    
    .loading {
        display: none;
        text-align: center;
        color: #7f8c8d;
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        display: none;
    }
    
    .success-message {
        background: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
        display: none;
    }

    /* Pager styles for Summary tab */
    .pager {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    .pager-btn {
        min-width: 36px;
        height: 36px;
        padding: 0 10px;
        border-radius: 8px;
        border: 1px solid #e6e8ec;
        background: #ffffff;
        color: #344054;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.15s ease, box-shadow 0.15s ease, color 0.15s ease;
    }
    .pager-btn:hover { background: #f6f8fb; box-shadow: 0 1px 3px rgba(16,24,40,.06); }
    .pager-btn:disabled { background: #f1f3f5; color: #98a2b3; cursor: not-allowed; box-shadow: none; }
    .pager-page {
        min-width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        background: #f8fafc;
        color: #111827;
        font-weight: 700;
        border: 1px solid #e6e8ec;
    }
    .pager-select {
        padding: 6px 10px;
        border: 1px solid #e6e8ec;
        border-radius: 8px;
        background: #fff;
        color: #344054;
    }
</style>
<!-- Sidebar -->
<div class="sidebar">
    <div class="sidebar-header">
        <h1 class="sidebar-title">
            <i class="fas fa-clock"></i>
            Quản Lý Chấm Công
        </h1>
    </div>
    
    <nav class="sidebar-nav">
        <div class="nav-section">
            <h3 class="nav-section-title">Quản Lý Chấm Công</h3>
            <a href="#" class="nav-item active" onclick="showTab('monthly_detail')">
                <div class="nav-item-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <span class="nav-item-text">Monthly Attendance Detail</span>
            </a>
            <a href="#" class="nav-item" onclick="showTab('summary')">
                <div class="nav-item-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span class="nav-item-text">Attendance Summary</span>
            </a>
            <a href="#" class="nav-item" onclick="showTab('work_data')">
                <div class="nav-item-icon">
                    <i class="fas fa-database"></i>
                </div>
                <span class="nav-item-text">Work Data</span>
            </a>
        </div>
    </nav>
</div>

<!-- Main Content with original layout -->
<div class="main-content-with-sidebar">
    <!-- Original Navigation Bar -->
    <nav class="navbar">
        <!-- Left Side - Company Section -->
        <div class="navbar-left">
            <div class="company-section">
                <span class="company-name">{{ user.organization.name if user.organization else "Your Company" }}</span>
                <i class="fas fa-chevron-down dropdown-arrow"></i>
            </div>
        </div>

        <!-- Middle - Navigation Menu -->
        <div class="nav-menu">
            <a href="/dashboard" class="nav-item">Home</a>
            <a href="#" class="nav-item">Administrative Personnel</a>
            <a href="/attendance/admin" class="nav-item active">Attendance</a>
            <a href="#" class="nav-item">Salary</a>
            <a href="#" class="nav-item">Decision</a>
        </div>

        <!-- Right Side - Utilities -->
        <div class="navbar-right">
            <div class="search-bar">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="Search HR data...">
            </div>
            
            <div class="utility-icon">
                <i class="fas fa-bell"></i>
            </div>
            
            <div class="utility-icon">
                <i class="fas fa-cog"></i>
            </div>
            
            <div class="user-profile">
                <i class="fas fa-user"></i>
            </div>
        </div>
    </nav>

    <!-- Content Area -->
    <div class="content-area">
        <!-- Monthly Detail Tab Content -->
        <div id="monthly_detail-tab" class="tab-content">
            <div class="attendance-container">
                <div class="attendance-card">
                    <h1 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">
                        <i class="fas fa-calendar-alt"></i> Monthly Attendance Detail
                    </h1>
        

        
        <div class="attendance-table-container" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 20px;">
            <!-- Action Buttons -->
            <div class="action-buttons" style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center;">
                <button class="btn btn-primary" id="exportExcelBtn" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-file-excel"></i>
                    Export Excel
                </button>
                <button class="btn btn-info" id="importExcelBtn" style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-upload"></i>
                    Import Excel
                </button>
                <button class="btn btn-secondary" id="filterBtn" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-filter"></i>
                    Filter
                </button>
                <input type="month" id="monthSelect" value="2024-09" style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 5px; background: white; font-size: 14px; min-width: 150px;">
            </div>
            
            <!-- Hidden file input for Excel upload -->
            <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;">
            
            <!-- Row limit notice -->
            <div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 5px; color: #0066cc; font-size: 14px;">
                <i class="fas fa-info-circle"></i> <strong>Note:</strong> Maximum 25 rows allowed for data entry. Please ensure your Excel file follows the correct format.
            </div>
            
            <div class="table-responsive" style="overflow-x: auto; width: 100%; border: 0px solid #000;">
                <table class="attendance-table" style="border-collapse: collapse; table-layout: fixed; min-width: 100vw;">
                    <thead>
                        <!-- Row 1: Main Headers, width: 80px; height: 200px;-->
                        <tr id="header-rows"></tr>
                        <tr id="weekdays-row"></tr>
                        <tr id="days-row"></tr>
                        <tr>
                            <th style="min-width: 75px; height: 50px; border: 1px solid #ddd">Số lần</th>
                            <th style="min-width: 75px; height: 50px; border: 1px solid #ddd">Số phút</th>
                            <th style="min-width: 75px; height: 50px; border: 1px solid #ddd">Số công</th>
                            <th style="min-width: 75px; height: 50px; border: 1px solid #ddd">Số lần</th>
                            <th style="min-width: 75px; height: 50px; border: 1px solid #ddd">Số phút</th>
                            <th style="min-width: 75px; height: 50px; border: 1px solid #ddd">Số công</th>
                        </tr>
                    </thead>
                </table>

                <script>
                    function generateHeaderRows(n) {
                      const tr = document.getElementById("header-rows"); // this is a TR
                      tr.innerHTML = "";
                      tr.style.background = "#f8f9fa";
                    
                      const mk = (html, attrs={}) => {
                        const th = document.createElement("th");
                        Object.assign(th, attrs);
                        return Object.assign(th, { innerHTML: html });
                      };
                    
                      tr.appendChild(mk("STT", { rowSpan: 4, style: "min-width:75px; height:200px; border: 1px; padding: 4px; text-align:center; position:sticky; left:0; background-color: #fef2cc" }));
                      tr.appendChild(mk("Nhân viên", { rowSpan: 4, style: "min-width:100px; height:200px; border: 1px; padding: 4px; text-align:center; position:sticky; left:75px; background-color: #fef2cc" }));
                    
                      tr.appendChild(mk("Công chi tiết tháng", { colSpan: n, style: `width:${n*80}px; height:50px; border:1px; padding: 4px; background-color: #fef2cc` }));
                    
                      tr.appendChild(mk("Công<br>định mức", { rowSpan: 4, style: "min-width:100px; height:200px; border:1px; padding: 4px; background-color: #fef2cc" }));
                      tr.appendChild(mk("Công<br>hành chính", { rowSpan: 4, style: "min-width:100px; height:200px; border:1px; padding: 4px; text-align:center; background-color: #fef2cc" }));
                      tr.appendChild(mk("Công<br>đi đường", { rowSpan: 4, style: "min-width:100px; height:200px; border:1px; padding: 4px; background-color: #fef2cc" }));
                    
                      tr.appendChild(mk("Công vượt định mức", { colSpan: 4, style: "height:50px; border:1px; padding: 4px; background-color: #fef2cc" }));
                      tr.appendChild(mk("Tổng công<br>đi làm", { rowSpan: 4, style: "min-width:100px; height:200px; border:1px; padding: 4px; background-color: #fef2cc" }));
                      tr.appendChild(mk("Công nghỉ hưởng lương", { colSpan: 4, style: "height:50px; border:1px; padding: 4px; background-color: #fef2cc" }));
                      tr.appendChild(mk("Các khoản công bị giảm trừ", { colSpan: 7, style: "height:50px; border:1px; padding: 4px; background-color: #fef2cc" }));
                      tr.appendChild(mk("Bù trừ công<br>hành chính sau<br>quyết toán<br>công tác", { rowSpan: 4, style: "min-width:125px; height:200px; border: 1px; padding: 4px; background-color: #fef2cc" }));
                      tr.appendChild(mk("Công<br>ca đêm", { rowSpan: 4, style: "min-width:100px; height:200px; border:1px; padding: 4px; background-color: #fef2cc" }));
                      tr.appendChild(mk("Tổng công<br>tính lương", { rowSpan: 4, style: "min-width:100px; height:200px; border:1px; padding: 4px; background-color: #fef2cc" }));
                      tr.appendChild(mk("Các ngày nghỉ không hưởng lương", { colSpan: 4, style: "height:50px; border:1px; padding: 4px; background-color: #fef2cc" }));
                      tr.appendChild(mk("Tổng ngày<br>nghỉ không<br>hưởng lương", { rowSpan: 4, style: "min-width:125px; height:200px; border:1px; padding: 4px; background-color: #fef2cc" }));
                    }
                </script>
                
                <script>
                    function generateWeekdaysRow(n, firstWeekDay) {
                      const row = document.getElementById("weekdays-row");
                      row.innerHTML = "";
                    
                      const full2idx = { Monday:0, Tuesday:1, Wednesday:2, Thursday:3, Friday:4, Saturday:5, Sunday:6 };
                      const abbr = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
                    
                      const start = full2idx[firstWeekDay];
                      if (start === undefined) throw new Error("firstWeekDay must be one of: Monday..Sunday");
                    
                      // weekday columns 1..n
                      for (let i = 0; i < n; i++) {
                        const th = document.createElement("th");
                        th.rowSpan = 1;
                        th.style = "min-width: 50px; height: 50px; border: 1px solid #ddd;";
                        th.textContent = abbr[(start + i) % 7];
                        row.appendChild(th);
                      }
                    
                      // VĐM (rowspan=3)
                      const vdm = [
                        { html: "VĐM1<br>(x1.5)", w: 75 },
                        { html: "VĐM2<br>(x2)",   w: 75 },
                        { html: "VĐM3<br>(x3)",   w: 75 },
                        { html: "Tổng công VĐM quy đổi hệ số", w: 150 }
                      ];
                      vdm.forEach(item => {
                        const th = document.createElement("th");
                        th.rowSpan = 3;
                        th.style = `min-width: ${item.w}px; height: 150px; border: 1px solid #ddd;`;
                        if (item.html.includes("<br")) th.innerHTML = item.html; else th.textContent = item.html;
                        row.appendChild(th);
                      });
                    
                      // NHL (no rowspan)
                      [
                        { text: "NHL1", w: 75 },
                        { text: "NHL2", w: 75 },
                        { text: "NHL3", w: 125 }
                      ].forEach(item => {
                        const th = document.createElement("th");
                        th.style = `min-width: ${item.w}px; height: 50px; border: 1px solid #ddd;`;
                        th.textContent = item.text;
                        row.appendChild(th);
                      });
                    
                      // Tổng công NHL (rowspan=3)
                      {
                        const th = document.createElement("th");
                        th.rowSpan = 3;
                        th.style = "min-width: 100px; height: 150px; border: 1px solid #ddd;";
                        th.innerHTML = "Tổng<br>công NHL";
                        row.appendChild(th);
                      }
                    
                      // GT1, GT2 groups (colspan=3)
                      ["GT1","GT2"].forEach(label => {
                        const th = document.createElement("th");
                        th.colSpan = 3;
                        th.style = "width: 300px; height: 50px; border: 1px solid #ddd;";
                        th.textContent = label;
                        row.appendChild(th);
                      });
                    
                      // Tổng công bị giảm trừ (rowspan=3)
                      {
                        const th = document.createElement("th");
                        th.rowSpan = 3;
                        th.style = "min-width: 125px; height: 150px; border: 1px solid #ddd;";
                        th.innerHTML = "Tổng công<br>bị giảm trừ";
                        row.appendChild(th);
                      }
                    
                      // NK1..NK4 (no rowspan)
                      ["NK1","NK2","NK3","NK4"].forEach(label => {
                        const th = document.createElement("th");
                        th.style = "width: 100px; height: 50px; border: 1px solid #ddd;";
                        th.textContent = label;
                        row.appendChild(th);
                      });
                    }
                </script>

                <script>
                    function generateDaysRow(n) {
                      const row = document.getElementById("days-row");
                      row.innerHTML = ""; // clear old cells
                    
                      // create day columns 1..n
                      for (let i = 1; i <= n; i++) {
                        const th = document.createElement("th");
                        th.rowSpan = 2;
                        th.style = "min-width: 50px; height: 100px; border: 1px solid #ddd;";
                        th.textContent = i;
                        row.appendChild(th);
                      }
                    
                      // append fixed columns
                      const fixed = [
                        { text: "Phép", width: 75 },
                        { text: "Lễ, Tết", width: 75 },
                        { text: "Chế độ hưởng nguyên lương", width: 125 }
                      ];
                      fixed.forEach(item => {
                        const th = document.createElement("th");
                        th.rowSpan = 2;
                        th.style = `min-width: ${item.width}px; height: 100px; border: 1px solid #ddd;`;
                        th.textContent = item.text;
                        row.appendChild(th);
                      });

                      // group headers (colspan=3)
                      const groups = [
                        { text: "Đi muộn" },
                        { text: "Về sớm" }
                      ];
                      groups.forEach(item => {
                        const th = document.createElement("th");
                        th.colSpan = 3;
                        th.style = "width: 300px; height: 50px; border: 1px solid #ddd;";
                        th.textContent = item.text;
                        row.appendChild(th);
                      });

                      // nghỉ … headers (rowspan=2, with <br> inside)
                      const nghis = [
                        "Nghỉ<br>không<br>lý do",
                        "Nghỉ<br>không<br>lương",
                        "Nghỉ<br>hưởng<br>BHXH",
                        "Nghỉ<br>thai<br>sản"
                      ];
                      nghis.forEach(text => {
                        const th = document.createElement("th");
                        th.rowSpan = 2;
                        th.style = "min-width: 75px; height: 100px; border: 1px solid #ddd;";
                        th.innerHTML = text; // use innerHTML to render <br>
                        row.appendChild(th);
                      });
                    }
                </script>
            </div>
        </div>
        

                        
                        <div class="loading" id="loading">
                            <i class="fas fa-spinner fa-spin"></i> Processing...
                        </div>
                        
                        <div class="error-message" id="errorMessage"></div>
                        <div class="success-message" id="successMessage"></div>
                    </div>
                </div>
            </div>

            <!-- Summary Tab Content -->
            <div id="summary-tab" class="tab-content" style="display: none;">
                <div class="attendance-container">
                    <div class="attendance-card">
                        <h2 style="color: #2c3e50; margin-bottom: 20px;">
                            <i class="fas fa-chart-line"></i> Attendance Summary
                        </h2>
                        <!-- Actions Row -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="display:flex; gap: 10px; align-items: center;">
                                <button id="openFilterBtn" class="btn-secondary" style="background:#6c757d;">
                                    <i class="fas fa-filter"></i> Bộ lọc
                                </button>
                                <input id="boardSearchInput" type="text" placeholder="Tìm bảng chấm công..." 
                                       style="padding:10px 12px; border:1px solid #ddd; border-radius:6px; width:260px;"/>
                            </div>
                            <button id="createBoardBtn" class="btn-secondary" style="background:#28a745;">
                                <i class="fas fa-plus"></i> Thêm mới
                            </button>
                        </div>

                        <!-- Filter Panel -->
                        <div id="boardFilterPanel" style="display:none; background:#f8f9fa; border:1px solid #eee; border-radius:8px; padding:16px; margin-bottom:16px;">
                            <div style="display:grid; grid-template-columns: repeat(6, 1fr); gap:12px;">
                                <div>
                                    <label style="font-weight:600; color:#2c3e50; font-size:0.9rem;">Từ ngày</label>
                                    <input id="boardFromDate" type="date" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"/>
                                </div>
                                <div>
                                    <label style="font-weight:600; color:#2c3e50; font-size:0.9rem;">Đến ngày</label>
                                    <input id="boardToDate" type="date" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"/>
                                </div>
                                <div>
                                    <label style="font-weight:600; color:#2c3e50; font-size:0.9rem;">Đơn vị</label>
                                    <input id="boardUnit" type="text" placeholder="VD: Phòng Kinh Doanh" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"/>
                                </div>
                                <div>
                                    <label style="font-weight:600; color:#2c3e50; font-size:0.9rem;">Loại</label>
                                    <select id="boardType" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                        <option value="">Tất cả</option>
                                        <option value="monthly">Theo tháng</option>
                                        <option value="period">Theo kỳ</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-weight:600; color:#2c3e50; font-size:0.9rem;">Trạng thái</label>
                                    <select id="boardStatus" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                        <option value="">Tất cả</option>
                                        <option value="draft">Nháp</option>
                                        <option value="processing">Đang xử lý</option>
                                        <option value="completed">Hoàn thành</option>
                                    </select>
                                </div>
                                <div style="display:flex; align-items:flex-end; gap:10px;">
                                    <button id="applyBoardFilterBtn" class="btn-secondary" style="background:#3498db;">
                                        Áp dụng
                                    </button>
                                    <button id="resetBoardFilterBtn" class="btn-secondary" style="background:#6c757d;">
                                        Đặt lại
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Table Container -->
                        <div class="table-responsive" style="min-height:240px;">
                            <table style="width:100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background:#f8f9fa;">
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Tên bảng chấm công</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Từ ngày</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Đến ngày</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Đơn vị</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Loại</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Trạng thái</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="timesheetBoardsBody">
                                    <tr>
                                        <td colspan="7" style="padding:20px; text-align:center; color:#666;">Chưa có dữ liệu</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div style="display:flex; justify-content: space-between; align-items:center; margin-top:12px;">
                            <div style="color:#666; font-size:0.9rem;">Tổng số bản ghi: <span id="boardsTotal">0</span></div>
                            <div class="pager">
                                <select id="boardsPageSize" class="pager-select">
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                </select>
                                <button id="boardsFirst" class="pager-btn" title="Trang đầu">«</button>
                                <button id="boardsPrev" class="pager-btn" title="Trang trước">‹</button>
                                <span id="boardsPage" class="pager-page">1</span>
                                <button id="boardsNext" class="pager-btn" title="Trang sau">›</button>
                                <button id="boardsLast" class="pager-btn" title="Trang cuối">»</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Work Data Tab Content -->
            <div id="work_data-tab" class="tab-content" style="display: none;">
                <div class="attendance-container">
                    <div class="attendance-card">
                        <h2 style="color: #2c3e50; margin-bottom: 20px;">
                            <i class="fas fa-database"></i> Work Data
                        </h2>
                        <!-- Actions Row -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="display:flex; gap: 10px; align-items: center;">
                                <button id="workOpenFilterBtn" class="btn-secondary" style="background:#6c757d;">
                                    <i class="fas fa-filter"></i> Bộ lọc
                                </button>
                                <input id="workSearchInput" type="text" placeholder="Tìm theo tên/mã nhân viên..." 
                                       style="padding:10px 12px; border:1px solid #ddd; border-radius:6px; width:260px;"/>
                            </div>
                        </div>

                        <!-- Filter Panel -->
                        <div id="workFilterPanel" style="display:none; background:#f8f9fa; border:1px solid #eee; border-radius:8px; padding:16px; margin-bottom:16px;">
                            <div style="display:grid; grid-template-columns: repeat(6, 1fr); gap:12px;">
                                <div>
                                    <label style="font-weight:600; color:#2c3e50; font-size:0.9rem;">Từ ngày</label>
                                    <input id="workFromDate" type="date" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"/>
                                </div>
                                <div>
                                    <label style="font-weight:600; color:#2c3e50; font-size:0.9rem;">Đến ngày</label>
                                    <input id="workToDate" type="date" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"/>
                                </div>
                                <div>
                                    <label style="font-weight:600; color:#2c3e50; font-size:0.9rem;">Phòng ban</label>
                                    <input id="workDepartment" type="text" placeholder="VD: Hành chính" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"/>
                                </div>
                                <div>
                                    <label style="font-weight:600; color:#2c3e50; font-size:0.9rem;">Hình thức</label>
                                    <select id="workMethod" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
                                        <option value="">Tất cả</option>
                                        <option value="app">App điện thoại</option>
                                        <option value="device">Máy chấm công</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-weight:600; color:#2c3e50; font-size:0.9rem;">Ca/Phiếu</label>
                                    <input id="workShift" type="text" placeholder="VD: Hành chính" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;"/>
                                </div>
                                <div style="display:flex; align-items:flex-end; gap:10px;">
                                    <button id="applyWorkFilterBtn" class="btn-secondary" style="background:#3498db;">
                                        Áp dụng
                                    </button>
                                    <button id="resetWorkFilterBtn" class="btn-secondary" style="background:#6c757d;">
                                        Đặt lại
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Table Container -->
                        <div class="table-responsive" style="min-height:240px;">
                            <table style="width:100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background:#f8f9fa;">
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Mã nhân viên</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Họ và tên</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Chức danh</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Số điện thoại</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Phòng ban</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Hình thức chấm công</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Tên máy chấm công</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Vị trí chấm công</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Ngày giờ chấm công</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Ca/Phiếu</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Hình ảnh</th>
                                        <th style="padding:10px; border-bottom:1px solid #e9ecef; text-align:left;">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="workDataBody">
                                    <tr>
                                        <td colspan="12" style="padding:20px; text-align:center; color:#666;">Chưa có dữ liệu</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div style="display:flex; justify-content: space-between; align-items:center; margin-top:12px;">
                            <div style="color:#666; font-size:0.9rem;">Tổng số bản ghi: <span id="workTotal">0</span></div>
                            <div class="pager">
                                <select id="workPageSize" class="pager-select">
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                </select>
                                <button id="workFirst" class="pager-btn" title="Trang đầu">«</button>
                                <button id="workPrev" class="pager-btn" title="Trang trước">‹</button>
                                <span id="workPage" class="pager-page">1</span>
                                <button id="workNext" class="pager-btn" title="Trang sau">›</button>
                                <button id="workLast" class="pager-btn" title="Trang cuối">»</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Tab switching functionality
function showTab(tabName) {
    // Hide all tab contents
    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(tab => {
        tab.style.display = 'none';
    });
    
    // Remove active class from all nav items
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => {
        item.classList.remove('active');
    });
    
    // Show selected tab content
    const selectedTab = document.getElementById(tabName + '-tab');
    if (selectedTab) {
        selectedTab.style.display = 'block';
    }
    
    // Add active class to clicked nav item
    const clickedItem = event.target.closest('.nav-item');
    if (clickedItem) {
        clickedItem.classList.add('active');
    }
    
    // Update page title
    const pageTitle = document.getElementById('pageTitle');
    const titles = {
        'monthly_detail': 'Monthly Attendance Detail',
        'summary': 'Attendance Summary',
        'work_data': 'Work Data'
    };
    
    if (pageTitle && titles[tabName]) {
        pageTitle.textContent = titles[tabName];
    }
}

// Update time display
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('vi-VN');
    const dateString = now.toLocaleDateString('vi-VN');
    
    const timeElement = document.getElementById('currentTime');
    const dateElement = document.getElementById('currentDate');
    
    if (timeElement) timeElement.textContent = timeString;
    if (dateElement) dateElement.textContent = dateString;
}

// Update time every second
setInterval(updateTime, 1000);
updateTime();

// Load attendance status
function loadAttendanceStatus() {
    fetch('/api/attendance-status')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showError(data.error);
                return;
            }
            
            updateStatusDisplay(data);
        })
        .catch(error => {
            console.error('Error:', error);
            showError('Không thể tải trạng thái chấm công');
        });
}

// Update status display
function updateStatusDisplay(data) {
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const checkInBtn = document.getElementById('checkInBtn');
    const checkOutBtn = document.getElementById('checkOutBtn');
    const attendanceInfo = document.getElementById('attendanceInfo');
    
    // Reset classes
    statusIndicator.className = 'status-indicator';
    checkInBtn.className = 'btn-attendance btn-check-in';
    checkOutBtn.className = 'btn-attendance btn-check-out';
    
    switch(data.status) {
        case 'not_checked_in':
            statusIndicator.classList.add('status-not-checked');
            statusText.textContent = 'Chưa chấm công hôm nay';
            checkInBtn.disabled = false;
            checkOutBtn.disabled = true;
            checkOutBtn.classList.add('btn-disabled');
            attendanceInfo.style.display = 'none';
            break;
            
        case 'checked_in':
            statusIndicator.classList.add('status-checked-in');
            statusText.textContent = 'Đã check in - Sẵn sàng check out';
            checkInBtn.disabled = true;
            checkInBtn.classList.add('btn-disabled');
            checkOutBtn.disabled = false;
            attendanceInfo.style.display = 'grid';
            document.getElementById('checkInTime').textContent = data.check_in_time;
            document.getElementById('checkOutTime').textContent = '--:--';
            break;
            
        case 'checked_out':
            statusIndicator.classList.add('status-checked-out');
            statusText.textContent = 'Hoàn thành chấm công hôm nay';
            checkInBtn.disabled = true;
            checkInBtn.classList.add('btn-disabled');
            checkOutBtn.disabled = true;
            checkOutBtn.classList.add('btn-disabled');
            attendanceInfo.style.display = 'grid';
            document.getElementById('checkInTime').textContent = data.check_in_time;
            document.getElementById('checkOutTime').textContent = data.check_out_time;
            break;
    }
}

// Check in function
function checkIn() {
    showLoading(true);
    hideMessages();
    
    fetch('/api/check-in', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        if (data.error) {
            showError(data.error);
        } else {
            showSuccess(data.message);
            loadAttendanceStatus(); // Reload status
        }
    })
    .catch(error => {
        showLoading(false);
        console.error('Error:', error);
        showError('Lỗi khi check in');
    });
}

// Check out function
function checkOut() {
    showLoading(true);
    hideMessages();
    
    fetch('/api/check-out', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        if (data.error) {
            showError(data.error);
        } else {
            showSuccess(data.message);
            loadAttendanceStatus(); // Reload status
        }
    })
    .catch(error => {
        showLoading(false);
        console.error('Error:', error);
        showError('Lỗi khi check out');
    });
}

// Utility functions
function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function showError(message) {
    const errorDiv = document.getElementById('errorMessage');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

function showSuccess(message) {
    const successDiv = document.getElementById('successMessage');
    successDiv.textContent = message;
    successDiv.style.display = 'block';
    setTimeout(() => {
        successDiv.style.display = 'none';
    }, 3000);
}

function hideMessages() {
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('successMessage').style.display = 'none';
}

// Load initial status
loadAttendanceStatus();

// ================= Summary Boards JS =================
let boardsPage = 1;
function getBoardsPageSize() {
    const sel = document.getElementById('boardsPageSize');
    return sel ? parseInt(sel.value, 10) : 10;
}

function buildBoardsQuery() {
    const params = new URLSearchParams();
    params.set('page', boardsPage);
    params.set('page_size', getBoardsPageSize());
    const q = document.getElementById('boardSearchInput')?.value || '';
    const unit = document.getElementById('boardUnit')?.value || '';
    const type = document.getElementById('boardType')?.value || '';
    const status = document.getElementById('boardStatus')?.value || '';
    const fromDate = document.getElementById('boardFromDate')?.value || '';
    const toDate = document.getElementById('boardToDate')?.value || '';
    if (q) params.set('q', q);
    if (unit) params.set('unit', unit);
    if (type) params.set('type', type);
    if (status) params.set('status', status);
    if (fromDate) params.set('from_date', fromDate);
    if (toDate) params.set('to_date', toDate);
    return params.toString();
}

function loadTimesheetBoards() {
    const tbody = document.getElementById('timesheetBoardsBody');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="7" style="padding:20px; text-align:center; color:#666;">Đang tải...</td></tr>';
    }
    fetch('/api/timesheet-boards?' + buildBoardsQuery())
        .then(r => r.json())
        .then(data => {
            const items = data.items || [];
            const total = data.total || 0;
            const page = data.page || boardsPage;
            const pageSize = data.page_size || getBoardsPageSize();
            const totalEl = document.getElementById('boardsTotal');
            if (totalEl) totalEl.textContent = total;
            const pageEl = document.getElementById('boardsPage');
            if (pageEl) pageEl.textContent = page;
            if (tbody) {
                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="padding:20px; text-align:center; color:#666;">Chưa có dữ liệu</td></tr>';
                } else {
                    tbody.innerHTML = '';
                    items.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td style="padding:10px; border-bottom:1px solid #f1f1f1; font-weight:600; color:#2c3e50;">${item.name || ''}</td>
                            <td style="padding:10px; border-bottom:1px solid #f1f1f1;">${item.from_date || ''}</td>
                            <td style="padding:10px; border-bottom:1px solid #f1f1f1;">${item.to_date || ''}</td>
                            <td style="padding:10px; border-bottom:1px solid #f1f1f1;">${item.unit || ''}</td>
                            <td style="padding:10px; border-bottom:1px solid #f1f1f1;">${item.type || ''}</td>
                            <td style="padding:10px; border-bottom:1px solid #f1f1f1;">${item.status || ''}</td>
                            <td style="padding:10px; border-bottom:1px solid #f1f1f1;">
                                <button class="btn-secondary" style="background:#f1f3f5; color:#333;">Xem</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            }
            // Enable/disable pager
            const prevBtn = document.getElementById('boardsPrev');
            const nextBtn = document.getElementById('boardsNext');
            const firstBtn = document.getElementById('boardsFirst');
            const lastBtn = document.getElementById('boardsLast');
            const maxPage = Math.max(1, Math.ceil(total / pageSize));
            if (prevBtn) prevBtn.disabled = page <= 1;
            if (firstBtn) firstBtn.disabled = page <= 1;
            if (nextBtn) nextBtn.disabled = page >= maxPage;
            if (lastBtn) lastBtn.disabled = page >= maxPage;
        })
        .catch(() => {
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="7" style="padding:20px; text-align:center; color:#c00;">Lỗi tải dữ liệu</td></tr>';
            }
        });
}

// Toggle filter panel
document.getElementById('openFilterBtn')?.addEventListener('click', function() {
    const panel = document.getElementById('boardFilterPanel');
    if (panel) {
        panel.style.display = panel.style.display === 'none' || panel.style.display === '' ? 'block' : 'none';
    }
});

// Apply / Reset filters
document.getElementById('applyBoardFilterBtn')?.addEventListener('click', function() {
    boardsPage = 1;
    loadTimesheetBoards();
});
document.getElementById('resetBoardFilterBtn')?.addEventListener('click', function() {
    const ids = ['boardFromDate','boardToDate','boardUnit','boardType','boardStatus','boardSearchInput'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = '';
        }
    });
    boardsPage = 1;
    loadTimesheetBoards();
});

// Search typing debounce
let boardSearchTimer;
document.getElementById('boardSearchInput')?.addEventListener('input', function() {
    clearTimeout(boardSearchTimer);
    boardSearchTimer = setTimeout(() => { boardsPage = 1; loadTimesheetBoards(); }, 400);
});

// Pagination controls
document.getElementById('boardsPrev')?.addEventListener('click', function() {
    if (boardsPage > 1) { boardsPage -= 1; loadTimesheetBoards(); }
});
document.getElementById('boardsNext')?.addEventListener('click', function() {
    boardsPage += 1; loadTimesheetBoards();
});
document.getElementById('boardsFirst')?.addEventListener('click', function() {
    boardsPage = 1; loadTimesheetBoards();
});
document.getElementById('boardsLast')?.addEventListener('click', function() {
    // We don't know max page here; force a fetch to compute then jump via response.
    // Quick approach: temporarily set a very large page, backend will clamp/return last page when wired.
    boardsPage = 999999; loadTimesheetBoards();
});
document.getElementById('boardsPageSize')?.addEventListener('change', function() {
    boardsPage = 1; loadTimesheetBoards();
});

// Initialize when Summary tab first shown
// If user clicks Summary nav, data will load automatically
document.querySelector(".nav-item[onclick=\"showTab('summary')\"]")?.addEventListener('click', function() {
    setTimeout(loadTimesheetBoards, 0);
});

// ================= Work Data JS =================
let workPage = 1;
function getWorkPageSize() {
    const sel = document.getElementById('workPageSize');
    return sel ? parseInt(sel.value, 10) : 10;
}

function buildWorkQuery() {
    const params = new URLSearchParams();
    params.set('page', workPage);
    params.set('page_size', getWorkPageSize());
    const q = document.getElementById('workSearchInput')?.value || '';
    const department = document.getElementById('workDepartment')?.value || '';
    const method = document.getElementById('workMethod')?.value || '';
    const shift = document.getElementById('workShift')?.value || '';
    const fromDate = document.getElementById('workFromDate')?.value || '';
    const toDate = document.getElementById('workToDate')?.value || '';
    if (q) params.set('q', q);
    if (department) params.set('department', department);
    if (method) params.set('method', method);
    if (shift) params.set('shift', shift);
    if (fromDate) params.set('from_date', fromDate);
    if (toDate) params.set('to_date', toDate);
    return params.toString();
}

function loadWorkData() {
    const tbody = document.getElementById('workDataBody');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="12" style="padding:20px; text-align:center; color:#666;">Đang tải...</td></tr>';
    }
    fetch('/api/work-data?' + buildWorkQuery())
        .then(r => r.json())
        .then(data => {
            const items = data.items || [];
            const total = data.total || 0;
            const page = data.page || workPage;
            const pageSize = data.page_size || getWorkPageSize();
            document.getElementById('workTotal').textContent = total;
            document.getElementById('workPage').textContent = page;
            if (tbody) {
                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="12" style="padding:20px; text-align:center; color:#666;">Chưa có dữ liệu</td></tr>';
                } else {
                    tbody.innerHTML = '';
                    items.forEach(item => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td style=\"padding:10px; border-bottom:1px solid #f1f1f1;\">${item.employee_code || ''}</td>
                            <td style=\"padding:10px; border-bottom:1px solid #f1f1f1; font-weight:600; color:#2c3e50;\">${item.employee_name || ''}</td>
                            <td style=\"padding:10px; border-bottom:1px solid #f1f1f1;\">${item.title || ''}</td>
                            <td style=\"padding:10px; border-bottom:1px solid #f1f1f1;\">${item.phone || ''}</td>
                            <td style=\"padding:10px; border-bottom:1px solid #f1f1f1;\">${item.department || ''}</td>
                            <td style=\"padding:10px; border-bottom:1px solid #f1f1f1;\">${item.method || ''}</td>
                            <td style=\"padding:10px; border-bottom:1px solid #f1f1f1;\">${item.device_name || ''}</td>
                            <td style=\"padding:10px; border-bottom:1px solid #f1f1f1; white-space: pre-line; color:#0ea5e9;\">${item.location || ''}</td>
                            <td style=\"padding:10px; border-bottom:1px solid #f1f1f1;\">${item.timestamp || ''}</td>
                            <td style=\"padding:10px; border-bottom:1px solid #f1f1f1;\">${item.shift || ''}</td>
                            <td style=\"padding:10px; border-bottom:1px solid #f1f1f1;\">${item.image ? '📷' : ''}</td>
                            <td style=\"padding:10px; border-bottom:1px solid #f1f1f1;\"><button class=\"btn-secondary\" style=\"background:#22c55e;\">⚙</button></td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            }

            const prev = document.getElementById('workPrev');
            const next = document.getElementById('workNext');
            const first = document.getElementById('workFirst');
            const last = document.getElementById('workLast');
            const maxPage = Math.max(1, Math.ceil(total / pageSize));
            if (prev) prev.disabled = page <= 1;
            if (first) first.disabled = page <= 1;
            if (next) next.disabled = page >= maxPage;
            if (last) last.disabled = page >= maxPage;
        })
        .catch(() => {
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="12" style="padding:20px; text-align:center; color:#c00;">Lỗi tải dữ liệu</td></tr>';
            }
        });
}

// Toggle filter panel
document.getElementById('workOpenFilterBtn')?.addEventListener('click', function() {
    const panel = document.getElementById('workFilterPanel');
    if (panel) {
        panel.style.display = panel.style.display === 'none' || panel.style.display === '' ? 'block' : 'none';
    }
});

// Apply / Reset filters
document.getElementById('applyWorkFilterBtn')?.addEventListener('click', function() {
    workPage = 1; loadWorkData();
});
document.getElementById('resetWorkFilterBtn')?.addEventListener('click', function() {
    const ids = ['workFromDate','workToDate','workDepartment','workMethod','workShift','workSearchInput'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) { if (el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = ''; }
    });
    workPage = 1; loadWorkData();
});

// Search typing debounce
let workSearchTimer;
document.getElementById('workSearchInput')?.addEventListener('input', function() {
    clearTimeout(workSearchTimer);
    workSearchTimer = setTimeout(() => { workPage = 1; loadWorkData(); }, 400);
});

// Pagination
document.getElementById('workPrev')?.addEventListener('click', function() { if (workPage > 1) { workPage -= 1; loadWorkData(); } });
document.getElementById('workNext')?.addEventListener('click', function() { workPage += 1; loadWorkData(); });
document.getElementById('workFirst')?.addEventListener('click', function() { workPage = 1; loadWorkData(); });
document.getElementById('workLast')?.addEventListener('click', function() { workPage = 999999; loadWorkData(); });
document.getElementById('workPageSize')?.addEventListener('change', function() { workPage = 1; loadWorkData(); });

document.querySelector(".nav-item[onclick=\"showTab('work_data')\"]")?.addEventListener('click', function() {
    setTimeout(loadWorkData, 0);
});

// Excel Import Functionality
document.addEventListener('DOMContentLoaded', function() {
    const importBtn = document.getElementById('importExcelBtn');
    const fileInput = document.getElementById('excelFileInput');
    const monthSelect = document.getElementById('monthSelect');
    
    if (importBtn && fileInput) {
        importBtn.addEventListener('click', function() {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                importExcelFile(file);
            }
        });
    }
});

function importExcelFile(file) {
    const monthYear = document.getElementById('monthSelect').value;
    const month = monthYear.split('-')[1]; // Extract month from YYYY-MM format
    const year = monthYear.split('-')[0]; // Extract year from YYYY-MM format
    const formData = new FormData();
    formData.append('file', file);
    formData.append('month', month);
    formData.append('year', year);
    
    // Show loading state
    showMessage('Importing Excel file...', 'info');
    
    fetch('/api/import-excel', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showMessage(`Import failed: ${data.error}`, 'error');
            if (data.details) {
                console.error('Validation errors:', data.details);
            }
        } else {
            showMessage(`Successfully imported ${data.rows_imported} rows for ${getMonthName(data.month)}`, 'success');
            // Refresh the table data
            loadMonthlyDetailData();
        }
    })
    .catch(error => {
        console.error('Import error:', error);
        showMessage('Import failed: Network error', 'error');
    })
    .finally(() => {
        // Clear file input
        document.getElementById('excelFileInput').value = '';
    });
}

function showMessage(message, type) {
    // Remove existing messages
    const existingMessages = document.querySelectorAll('.message');
    existingMessages.forEach(msg => msg.remove());
    
    // Create new message
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: 600;
        z-index: 1000;
        max-width: 400px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    
    if (type === 'success') {
        messageDiv.style.backgroundColor = '#28a745';
    } else if (type === 'error') {
        messageDiv.style.backgroundColor = '#dc3545';
    } else if (type === 'info') {
        messageDiv.style.backgroundColor = '#17a2b8';
    }
    
    messageDiv.textContent = message;
    document.body.appendChild(messageDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.parentNode.removeChild(messageDiv);
        }
    }, 5000);
}

function getMonthName(monthNumber) {
    const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ];
    return months[parseInt(monthNumber) - 1] || 'Unknown';
}

function loadMonthlyDetailData() {
    // This function would load the monthly detail data
    // For now, we'll just show a placeholder
    const tbody = document.getElementById('monthlySummaryTableBody');
    if (tbody) {
        tbody.innerHTML = '<tr><td colspan="47" style="padding: 20px; text-align: center; color: #666;">Data loaded successfully. Refresh to see imported data.</td></tr>';
    }
}

// Month selection change handler
document.addEventListener('DOMContentLoaded', function() {
    const monthSelect = document.getElementById('monthSelect');
    if (monthSelect) {
        monthSelect.addEventListener('change', function() {
            // Update table headers based on selected month
            updateTableForMonth(this.value);
        });
    }
});

function getDaysInSelectedMonth() {
    const monthYear = document.getElementById('monthSelect').value;
    if (!monthYear) return 30; // Default fallback
    
    const [year, month] = monthYear.split('-');
    return new Date(parseInt(year), parseInt(month), 0).getDate();
}

function getFirstWeekdayOfMonth() {
    const monthYear = document.getElementById('monthSelect').value;
    if (!monthYear) return "Monday"; // Default fallback
    
    const [year, month] = monthYear.split('-');
    const firstDay = new Date(parseInt(year), parseInt(month) - 1, 1);
    const weekdays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    return weekdays[firstDay.getDay()];
}

function updateTableForMonth(monthYear) {
    // Update the day columns based on selected month and year
    const daysInMonth = getDaysInSelectedMonth();
    const firstWeekday = getFirstWeekdayOfMonth();
    
    // Call all three functions to regenerate the table
    if (typeof generateHeaderRows === 'function') {
        generateHeaderRows(daysInMonth);
    }
    
    if (typeof generateWeekdaysRow === 'function') {
        generateWeekdaysRow(daysInMonth, firstWeekday);
    }
    
    if (typeof generateDaysRow === 'function') {
        generateDaysRow(daysInMonth);
    }
    
    console.log(`Updating table for ${getMonthYearDisplay(monthYear)} with ${daysInMonth} days, starting on ${firstWeekday}`);
}

function getDaysInMonth(month) {
    const year = new Date().getFullYear();
    return new Date(year, month, 0).getDate();
}
</script>
</body>
</html>
