<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Attendance Detail - HRM System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    /* Sidebar Styles */
    .sidebar {
        width: 280px;
        background: white;
        box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        position: fixed;
        height: 100vh;
        left: 0;
        top: 0;
        z-index: 1000;
        overflow-y: auto;
        transition: width 0.3s ease, transform 0.3s ease;
    }

    .sidebar.collapsed {
        width: 60px;
    }

    .sidebar.collapsed .sidebar-header h2,
    .sidebar.collapsed .nav-item-text,
    .sidebar.collapsed .nav-section-title {
        opacity: 0;
        visibility: hidden;
    }

    .sidebar.collapsed .nav-item {
        justify-content: center;
        padding: 12px 0;
    }

    .sidebar.collapsed .nav-item-icon {
        margin-right: 0;
    }

    /* Main Content with Sidebar */
    .main-content-with-sidebar {
        margin-left: 280px;
        min-height: 100vh;
        transition: margin-left 0.3s ease;
    }

    .main-content-with-sidebar.sidebar-collapsed {
        margin-left: 60px;
    }

    /* Sidebar Toggle Button */
    .sidebar-toggle {
        position: fixed;
        top: 50%;
        left: 280px;
        transform: translateY(-50%);
        width: 20px;
        height: 40px;
        background: #667eea;
        border: none;
        border-radius: 0 8px 8px 0;
        color: white;
        cursor: pointer;
        z-index: 1001;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: left 0.3s ease, transform 0.3s ease;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }

    .sidebar-toggle:hover {
        background: #5a6fd8;
    }

    .sidebar-toggle.collapsed {
        left: 60px;
    }

    .sidebar-toggle i {
        transition: transform 0.3s ease;
    }

    .sidebar-toggle.collapsed i {
        transform: rotate(180deg);
    }

    .sidebar-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        background: #f8f9fa;
    }

    .sidebar-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .sidebar-nav {
        padding: 20px 0;
    }

    .nav-section {
        margin-bottom: 30px;
    }

    .nav-section-title {
        font-size: 0.8rem;
        font-weight: 600;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 0 20px 10px 20px;
        margin: 0;
    }

    .nav-item {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        color: #333;
        text-decoration: none;
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
        cursor: pointer;
    }

    .nav-item:hover {
        background-color: #f1f3f4;
        color: #1a73e8;
    }

    .nav-item.active {
        background-color: #e8f0fe;
        color: #1a73e8;
        border-left-color: #1a73e8;
        font-weight: 500;
    }

    .nav-item-icon {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .nav-item-text {
        font-size: 0.9rem;
    }

    /* Content Area */
    .content-area {
        padding: 20px;
        background: #f5f5f5;
        min-height: 100vh;
    }

    .attendance-container {
        max-width: 100%;
    }

    .attendance-card {
        background: white;
        border-radius: 8px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* Header Styles */
    .top-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-left h1 {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 600;
    }

    .header-right {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .time-display {
        text-align: right;
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
    }

    /* Navigation Bar */
    .navbar {
        background: white;
        border-bottom: 1px solid #e0e0e0;
        padding: 0 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 60px;
    }

    .navbar-left {
        display: flex;
        gap: 30px;
    }

    .navbar .nav-item {
        color: #666;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 6px;
        transition: all 0.2s ease;
        font-weight: 500;
        border-left: none;
    }

    .navbar .nav-item:hover {
        background-color: #f1f3f4;
        color: #1a73e8;
    }

    .navbar .nav-item.active {
        background-color: #e8f0fe;
        color: #1a73e8;
        border-left: none;
    }

    /* Attendance Table Styles */
    .attendance-table-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-top: 20px;
    }

    .action-buttons {
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }

    .btn-primary {
        background: #28a745;
        color: white;
    }

    .btn-info {
        background: #17a2b8;
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .table-responsive {
        overflow-x: auto;
        width: 100%;
        border: 0px solid #000;
    }

    .attendance-table {
        border-collapse: collapse;
        table-layout: fixed;
        min-width: 100vw;
    }

    .attendance-table th {
        border: 1px solid #ddd;
        padding: 4px;
        text-align: center;
    }

    .loading {
        display: none;
        text-align: center;
        padding: 20px;
        color: #666;
    }

    .error-message, .success-message {
        display: none;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
    }

    .error-message {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .success-message {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

</style>
</head>
<body>

<!-- Top Header -->
<div class="top-header">
    <div class="header-left">
        <h1><i class="fas fa-calendar-alt"></i> Monthly Attendance Detail</h1>
    </div>
    <div class="header-right">
        <div class="time-display">
            <div id="current-time"></div>
            <div id="current-date"></div>
        </div>
        <div class="user-info">
            <i class="fas fa-user-circle"></i>
            <span>{{ user.first_name }} {{ user.last_name }}</span>
        </div>
    </div>
</div>

<!-- Navigation Bar -->
<nav class="navbar">
    <div class="navbar-left">
        <a href="/dashboard" class="nav-item">Home</a>
        <a href="#" class="nav-item">Administrative Personnel</a>
        <a href="/attendance" class="nav-item active">Attendance</a>
        <a href="#" class="nav-item">Salary</a>
        <a href="#" class="nav-item">Decision</a>
    </div>
</nav>

<div class="sidebar" id="sidebar">
    <!-- Sidebar Header -->
    <div class="sidebar-header">
        <h2 class="sidebar-title">
            <i class="fas fa-clock"></i>
            Attendance Management
        </h2>
    </div>

    <!-- Sidebar Navigation -->
    <nav class="sidebar-nav">
        <div class="nav-section">
            <h3 class="nav-section-title">Attendance Management</h3>
            <a href="/attendance/monthly_attendance_detail" class="nav-item active">
                <div class="nav-item-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <span class="nav-item-text">Monthly Attendance Detail</span>
            </a>
            <a href="/attendance/attendance_summary" class="nav-item">
                <div class="nav-item-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span class="nav-item-text">Attendance Summary</span>
            </a>
            <a href="/attendance/work_data" class="nav-item">
                <div class="nav-item-icon">
                    <i class="fas fa-database"></i>
                </div>
                <span class="nav-item-text">Work Data</span>
            </a>
        </div>
    </nav>
</div>

<!-- Sidebar Toggle Button -->
<button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()">
    <i class="fas fa-chevron-left"></i>
</button>

<div class="main-content-with-sidebar">
    <div class="content-area">
        <div class="attendance-container">
            <div class="attendance-card">
                <h1 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">
                    <i class="fas fa-calendar-alt"></i> Monthly Attendance Detail
                </h1>
        
                <div class="attendance-table-container">
                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="btn btn-primary" id="exportExcelBtn">
                            <i class="fas fa-file-excel"></i>
                            Export Excel
                        </button>
                        <button class="btn btn-info" id="importExcelBtn">
                            <i class="fas fa-upload"></i>
                            Import Excel
                        </button>
                        <button class="btn btn-secondary" id="filterBtn">
                            <i class="fas fa-filter"></i>
                            Filter
                        </button>
                        <input type="month" id="monthSelect" value="2024-09" style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 5px; background: white; font-size: 14px; min-width: 150px;">
                    </div>
                    
                    <!-- Hidden file input for Excel upload -->
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;">
                    
                    <!-- Row limit notice -->
                    <div style="margin-bottom: 15px; padding: 10px; background: #e7f3ff; border: 1px solid #b3d9ff; border-radius: 5px; color: #0066cc; font-size: 14px;">
                        <i class="fas fa-info-circle"></i> <strong>Note:</strong> Maximum 25 rows allowed for data entry. Please ensure your Excel file follows the correct format.
                    </div>
                    
                    <div class="table-responsive">
                        <table class="attendance-table">
                            <thead>
                                <!-- Row 1: Main Headers -->
                                <tr id="header-rows"></tr>
                                <tr id="weekdays-row"></tr>
                                <tr id="days-row"></tr>
                                <tr>
                                    <th style="min-width: 75px; height: 50px; border: 1px solid #ddd">Số lần</th>
                                    <th style="min-width: 75px; height: 50px; border: 1px solid #ddd">Số phút</th>
                                    <th style="min-width: 75px; height: 50px; border: 1px solid #ddd">Số công</th>
                                    <th style="min-width: 75px; height: 50px; border: 1px solid #ddd">Số lần</th>
                                    <th style="min-width: 75px; height: 50px; border: 1px solid #ddd">Số phút</th>
                                    <th style="min-width: 75px; height: 50px; border: 1px solid #ddd">Số công</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
                
                <div class="loading" id="loading">
                    <i class="fas fa-spinner fa-spin"></i> Processing...
                </div>
                
                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript functions for generating table headers
function generateHeaderRows(n) {
  const tr = document.getElementById("header-rows");
  tr.innerHTML = "";
  tr.style.background = "#f8f9fa";

  const mk = (html, attrs={}) => {
    const th = document.createElement("th");
    Object.assign(th, attrs);
    return Object.assign(th, { innerHTML: html });
  };

  tr.appendChild(mk("STT", { rowSpan: 4, style: "min-width:75px; height:200px; border: 1px; padding: 4px; text-align:center; position:sticky; left:0; background-color: #fef2cc" }));
  tr.appendChild(mk("Nhân viên", { rowSpan: 4, style: "min-width:100px; height:200px; border: 1px; padding: 4px; text-align:center; position:sticky; left:75px; background-color: #fef2cc" }));

  tr.appendChild(mk("Công chi tiết tháng", { colSpan: n, style: `width:${n*80}px; height:50px; border:1px; padding: 4px; background-color: #fef2cc` }));

  tr.appendChild(mk("Công<br>định mức", { rowSpan: 4, style: "min-width:100px; height:200px; border:1px; padding: 4px; background-color: #fef2cc" }));
  tr.appendChild(mk("Công<br>hành chính", { rowSpan: 4, style: "min-width:100px; height:200px; border:1px; padding: 4px; text-align:center; background-color: #fef2cc" }));
  tr.appendChild(mk("Công<br>đi đường", { rowSpan: 4, style: "min-width:100px; height:200px; border:1px; padding: 4px; background-color: #fef2cc" }));

  tr.appendChild(mk("Công vượt định mức", { colSpan: 4, style: "height:50px; border:1px; padding: 4px; background-color: #fef2cc" }));
  tr.appendChild(mk("Tổng công<br>đi làm", { rowSpan: 4, style: "min-width:100px; height:200px; border:1px; padding: 4px; background-color: #fef2cc" }));
  tr.appendChild(mk("Công nghỉ hưởng lương", { colSpan: 4, style: "height:50px; border:1px; padding: 4px; background-color: #fef2cc" }));
  tr.appendChild(mk("Các khoản công bị giảm trừ", { colSpan: 7, style: "height:50px; border:1px; padding: 4px; background-color: #fef2cc" }));
  tr.appendChild(mk("Bù trừ công<br>hành chính sau<br>quyết toán<br>công tác", { rowSpan: 4, style: "min-width:125px; height:200px; border: 1px; padding: 4px; background-color: #fef2cc" }));
  tr.appendChild(mk("Công<br>ca đêm", { rowSpan: 4, style: "min-width:100px; height:200px; border:1px; padding: 4px; background-color: #fef2cc" }));
  tr.appendChild(mk("Tổng công<br>tính lương", { rowSpan: 4, style: "min-width:100px; height:200px; border:1px; padding: 4px; background-color: #fef2cc" }));
  tr.appendChild(mk("Các ngày nghỉ không hưởng lương", { colSpan: 4, style: "height:50px; border:1px; padding: 4px; background-color: #fef2cc" }));
  tr.appendChild(mk("Tổng ngày<br>nghỉ không<br>hưởng lương", { rowSpan: 4, style: "min-width:125px; height:200px; border:1px; padding: 4px; background-color: #fef2cc" }));
}

function generateWeekdaysRow(n, firstWeekDay) {
  const row = document.getElementById("weekdays-row");
  row.innerHTML = "";

  const full2idx = { Monday:0, Tuesday:1, Wednesday:2, Thursday:3, Friday:4, Saturday:5, Sunday:6 };
  const abbr = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

  const start = full2idx[firstWeekDay];
  if (start === undefined) throw new Error("firstWeekDay must be one of: Monday..Sunday");

  // weekday columns 1..n
  for (let i = 0; i < n; i++) {
    const th = document.createElement("th");
    th.rowSpan = 1;
    th.style = "min-width: 50px; height: 50px; border: 1px solid #ddd;";
    th.textContent = abbr[(start + i) % 7];
    row.appendChild(th);
  }

  // VĐM (rowspan=3)
  const vdm = [
    { html: "VĐM1<br>(x1.5)", w: 75 },
    { html: "VĐM2<br>(x2)",   w: 75 },
    { html: "VĐM3<br>(x3)",   w: 75 },
    { html: "Tổng công VĐM quy đổi hệ số", w: 150 }
  ];
  vdm.forEach(item => {
    const th = document.createElement("th");
    th.rowSpan = 3;
    th.style = `min-width: ${item.w}px; height: 150px; border: 1px solid #ddd;`;
    if (item.html.includes("<br")) th.innerHTML = item.html; else th.textContent = item.html;
    row.appendChild(th);
  });

  // NHL (no rowspan)
  [
    { text: "NHL1", w: 75 },
    { text: "NHL2", w: 75 },
    { text: "NHL3", w: 125 }
  ].forEach(item => {
    const th = document.createElement("th");
    th.style = `min-width: ${item.w}px; height: 50px; border: 1px solid #ddd;`;
    th.textContent = item.text;
    row.appendChild(th);
  });

  // Tổng công NHL (rowspan=3)
  {
    const th = document.createElement("th");
    th.rowSpan = 3;
    th.style = "min-width: 100px; height: 150px; border: 1px solid #ddd;";
    th.innerHTML = "Tổng<br>công NHL";
    row.appendChild(th);
  }

  // GT1, GT2 groups (colspan=3)
  ["GT1","GT2"].forEach(label => {
    const th = document.createElement("th");
    th.colSpan = 3;
    th.style = "width: 300px; height: 50px; border: 1px solid #ddd;";
    th.textContent = label;
    row.appendChild(th);
  });

  // Tổng công bị giảm trừ (rowspan=3)
  {
    const th = document.createElement("th");
    th.rowSpan = 3;
    th.style = "min-width: 125px; height: 150px; border: 1px solid #ddd;";
    th.innerHTML = "Tổng công<br>bị giảm trừ";
    row.appendChild(th);
  }

  // NK1..NK4 (no rowspan)
  ["NK1","NK2","NK3","NK4"].forEach(label => {
    const th = document.createElement("th");
    th.style = "width: 100px; height: 50px; border: 1px solid #ddd;";
    th.textContent = label;
    row.appendChild(th);
  });
}

function generateDaysRow(n) {
  const row = document.getElementById("days-row");
  row.innerHTML = "";

  // create day columns 1..n
  for (let i = 1; i <= n; i++) {
    const th = document.createElement("th");
    th.rowSpan = 2;
    th.style = "min-width: 50px; height: 100px; border: 1px solid #ddd;";
    th.textContent = i;
    row.appendChild(th);
  }

  // append fixed columns
  const fixed = [
    { text: "Phép", width: 75 },
    { text: "Lễ, Tết", width: 75 },
    { text: "Chế độ hưởng nguyên lương", width: 125 }
  ];
  fixed.forEach(item => {
    const th = document.createElement("th");
    th.rowSpan = 2;
    th.style = `min-width: ${item.width}px; height: 100px; border: 1px solid #ddd;`;
    th.textContent = item.text;
    row.appendChild(th);
  });

  // group headers (colspan=3)
  const groups = [
    { text: "Đi muộn" },
    { text: "Về sớm" }
  ];
  groups.forEach(item => {
    const th = document.createElement("th");
    th.colSpan = 3;
    th.style = "width: 300px; height: 50px; border: 1px solid #ddd;";
    th.textContent = item.text;
    row.appendChild(th);
  });

  // nghỉ … headers (rowspan=2, with <br> inside)
  const nghis = [
    "Nghỉ<br>không<br>lý do",
    "Nghỉ<br>không<br>lương",
    "Nghỉ<br>hưởng<br>BHXH",
    "Nghỉ<br>thai<br>sản"
  ];
  nghis.forEach(text => {
    const th = document.createElement("th");
    th.rowSpan = 2;
    th.style = "min-width: 75px; height: 100px; border: 1px solid #ddd;";
    th.innerHTML = text;
    row.appendChild(th);
  });
}

// Update time display
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US');
    const dateString = now.toLocaleDateString('en-US');
    
    document.getElementById('current-time').textContent = timeString;
    document.getElementById('current-date').textContent = dateString;
}

// Initialize and update time every second
updateTime();
setInterval(updateTime, 1000);

// Month selector change event
document.getElementById('monthSelect').addEventListener('change', function() {
    const selectedMonth = this.value;
    updateTableForMonth(selectedMonth);
});

// Excel import functionality
document.getElementById('importExcelBtn').addEventListener('click', function() {
    document.getElementById('excelFileInput').click();
});

document.getElementById('excelFileInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
        importExcelFile(file);
    }
});

function importExcelFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    const monthYear = document.getElementById('monthSelect').value;
    formData.append('month_year', monthYear);
    
    showLoading(true);
    hideMessages();
    
    fetch('/attendance/api/import-excel', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        showLoading(false);
        if (data.success) {
            showMessage(`Import successful: ${data.message}`, 'success');
        } else {
            showMessage(`Import failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showLoading(false);
        showMessage('Import failed: Network error', 'error');
        console.error('Error:', error);
    });
}

function showMessage(message, type) {
    const messageDiv = document.getElementById(type === 'success' ? 'successMessage' : 'errorMessage');
    messageDiv.textContent = message;
    messageDiv.style.display = 'block';
    setTimeout(() => {
        messageDiv.style.display = 'none';
    }, 5000);
}

function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function hideMessages() {
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('successMessage').style.display = 'none';
}

function getDaysInSelectedMonth() {
    const monthValue = document.getElementById('monthSelect').value;
    if (!monthValue) return 30;
    
    const [year, month] = monthValue.split('-');
    return new Date(parseInt(year), parseInt(month), 0).getDate();
}

function getFirstWeekdayOfMonth() {
    const monthValue = document.getElementById('monthSelect').value;
    if (!monthValue) return 'Monday';
    
    const [year, month] = monthValue.split('-');
    const firstDay = new Date(parseInt(year), parseInt(month) - 1, 1);
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    return dayNames[firstDay.getDay()];
}

function updateTableForMonth(monthYear) {
    const daysInMonth = getDaysInSelectedMonth();
    const firstWeekday = getFirstWeekdayOfMonth();
    
    generateHeaderRows(daysInMonth);
    generateWeekdaysRow(daysInMonth, firstWeekday);
    generateDaysRow(daysInMonth);
    
    console.log(`Updating table for ${monthYear} with ${daysInMonth} days, starting on ${firstWeekday}`);
}

// Sidebar toggle functionality
function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.querySelector('.main-content-with-sidebar');
    const toggleButton = document.getElementById('sidebarToggle');
    
    sidebar.classList.toggle('collapsed');
    mainContent.classList.toggle('sidebar-collapsed');
    toggleButton.classList.toggle('collapsed');
}

// Initialize table with current month
document.addEventListener('DOMContentLoaded', function() {
    updateTableForMonth(document.getElementById('monthSelect').value);
});
</script>

</body>
</html>
